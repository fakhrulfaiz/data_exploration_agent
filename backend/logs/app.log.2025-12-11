2025-12-11 01:08:47,986 - server - INFO - Logging configuration complete
2025-12-11 01:08:47,991 - server - INFO - Starting up Agent Backend API...
2025-12-11 01:08:51,953 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:08:51,970 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:08:51,970 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:08:56,878 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:08:56,916 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:08:56,981 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:09:02,779 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:09:02,908 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:09:03,023 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 01:09:06,703 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 01:09:06,755 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 01:09:06,772 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 01:09:07,267 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 01:09:07,267 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 01:09:07,267 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 01:09:33,055 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 01:09:42,587 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 210967ac-5766-459f-98d8-a82035ca14b9
2025-12-11 01:09:45,914 - app.api.v1.endpoints.graph - INFO - Fetching explorer data for thread_id: 210967ac-5766-459f-98d8-a82035ca14b9, checkpoint_id: 1f0d5a73-1fc6-6219-8006-0df02101cc00
2025-12-11 01:09:45,914 - app.services.agent_service - INFO - Getting explorer data for thread_id: 210967ac-5766-459f-98d8-a82035ca14b9, checkpoint_id: 1f0d5a73-1fc6-6219-8006-0df02101cc00
2025-12-11 01:09:45,916 - app.services.agent_service - INFO - Successfully built explorer data with 1 steps
2025-12-11 01:37:42,019 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 01:38:12,729 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 01:38:13,608 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 11:32:41,119 - server - INFO - Logging configuration complete
2025-12-11 11:32:41,119 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:32:45,086 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:45,086 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:45,101 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:49,975 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:50,025 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:50,098 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:55,856 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:55,938 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:32:56,200 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:03,688 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:03,823 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:04,448 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:11,156 - app.core.database - ERROR - ❌ Failed to initialize database: couldn't get a connection after 30.00 sec
2025-12-11 11:33:27,331 - server - INFO - Logging configuration complete
2025-12-11 11:33:27,331 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:33:31,296 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:31,296 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:31,297 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:36,252 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:36,264 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:36,295 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:42,254 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:42,254 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:42,393 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:50,249 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:50,299 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:50,633 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:33:57,344 - app.core.database - ERROR - ❌ Failed to initialize database: couldn't get a connection after 30.00 sec
2025-12-11 11:36:15,540 - server - INFO - Logging configuration complete
2025-12-11 11:36:15,540 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:36:19,511 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:19,511 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:19,511 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:24,454 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:24,470 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:24,516 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:30,413 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:30,444 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:30,560 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:38,388 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:38,463 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:38,704 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:36:45,556 - app.core.database - ERROR - ❌ Failed to initialize database: couldn't get a connection after 30.00 sec
2025-12-11 11:43:57,716 - server - INFO - Logging configuration complete
2025-12-11 11:43:57,717 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:44:01,679 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:44:01,679 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:44:01,679 - psycopg.pool - WARNING - error connecting in 'pool-1': [Errno -2] Name or service not known
2025-12-11 11:44:02,652 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:44:02,689 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:44:02,700 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 11:44:04,050 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 11:44:04,050 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 11:44:04,051 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 11:44:04,051 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 11:44:34,803 - app.api.v1.endpoints.graph - INFO - Generating graph visualization image
2025-12-11 11:44:34,849 - app.api.v1.endpoints.graph - INFO - Graph visualization generated successfully, size: 11937 bytes
2025-12-11 11:44:49,162 - app.api.v1.endpoints.graph - INFO - Generating graph visualization image
2025-12-11 11:44:49,210 - app.api.v1.endpoints.graph - INFO - Graph visualization generated successfully, size: 11937 bytes
2025-12-11 11:49:29,499 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 11:49:37,261 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:49:37,262 - app.services.chat_thread_service - INFO - Creating new chat thread: 8ea7982a-1079-4edd-81da-0169f6423b7e with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:49:37,269 - app.services.chat_thread_service - INFO - Created new chat thread: 8ea7982a-1079-4edd-81da-0169f6423b7e
2025-12-11 11:49:37,272 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 11:49:37,272 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 8ea7982a-1079-4edd-81da-0169f6423b7e
2025-12-11 11:49:37,350 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 8ea7982a-1079-4edd-81da-0169f6423b7e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:49:37,351 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 11:49:37,368 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 8ea7982a-1079-4edd-81da-0169f6423b7e
2025-12-11 11:49:37,369 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 11:49:37,369 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 8ea7982a-1079-4edd-81da-0169f6423b7e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:49:37,369 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 11:49:37,369 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '0f149550-b17a-4868-a679-e54b8a7fe0e4', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 11:49:37,370 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 11:49:37,370 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 8ea7982a-1079-4edd-81da-0169f6423b7e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 11:49:37,372 - app.services.message_management_service - INFO - Generated message_id: 8316ca52-34a8-45aa-998c-9cb5329144f6 for thread 8ea7982a-1079-4edd-81da-0169f6423b7e
2025-12-11 11:49:37,373 - app.services.message_management_service - INFO - Saving user message 8316ca52-34a8-45aa-998c-9cb5329144f6 to thread 8ea7982a-1079-4edd-81da-0169f6423b7e with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:49:37,379 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 8316ca52-34a8-45aa-998c-9cb5329144f6
2025-12-11 11:49:37,380 - app.services.message_management_service - INFO - Successfully saved user message 8316ca52-34a8-45aa-998c-9cb5329144f6 to thread 8ea7982a-1079-4edd-81da-0169f6423b7e
2025-12-11 11:49:37,380 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 8ea7982a-1079-4edd-81da-0169f6423b7e, message_id: 8316ca52-34a8-45aa-998c-9cb5329144f6
2025-12-11 11:49:37,380 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 8ea7982a-1079-4edd-81da-0169f6423b7e, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:49:39,283 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:49:41,996 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:49:43,284 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:49:43,657 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_R9L6TII9lO10ZqrPa6GcaOcI')]}
2025-12-11 11:49:45,613 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:49:47,061 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 8ea7982a-1079-4edd-81da-0169f6423b7e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 0f149550-b17a-4868-a679-e54b8a7fe0e4, checkpoint_id: 1f0d6877-df36-6e9b-8006-32c45b9ea634, content_blocks count: 3
2025-12-11 11:49:47,062 - app.services.message_management_service - INFO - Saving assistant message 0f149550-b17a-4868-a679-e54b8a7fe0e4 to thread 8ea7982a-1079-4edd-81da-0169f6423b7e with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:49:47,065 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 0f149550-b17a-4868-a679-e54b8a7fe0e4
2025-12-11 11:49:47,066 - app.services.message_management_service - INFO - Successfully saved assistant message 0f149550-b17a-4868-a679-e54b8a7fe0e4 to thread 8ea7982a-1079-4edd-81da-0169f6423b7e
2025-12-11 11:49:47,067 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 18 (UUID: 0f149550-b17a-4868-a679-e54b8a7fe0e4) in thread 8ea7982a-1079-4edd-81da-0169f6423b7e
2025-12-11 11:53:24,285 - server - INFO - Shutting down Agent Backend API...
2025-12-11 11:53:24,285 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 11:53:24,286 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 11:53:24,292 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 11:53:24,292 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 11:53:28,063 - server - INFO - Logging configuration complete
2025-12-11 11:53:28,063 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:53:28,095 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:53:28,122 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:53:28,133 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 11:53:28,633 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 11:53:28,634 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 11:53:28,634 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 11:53:28,634 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 11:53:34,750 - app.services.chat_thread_service - INFO - Deleting thread 210967ac-5766-459f-98d8-a82035ca14b9 (delete_checkpoint=True)
2025-12-11 11:53:34,764 - app.services.chat_thread_service - INFO - Deleted chat thread: 210967ac-5766-459f-98d8-a82035ca14b9 (messages and content blocks deleted via cascade)
2025-12-11 11:53:34,764 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 11:53:38,644 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:53:38,644 - app.services.chat_thread_service - INFO - Creating new chat thread: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:53:38,648 - app.services.chat_thread_service - INFO - Created new chat thread: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3
2025-12-11 11:53:38,669 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 11:53:38,669 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3
2025-12-11 11:53:38,760 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:53:38,760 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 11:53:38,785 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3
2025-12-11 11:53:38,785 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 11:53:38,785 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:53:38,786 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 11:53:38,786 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': 'fa6b636c-df5c-4726-8c71-086bfd78be65', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 11:53:38,786 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 11:53:38,786 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 11:53:38,789 - app.services.message_management_service - INFO - Generated message_id: 1dd6d7c1-fbc4-4859-9e7e-cded46736fcf for thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3
2025-12-11 11:53:38,789 - app.services.message_management_service - INFO - Saving user message 1dd6d7c1-fbc4-4859-9e7e-cded46736fcf to thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:53:38,794 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 1dd6d7c1-fbc4-4859-9e7e-cded46736fcf
2025-12-11 11:53:38,795 - app.services.message_management_service - INFO - Successfully saved user message 1dd6d7c1-fbc4-4859-9e7e-cded46736fcf to thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3
2025-12-11 11:53:38,795 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3, message_id: 1dd6d7c1-fbc4-4859-9e7e-cded46736fcf
2025-12-11 11:53:38,796 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:53:40,220 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:53:41,872 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:53:43,095 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:53:43,434 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_YcFD5fhvTcnznCscfZSrUP8E')]}
2025-12-11 11:53:45,583 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:53:47,008 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: fa6b636c-df5c-4726-8c71-086bfd78be65, checkpoint_id: 1f0d6880-cf86-6035-8006-84a9e3a4cc22, content_blocks count: 3
2025-12-11 11:53:47,009 - app.services.message_management_service - INFO - Saving assistant message fa6b636c-df5c-4726-8c71-086bfd78be65 to thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:53:47,013 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message fa6b636c-df5c-4726-8c71-086bfd78be65
2025-12-11 11:53:47,014 - app.services.message_management_service - INFO - Successfully saved assistant message fa6b636c-df5c-4726-8c71-086bfd78be65 to thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3
2025-12-11 11:53:47,014 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 20 (UUID: fa6b636c-df5c-4726-8c71-086bfd78be65) in thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3
2025-12-11 11:54:34,115 - server - INFO - Shutting down Agent Backend API...
2025-12-11 11:54:34,116 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 11:54:34,116 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 11:54:34,120 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 11:54:34,120 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 11:54:38,438 - server - INFO - Logging configuration complete
2025-12-11 11:54:38,439 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:54:38,468 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:54:38,492 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:54:38,501 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 11:54:38,957 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 11:54:38,957 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 11:54:38,958 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 11:54:38,958 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 11:55:12,533 - server - INFO - Shutting down Agent Backend API...
2025-12-11 11:55:12,533 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 11:55:12,534 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 11:55:12,537 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 11:55:12,538 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 11:55:15,335 - server - INFO - Logging configuration complete
2025-12-11 11:55:15,335 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:55:15,357 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:55:15,382 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:55:15,391 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 11:55:15,752 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 11:55:15,753 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 11:55:15,753 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 11:55:15,753 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 11:55:18,896 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 11:55:21,808 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:55:21,808 - app.services.chat_thread_service - INFO - Creating new chat thread: a253c935-4be8-4b1d-98fd-b5f0c4be8385 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:55:21,812 - app.services.chat_thread_service - INFO - Created new chat thread: a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 11:55:21,815 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 11:55:21,816 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 11:55:21,898 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: a253c935-4be8-4b1d-98fd-b5f0c4be8385, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:55:21,898 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 11:55:21,922 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 11:55:21,923 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 11:55:21,923 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: a253c935-4be8-4b1d-98fd-b5f0c4be8385, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:55:21,923 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 11:55:21,923 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': 'a2b94f5b-7275-4c30-9833-5471d0815b89', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 11:55:21,924 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 11:55:21,924 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: a253c935-4be8-4b1d-98fd-b5f0c4be8385, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 11:55:21,926 - app.services.message_management_service - INFO - Generated message_id: 47e1d834-8bf8-469f-b96f-59db9e5f54f0 for thread a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 11:55:21,926 - app.services.message_management_service - INFO - Saving user message 47e1d834-8bf8-469f-b96f-59db9e5f54f0 to thread a253c935-4be8-4b1d-98fd-b5f0c4be8385 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:55:21,930 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 47e1d834-8bf8-469f-b96f-59db9e5f54f0
2025-12-11 11:55:21,931 - app.services.message_management_service - INFO - Successfully saved user message 47e1d834-8bf8-469f-b96f-59db9e5f54f0 to thread a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 11:55:21,931 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread a253c935-4be8-4b1d-98fd-b5f0c4be8385, message_id: 47e1d834-8bf8-469f-b96f-59db9e5f54f0
2025-12-11 11:55:21,932 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: a253c935-4be8-4b1d-98fd-b5f0c4be8385, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:55:23,517 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:55:24,597 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:55:25,154 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:55:25,611 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_mxr80l08lUIPY8MmvLEzIXtm')]}
2025-12-11 11:55:26,349 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:55:28,038 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: a253c935-4be8-4b1d-98fd-b5f0c4be8385, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: a2b94f5b-7275-4c30-9833-5471d0815b89, checkpoint_id: 1f0d6884-930b-6171-8006-8ab44e79df2f, content_blocks count: 3
2025-12-11 11:55:28,038 - app.services.message_management_service - INFO - Saving assistant message a2b94f5b-7275-4c30-9833-5471d0815b89 to thread a253c935-4be8-4b1d-98fd-b5f0c4be8385 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:55:28,042 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message a2b94f5b-7275-4c30-9833-5471d0815b89
2025-12-11 11:55:28,043 - app.services.message_management_service - INFO - Successfully saved assistant message a2b94f5b-7275-4c30-9833-5471d0815b89 to thread a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 11:55:28,044 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 22 (UUID: a2b94f5b-7275-4c30-9833-5471d0815b89) in thread a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 11:55:39,817 - server - INFO - Shutting down Agent Backend API...
2025-12-11 11:55:39,818 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 11:55:39,819 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 11:55:39,822 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 11:55:39,822 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 11:55:42,561 - server - INFO - Logging configuration complete
2025-12-11 11:55:42,561 - server - INFO - Starting up Agent Backend API...
2025-12-11 11:55:42,581 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:55:42,607 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 11:55:42,617 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 11:55:43,012 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 11:55:43,013 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 11:55:43,013 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 11:55:43,013 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 11:57:56,895 - app.services.chat_thread_service - INFO - Deleting thread f18dd864-5cbb-45e5-a29b-f818b2d1f0c3 (delete_checkpoint=True)
2025-12-11 11:57:56,910 - app.services.chat_thread_service - INFO - Deleted chat thread: f18dd864-5cbb-45e5-a29b-f818b2d1f0c3 (messages and content blocks deleted via cascade)
2025-12-11 11:57:56,910 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 11:57:58,927 - app.services.chat_thread_service - INFO - Deleting thread 8ea7982a-1079-4edd-81da-0169f6423b7e (delete_checkpoint=True)
2025-12-11 11:57:58,929 - app.services.chat_thread_service - INFO - Deleted chat thread: 8ea7982a-1079-4edd-81da-0169f6423b7e (messages and content blocks deleted via cascade)
2025-12-11 11:57:58,929 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 11:58:06,859 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:58:06,860 - app.services.chat_thread_service - INFO - Creating new chat thread: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:58:06,864 - app.services.chat_thread_service - INFO - Created new chat thread: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 11:58:06,888 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 11:58:06,889 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 11:58:06,929 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:58:06,930 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 11:58:06,951 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 11:58:06,951 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 11:58:06,951 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:58:06,952 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 11:58:06,952 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'a04de075-5225-417d-9740-50398ca2af5f', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 11:58:06,952 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 11:58:06,952 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 11:58:06,955 - app.services.message_management_service - INFO - Generated message_id: 169e705f-def5-45b6-a40d-2b4c6cbdc87c for thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 11:58:06,956 - app.services.message_management_service - INFO - Saving user message 169e705f-def5-45b6-a40d-2b4c6cbdc87c to thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:58:06,960 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 169e705f-def5-45b6-a40d-2b4c6cbdc87c
2025-12-11 11:58:06,962 - app.services.message_management_service - INFO - Successfully saved user message 169e705f-def5-45b6-a40d-2b4c6cbdc87c to thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 11:58:06,962 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd, message_id: 169e705f-def5-45b6-a40d-2b4c6cbdc87c
2025-12-11 11:58:06,963 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:58:08,101 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:58:08,989 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 11:58:10,152 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: a04de075-5225-417d-9740-50398ca2af5f, checkpoint_id: 1f0d688a-9d14-6dfe-8003-d15b1ccf4027, content_blocks count: 1
2025-12-11 11:58:10,153 - app.services.message_management_service - INFO - Saving assistant message a04de075-5225-417d-9740-50398ca2af5f to thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 11:58:10,156 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a04de075-5225-417d-9740-50398ca2af5f
2025-12-11 11:58:10,157 - app.services.message_management_service - INFO - Successfully saved assistant message a04de075-5225-417d-9740-50398ca2af5f to thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 11:58:10,157 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 24 (UUID: a04de075-5225-417d-9740-50398ca2af5f) for approval in thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 12:04:14,522 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:04:17,328 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:04:18,021 - app.api.v1.endpoints.conversation - INFO - Restoring conversation a253c935-4be8-4b1d-98fd-b5f0c4be8385
2025-12-11 12:04:21,189 - app.services.chat_thread_service - INFO - Deleting thread a253c935-4be8-4b1d-98fd-b5f0c4be8385 (delete_checkpoint=True)
2025-12-11 12:04:21,191 - app.services.chat_thread_service - INFO - Deleted chat thread: a253c935-4be8-4b1d-98fd-b5f0c4be8385 (messages and content blocks deleted via cascade)
2025-12-11 12:04:21,191 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:04:21,891 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd
2025-12-11 12:04:24,418 - app.services.chat_thread_service - INFO - Deleting thread 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd (delete_checkpoint=True)
2025-12-11 12:04:24,420 - app.services.chat_thread_service - INFO - Deleted chat thread: 74c60d0e-3aa6-42d8-9415-a8c40b6b73cd (messages and content blocks deleted via cascade)
2025-12-11 12:04:24,420 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:04:28,451 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:28,451 - app.services.chat_thread_service - INFO - Creating new chat thread: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:28,453 - app.services.chat_thread_service - INFO - Created new chat thread: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784
2025-12-11 12:04:28,454 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:04:28,455 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784
2025-12-11 12:04:28,523 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:28,523 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 12:04:28,527 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784
2025-12-11 12:04:28,527 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:04:28,528 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:28,528 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:04:28,528 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '24c2de31-c22b-44be-99d4-e16743607633', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:04:28,529 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:04:28,529 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:04:28,531 - app.services.message_management_service - INFO - Generated message_id: e774f522-3699-4e55-93da-55a236da19bd for thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784
2025-12-11 12:04:28,532 - app.services.message_management_service - INFO - Saving user message e774f522-3699-4e55-93da-55a236da19bd to thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:28,534 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message e774f522-3699-4e55-93da-55a236da19bd
2025-12-11 12:04:28,535 - app.services.message_management_service - INFO - Successfully saved user message e774f522-3699-4e55-93da-55a236da19bd to thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784
2025-12-11 12:04:28,536 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784, message_id: e774f522-3699-4e55-93da-55a236da19bd
2025-12-11 12:04:28,536 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:29,464 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:04:30,672 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:04:31,253 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:04:31,516 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_yKsu2R7kfTJn9dzh9TnWsJto')]}
2025-12-11 12:04:32,370 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:04:34,044 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 24c2de31-c22b-44be-99d4-e16743607633, checkpoint_id: 1f0d6898-ea28-635d-8006-b89b5cb5e4d1, content_blocks count: 3
2025-12-11 12:04:34,045 - app.services.message_management_service - INFO - Saving assistant message 24c2de31-c22b-44be-99d4-e16743607633 to thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:34,049 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 24c2de31-c22b-44be-99d4-e16743607633
2025-12-11 12:04:34,051 - app.services.message_management_service - INFO - Successfully saved assistant message 24c2de31-c22b-44be-99d4-e16743607633 to thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784
2025-12-11 12:04:34,051 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 26 (UUID: 24c2de31-c22b-44be-99d4-e16743607633) in thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784
2025-12-11 12:04:35,741 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:04:38,180 - app.services.chat_thread_service - INFO - Deleting thread 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784 (delete_checkpoint=True)
2025-12-11 12:04:38,182 - app.services.chat_thread_service - INFO - Deleted chat thread: 6ddaa6a8-7be1-4a0d-a75f-ca89edd99784 (messages and content blocks deleted via cascade)
2025-12-11 12:04:38,182 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:04:47,231 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:47,231 - app.services.chat_thread_service - INFO - Creating new chat thread: 97dacf70-f08e-4afd-8356-0cc69c20b5db with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:47,233 - app.services.chat_thread_service - INFO - Created new chat thread: 97dacf70-f08e-4afd-8356-0cc69c20b5db
2025-12-11 12:04:47,235 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:04:47,236 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 97dacf70-f08e-4afd-8356-0cc69c20b5db
2025-12-11 12:04:47,310 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 97dacf70-f08e-4afd-8356-0cc69c20b5db, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:47,311 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 12:04:47,316 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 97dacf70-f08e-4afd-8356-0cc69c20b5db
2025-12-11 12:04:47,316 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:04:47,317 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 97dacf70-f08e-4afd-8356-0cc69c20b5db, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:47,317 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:04:47,317 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'f9503469-48d2-442f-b619-e69246dfd2df', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:04:47,318 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:04:47,318 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 97dacf70-f08e-4afd-8356-0cc69c20b5db, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:04:47,321 - app.services.message_management_service - INFO - Generated message_id: ebef125d-3ae7-427c-a445-fbf9c9aa5222 for thread 97dacf70-f08e-4afd-8356-0cc69c20b5db
2025-12-11 12:04:47,321 - app.services.message_management_service - INFO - Saving user message ebef125d-3ae7-427c-a445-fbf9c9aa5222 to thread 97dacf70-f08e-4afd-8356-0cc69c20b5db with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:47,323 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message ebef125d-3ae7-427c-a445-fbf9c9aa5222
2025-12-11 12:04:47,324 - app.services.message_management_service - INFO - Successfully saved user message ebef125d-3ae7-427c-a445-fbf9c9aa5222 to thread 97dacf70-f08e-4afd-8356-0cc69c20b5db
2025-12-11 12:04:47,324 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 97dacf70-f08e-4afd-8356-0cc69c20b5db, message_id: ebef125d-3ae7-427c-a445-fbf9c9aa5222
2025-12-11 12:04:47,325 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 97dacf70-f08e-4afd-8356-0cc69c20b5db, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:49,134 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:04:51,034 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:04:52,087 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 97dacf70-f08e-4afd-8356-0cc69c20b5db, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: f9503469-48d2-442f-b619-e69246dfd2df, checkpoint_id: 1f0d6899-963f-620f-8003-423b087a6427, content_blocks count: 1
2025-12-11 12:04:52,088 - app.services.message_management_service - INFO - Saving assistant message f9503469-48d2-442f-b619-e69246dfd2df to thread 97dacf70-f08e-4afd-8356-0cc69c20b5db with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:04:52,090 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message f9503469-48d2-442f-b619-e69246dfd2df
2025-12-11 12:04:52,091 - app.services.message_management_service - INFO - Successfully saved assistant message f9503469-48d2-442f-b619-e69246dfd2df to thread 97dacf70-f08e-4afd-8356-0cc69c20b5db
2025-12-11 12:04:52,091 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 28 (UUID: f9503469-48d2-442f-b619-e69246dfd2df) for approval in thread 97dacf70-f08e-4afd-8356-0cc69c20b5db
2025-12-11 12:05:29,224 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:05:59,639 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:05:59,640 - app.services.chat_thread_service - INFO - Creating new chat thread: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:05:59,642 - app.services.chat_thread_service - INFO - Created new chat thread: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3
2025-12-11 12:05:59,643 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:05:59,643 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3
2025-12-11 12:05:59,711 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:05:59,712 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 12:05:59,717 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3
2025-12-11 12:05:59,718 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:05:59,718 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:05:59,718 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:05:59,718 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '806b8983-fb28-4b2a-9b0f-278a64388ff1', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:05:59,719 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:05:59,719 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:05:59,722 - app.services.message_management_service - INFO - Generated message_id: e09428bd-a581-4dec-beaa-b32841e34a74 for thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3
2025-12-11 12:05:59,722 - app.services.message_management_service - INFO - Saving user message e09428bd-a581-4dec-beaa-b32841e34a74 to thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:05:59,724 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message e09428bd-a581-4dec-beaa-b32841e34a74
2025-12-11 12:05:59,726 - app.services.message_management_service - INFO - Successfully saved user message e09428bd-a581-4dec-beaa-b32841e34a74 to thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3
2025-12-11 12:05:59,726 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3, message_id: e09428bd-a581-4dec-beaa-b32841e34a74
2025-12-11 12:05:59,726 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:00,661 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:04,841 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:05,405 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:05,852 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_WAIkK2tXChA7ZZcuYTm5R7fY')]}
2025-12-11 12:06:06,714 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:08,918 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 806b8983-fb28-4b2a-9b0f-278a64388ff1, checkpoint_id: 1f0d689c-72f3-6db4-8006-34e7eb1d82df, content_blocks count: 3
2025-12-11 12:06:08,919 - app.services.message_management_service - INFO - Saving assistant message 806b8983-fb28-4b2a-9b0f-278a64388ff1 to thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:08,923 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 806b8983-fb28-4b2a-9b0f-278a64388ff1
2025-12-11 12:06:08,924 - app.services.message_management_service - INFO - Successfully saved assistant message 806b8983-fb28-4b2a-9b0f-278a64388ff1 to thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3
2025-12-11 12:06:08,924 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 30 (UUID: 806b8983-fb28-4b2a-9b0f-278a64388ff1) in thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3
2025-12-11 12:06:10,742 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:06:14,116 - app.services.chat_thread_service - INFO - Deleting thread 97dacf70-f08e-4afd-8356-0cc69c20b5db (delete_checkpoint=True)
2025-12-11 12:06:14,118 - app.services.chat_thread_service - INFO - Deleted chat thread: 97dacf70-f08e-4afd-8356-0cc69c20b5db (messages and content blocks deleted via cascade)
2025-12-11 12:06:14,118 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:06:16,173 - app.services.chat_thread_service - INFO - Deleting thread 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3 (delete_checkpoint=True)
2025-12-11 12:06:16,174 - app.services.chat_thread_service - INFO - Deleted chat thread: 0a0f6e93-f7b4-4323-a2be-c1208e81b8d3 (messages and content blocks deleted via cascade)
2025-12-11 12:06:16,175 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:06:22,729 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:22,730 - app.services.chat_thread_service - INFO - Creating new chat thread: 40fdf6ed-3c57-4072-ab02-92e459783d4b with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:22,731 - app.services.chat_thread_service - INFO - Created new chat thread: 40fdf6ed-3c57-4072-ab02-92e459783d4b
2025-12-11 12:06:22,733 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:06:22,733 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 40fdf6ed-3c57-4072-ab02-92e459783d4b
2025-12-11 12:06:22,805 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 40fdf6ed-3c57-4072-ab02-92e459783d4b, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:22,806 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 12:06:22,809 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 40fdf6ed-3c57-4072-ab02-92e459783d4b
2025-12-11 12:06:22,810 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:06:22,810 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 40fdf6ed-3c57-4072-ab02-92e459783d4b, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:22,811 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:06:22,811 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '6f3a685e-5a10-4719-9a9d-8ff4c42ae20e', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:06:22,811 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:06:22,811 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 40fdf6ed-3c57-4072-ab02-92e459783d4b, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:06:22,814 - app.services.message_management_service - INFO - Generated message_id: 9c19ae1d-af56-48d4-a145-0cad90806d3d for thread 40fdf6ed-3c57-4072-ab02-92e459783d4b
2025-12-11 12:06:22,814 - app.services.message_management_service - INFO - Saving user message 9c19ae1d-af56-48d4-a145-0cad90806d3d to thread 40fdf6ed-3c57-4072-ab02-92e459783d4b with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:22,816 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 9c19ae1d-af56-48d4-a145-0cad90806d3d
2025-12-11 12:06:22,817 - app.services.message_management_service - INFO - Successfully saved user message 9c19ae1d-af56-48d4-a145-0cad90806d3d to thread 40fdf6ed-3c57-4072-ab02-92e459783d4b
2025-12-11 12:06:22,817 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 40fdf6ed-3c57-4072-ab02-92e459783d4b, message_id: 9c19ae1d-af56-48d4-a145-0cad90806d3d
2025-12-11 12:06:22,818 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 40fdf6ed-3c57-4072-ab02-92e459783d4b, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:24,124 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:27,070 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:27,582 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:27,916 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_k9mbBGTQVCLiNKzzivUHGn6O')]}
2025-12-11 12:06:30,755 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:32,242 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 40fdf6ed-3c57-4072-ab02-92e459783d4b, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 6f3a685e-5a10-4719-9a9d-8ff4c42ae20e, checkpoint_id: 1f0d689d-5166-6558-8006-a6fb52f98b63, content_blocks count: 3
2025-12-11 12:06:32,243 - app.services.message_management_service - INFO - Saving assistant message 6f3a685e-5a10-4719-9a9d-8ff4c42ae20e to thread 40fdf6ed-3c57-4072-ab02-92e459783d4b with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:32,245 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 6f3a685e-5a10-4719-9a9d-8ff4c42ae20e
2025-12-11 12:06:32,246 - app.services.message_management_service - INFO - Successfully saved assistant message 6f3a685e-5a10-4719-9a9d-8ff4c42ae20e to thread 40fdf6ed-3c57-4072-ab02-92e459783d4b
2025-12-11 12:06:32,247 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 32 (UUID: 6f3a685e-5a10-4719-9a9d-8ff4c42ae20e) in thread 40fdf6ed-3c57-4072-ab02-92e459783d4b
2025-12-11 12:06:36,300 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:06:38,612 - app.services.chat_thread_service - INFO - Deleting thread 40fdf6ed-3c57-4072-ab02-92e459783d4b (delete_checkpoint=True)
2025-12-11 12:06:38,614 - app.services.chat_thread_service - INFO - Deleted chat thread: 40fdf6ed-3c57-4072-ab02-92e459783d4b (messages and content blocks deleted via cascade)
2025-12-11 12:06:38,614 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:06:49,599 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:49,600 - app.services.chat_thread_service - INFO - Creating new chat thread: 519396d1-2944-440f-b2ba-a594d2437a5f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:49,601 - app.services.chat_thread_service - INFO - Created new chat thread: 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:06:49,602 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:06:49,603 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:06:49,671 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:49,671 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 12:06:49,677 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:06:49,677 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:06:49,678 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:49,678 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:06:49,678 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '7db9c1b4-a6e2-4fe7-b7e5-f29bf31732dc', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:06:49,678 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:06:49,679 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:06:49,682 - app.services.message_management_service - INFO - Generated message_id: 4ce79115-6711-4d15-88be-df3fcca5e9cd for thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:06:49,682 - app.services.message_management_service - INFO - Saving user message 4ce79115-6711-4d15-88be-df3fcca5e9cd to thread 519396d1-2944-440f-b2ba-a594d2437a5f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:49,684 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 4ce79115-6711-4d15-88be-df3fcca5e9cd
2025-12-11 12:06:49,685 - app.services.message_management_service - INFO - Successfully saved user message 4ce79115-6711-4d15-88be-df3fcca5e9cd to thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:06:49,685 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 519396d1-2944-440f-b2ba-a594d2437a5f, message_id: 4ce79115-6711-4d15-88be-df3fcca5e9cd
2025-12-11 12:06:49,686 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:50,675 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:52,218 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:06:52,607 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 7db9c1b4-a6e2-4fe7-b7e5-f29bf31732dc, checkpoint_id: 1f0d689e-139b-63ee-8003-d578c320b33e, content_blocks count: 1
2025-12-11 12:06:52,608 - app.services.message_management_service - INFO - Saving assistant message 7db9c1b4-a6e2-4fe7-b7e5-f29bf31732dc to thread 519396d1-2944-440f-b2ba-a594d2437a5f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:06:52,610 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 7db9c1b4-a6e2-4fe7-b7e5-f29bf31732dc
2025-12-11 12:06:52,611 - app.services.message_management_service - INFO - Successfully saved assistant message 7db9c1b4-a6e2-4fe7-b7e5-f29bf31732dc to thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:06:52,611 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 34 (UUID: 7db9c1b4-a6e2-4fe7-b7e5-f29bf31732dc) for approval in thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:07:00,815 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:00,820 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:07:00,820 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:07:00,821 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:00,821 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:07:00,821 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '908ac273-91e6-4ae5-bcd5-da51c400eb19', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:07:00,821 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 12:07:00,822 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 12:07:00,829 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:00,836 - app.agents.nodes.task_parser_node - WARNING - Tool the not found, skipping task 1
2025-12-11 12:07:00,836 - app.agents.nodes.task_parser_node - WARNING - Tool Once not found, skipping task 2
2025-12-11 12:07:00,837 - app.agents.nodes.task_parser_node - INFO - Parsed 0 tasks from plan
2025-12-11 12:07:01,462 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:07:04,547 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:07:05,162 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 908ac273-91e6-4ae5-bcd5-da51c400eb19, checkpoint_id: 1f0d689e-8b57-62c4-8008-4a389ced614d, content_blocks count: 1
2025-12-11 12:07:05,163 - app.services.message_management_service - INFO - Saving assistant message 908ac273-91e6-4ae5-bcd5-da51c400eb19 to thread 519396d1-2944-440f-b2ba-a594d2437a5f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:05,166 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 908ac273-91e6-4ae5-bcd5-da51c400eb19
2025-12-11 12:07:05,167 - app.services.message_management_service - INFO - Successfully saved assistant message 908ac273-91e6-4ae5-bcd5-da51c400eb19 to thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:07:05,168 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 35 (UUID: 908ac273-91e6-4ae5-bcd5-da51c400eb19) for approval in thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:07:09,306 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:09,312 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:07:09,312 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:07:09,313 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:09,313 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:07:09,313 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'ee18c2ad-a67b-4c7b-b701-291c3b50efed', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:07:09,313 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 12:07:09,314 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 12:07:09,320 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:09,326 - app.agents.nodes.task_parser_node - WARNING - Tool Execute not found, skipping task 1
2025-12-11 12:07:09,326 - app.agents.nodes.task_parser_node - WARNING - Tool Once not found, skipping task 2
2025-12-11 12:07:09,327 - app.agents.nodes.task_parser_node - INFO - Parsed 0 tasks from plan
2025-12-11 12:07:09,981 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:07:12,671 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:07:13,655 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 519396d1-2944-440f-b2ba-a594d2437a5f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: ee18c2ad-a67b-4c7b-b701-291c3b50efed, checkpoint_id: 1f0d689e-dc51-6aee-800d-7c1ebb048be7, content_blocks count: 1
2025-12-11 12:07:13,656 - app.services.message_management_service - INFO - Saving assistant message ee18c2ad-a67b-4c7b-b701-291c3b50efed to thread 519396d1-2944-440f-b2ba-a594d2437a5f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:07:13,658 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message ee18c2ad-a67b-4c7b-b701-291c3b50efed
2025-12-11 12:07:13,658 - app.services.message_management_service - INFO - Successfully saved assistant message ee18c2ad-a67b-4c7b-b701-291c3b50efed to thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:07:13,659 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 36 (UUID: ee18c2ad-a67b-4c7b-b701-291c3b50efed) for approval in thread 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:08:41,467 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:08:43,443 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:08:44,411 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 519396d1-2944-440f-b2ba-a594d2437a5f
2025-12-11 12:08:49,548 - app.services.chat_thread_service - INFO - Deleting thread 519396d1-2944-440f-b2ba-a594d2437a5f (delete_checkpoint=True)
2025-12-11 12:08:49,550 - app.services.chat_thread_service - INFO - Deleted chat thread: 519396d1-2944-440f-b2ba-a594d2437a5f (messages and content blocks deleted via cascade)
2025-12-11 12:08:49,550 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:11:13,038 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:11:13,038 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:11:13,040 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:11:13,043 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:11:13,043 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:11:16,809 - server - INFO - Logging configuration complete
2025-12-11 12:11:16,809 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:11:16,841 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:11:16,866 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:11:16,878 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:11:17,345 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:11:17,345 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:11:17,346 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:11:17,346 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:12:03,374 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:12:34,822 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:34,822 - app.services.chat_thread_service - INFO - Creating new chat thread: 13433832-473f-4ea9-a212-bc87a687ce92 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:34,825 - app.services.chat_thread_service - INFO - Created new chat thread: 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:34,851 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:12:34,851 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:34,893 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:34,893 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 12:12:34,918 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:34,918 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:12:34,919 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:34,919 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:12:34,919 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '078045f9-6064-48a8-ad77-ff942b11c4f3', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:12:34,919 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:12:34,920 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:12:34,923 - app.services.message_management_service - INFO - Generated message_id: 85f9da8e-1663-49e6-b16a-52ae75d09257 for thread 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:34,923 - app.services.message_management_service - INFO - Saving user message 85f9da8e-1663-49e6-b16a-52ae75d09257 to thread 13433832-473f-4ea9-a212-bc87a687ce92 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:34,929 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 85f9da8e-1663-49e6-b16a-52ae75d09257
2025-12-11 12:12:34,931 - app.services.message_management_service - INFO - Successfully saved user message 85f9da8e-1663-49e6-b16a-52ae75d09257 to thread 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:34,931 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 13433832-473f-4ea9-a212-bc87a687ce92, message_id: 85f9da8e-1663-49e6-b16a-52ae75d09257
2025-12-11 12:12:34,932 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:36,029 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:12:36,908 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:12:37,527 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 078045f9-6064-48a8-ad77-ff942b11c4f3, checkpoint_id: 1f0d68aa-ed00-64fd-8003-08eced019c56, content_blocks count: 1
2025-12-11 12:12:37,527 - app.services.message_management_service - INFO - Saving assistant message 078045f9-6064-48a8-ad77-ff942b11c4f3 to thread 13433832-473f-4ea9-a212-bc87a687ce92 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:37,530 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 078045f9-6064-48a8-ad77-ff942b11c4f3
2025-12-11 12:12:37,531 - app.services.message_management_service - INFO - Successfully saved assistant message 078045f9-6064-48a8-ad77-ff942b11c4f3 to thread 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:37,531 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 38 (UUID: 078045f9-6064-48a8-ad77-ff942b11c4f3) for approval in thread 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:39,245 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:39,250 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:39,250 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:12:39,250 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:39,251 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:12:39,251 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '125d7cbd-f4f2-4e68-8b9c-45f065b07de3', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:12:39,251 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 12:12:39,251 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 12:12:39,257 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:39,265 - app.agents.nodes.task_parser_node - WARNING - Tool the not found, skipping task 1
2025-12-11 12:12:39,265 - app.agents.nodes.task_parser_node - WARNING - Tool Output not found, skipping task 2
2025-12-11 12:12:39,265 - app.agents.nodes.task_parser_node - INFO - Parsed 0 tasks from plan
2025-12-11 12:12:39,799 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:12:41,767 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:12:42,447 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 13433832-473f-4ea9-a212-bc87a687ce92, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 125d7cbd-f4f2-4e68-8b9c-45f065b07de3, checkpoint_id: 1f0d68ab-1bef-67ba-8008-36790f22a1fe, content_blocks count: 1
2025-12-11 12:12:42,447 - app.services.message_management_service - INFO - Saving assistant message 125d7cbd-f4f2-4e68-8b9c-45f065b07de3 to thread 13433832-473f-4ea9-a212-bc87a687ce92 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:12:42,450 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 125d7cbd-f4f2-4e68-8b9c-45f065b07de3
2025-12-11 12:12:42,451 - app.services.message_management_service - INFO - Successfully saved assistant message 125d7cbd-f4f2-4e68-8b9c-45f065b07de3 to thread 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:12:42,451 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 39 (UUID: 125d7cbd-f4f2-4e68-8b9c-45f065b07de3) for approval in thread 13433832-473f-4ea9-a212-bc87a687ce92
2025-12-11 12:16:03,166 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:16:03,167 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:16:03,168 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:16:03,171 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:16:03,171 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:16:05,791 - server - INFO - Logging configuration complete
2025-12-11 12:16:05,791 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:16:05,810 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:16:05,833 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:16:05,841 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:16:06,207 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:16:06,207 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:16:06,208 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:16:06,208 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:16:08,709 - server - INFO - Logging configuration complete
2025-12-11 12:16:08,709 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:16:08,726 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:16:08,747 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:16:08,755 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:16:09,088 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:16:09,089 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:16:09,089 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:16:09,089 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:21:36,183 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:21:36,183 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:21:36,184 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:21:36,189 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:21:36,189 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:21:38,839 - server - INFO - Logging configuration complete
2025-12-11 12:21:38,840 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:21:38,859 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:21:38,883 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:21:38,892 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:21:39,263 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:21:39,264 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:21:39,264 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:21:39,264 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:21:52,901 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:21:52,901 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:21:52,902 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:21:52,905 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:21:52,906 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:21:55,613 - server - INFO - Logging configuration complete
2025-12-11 12:21:55,614 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:21:55,632 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:21:55,655 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:21:55,665 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:21:55,997 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:21:55,997 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:21:55,998 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:21:55,998 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:22:35,180 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:22:35,180 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:22:35,181 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:22:35,194 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:22:35,195 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:22:38,752 - server - INFO - Logging configuration complete
2025-12-11 12:22:38,752 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:22:38,777 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:22:38,799 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:22:38,810 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:22:39,249 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:22:39,249 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:22:39,249 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:22:39,249 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:23:38,579 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:23:38,579 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:23:38,580 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:23:38,591 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:23:38,592 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:23:42,792 - server - INFO - Logging configuration complete
2025-12-11 12:23:42,793 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:23:42,822 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:23:42,851 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:23:42,862 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:23:43,315 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:23:43,315 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:23:43,315 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:23:43,316 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:40:17,857 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:40:19,667 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:40:22,275 - app.services.chat_thread_service - INFO - Deleting thread 13433832-473f-4ea9-a212-bc87a687ce92 (delete_checkpoint=True)
2025-12-11 12:40:22,277 - app.services.chat_thread_service - INFO - Deleted chat thread: 13433832-473f-4ea9-a212-bc87a687ce92 (messages and content blocks deleted via cascade)
2025-12-11 12:40:22,278 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:40:25,015 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:40:25,016 - app.services.chat_thread_service - INFO - Creating new chat thread: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:40:25,019 - app.services.chat_thread_service - INFO - Created new chat thread: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2
2025-12-11 12:40:25,022 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:40:25,022 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2
2025-12-11 12:40:25,106 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:40:25,107 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 12:40:25,131 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2
2025-12-11 12:40:25,131 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:40:25,132 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:40:25,132 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:40:25,132 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '5f9f8fc2-0e6c-45cc-8d48-75db1b643399', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:40:25,132 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:40:25,133 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:40:25,135 - app.services.message_management_service - INFO - Generated message_id: a0b1b137-126a-47b9-a350-44b18f444208 for thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2
2025-12-11 12:40:25,135 - app.services.message_management_service - INFO - Saving user message a0b1b137-126a-47b9-a350-44b18f444208 to thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:40:25,139 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a0b1b137-126a-47b9-a350-44b18f444208
2025-12-11 12:40:25,140 - app.services.message_management_service - INFO - Successfully saved user message a0b1b137-126a-47b9-a350-44b18f444208 to thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2
2025-12-11 12:40:25,141 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2, message_id: a0b1b137-126a-47b9-a350-44b18f444208
2025-12-11 12:40:25,141 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:40:26,082 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:40:27,563 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:40:28,226 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:40:28,630 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_219xVXrDAEqJrgtbrBBW7YF1')]}
2025-12-11 12:40:29,283 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:40:30,718 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 5f9f8fc2-0e6c-45cc-8d48-75db1b643399, checkpoint_id: 1f0d68e9-41c6-602e-8006-477fec262e0f, content_blocks count: 3
2025-12-11 12:40:30,719 - app.services.message_management_service - INFO - Saving assistant message 5f9f8fc2-0e6c-45cc-8d48-75db1b643399 to thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:40:30,723 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 5f9f8fc2-0e6c-45cc-8d48-75db1b643399
2025-12-11 12:40:30,725 - app.services.message_management_service - INFO - Successfully saved assistant message 5f9f8fc2-0e6c-45cc-8d48-75db1b643399 to thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2
2025-12-11 12:40:30,725 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 41 (UUID: 5f9f8fc2-0e6c-45cc-8d48-75db1b643399) in thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2
2025-12-11 12:40:34,680 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:40:37,603 - app.services.chat_thread_service - INFO - Deleting thread e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2 (delete_checkpoint=True)
2025-12-11 12:40:37,605 - app.services.chat_thread_service - INFO - Deleted chat thread: e5d8bd7e-64d7-4c8b-9f01-5be888e2cdb2 (messages and content blocks deleted via cascade)
2025-12-11 12:40:37,605 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:42:37,439 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:42:37,440 - app.services.chat_thread_service - INFO - Creating new chat thread: 50a90166-11b5-4977-a03a-92084b3aed12 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:42:37,442 - app.services.chat_thread_service - INFO - Created new chat thread: 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:42:37,444 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:42:37,444 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:42:37,515 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:42:37,515 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 12:42:37,523 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:42:37,524 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:42:37,524 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:42:37,524 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:42:37,525 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '0a1bc958-d977-445d-9295-5a04513b1f7c', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:42:37,525 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:42:37,525 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:42:37,527 - app.services.message_management_service - INFO - Generated message_id: d7876b94-3898-4295-8979-653f9b1ee688 for thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:42:37,528 - app.services.message_management_service - INFO - Saving user message d7876b94-3898-4295-8979-653f9b1ee688 to thread 50a90166-11b5-4977-a03a-92084b3aed12 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:42:37,530 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message d7876b94-3898-4295-8979-653f9b1ee688
2025-12-11 12:42:37,531 - app.services.message_management_service - INFO - Successfully saved user message d7876b94-3898-4295-8979-653f9b1ee688 to thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:42:37,531 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 50a90166-11b5-4977-a03a-92084b3aed12, message_id: d7876b94-3898-4295-8979-653f9b1ee688
2025-12-11 12:42:37,531 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:42:38,656 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:42:39,391 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:42:39,625 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 0a1bc958-d977-445d-9295-5a04513b1f7c, checkpoint_id: 1f0d68ee-0f2c-62a0-8003-4d944ad29ff4, content_blocks count: 1
2025-12-11 12:42:39,626 - app.services.message_management_service - INFO - Saving assistant message 0a1bc958-d977-445d-9295-5a04513b1f7c to thread 50a90166-11b5-4977-a03a-92084b3aed12 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:42:39,629 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 0a1bc958-d977-445d-9295-5a04513b1f7c
2025-12-11 12:42:39,630 - app.services.message_management_service - INFO - Successfully saved assistant message 0a1bc958-d977-445d-9295-5a04513b1f7c to thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:42:39,630 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 43 (UUID: 0a1bc958-d977-445d-9295-5a04513b1f7c) for approval in thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:43:08,486 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:43:08,497 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:43:08,503 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:43:08,503 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:43:08,512 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:43:08,512 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'ff015379-7e2e-4ebd-9b33-a1f4e099fb1c', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:43:08,513 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 12:43:08,513 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 12:43:08,522 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:43:08,531 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 12:43:08,873 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 12:43:08,899 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 50a90166-11b5-4977-a03a-92084b3aed12: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[6].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 66, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[6].role', 'code': None}}
During task with name 'joiner' and id '48bb351f-f23c-7c4a-ee1d-6a9e5161ef24'
2025-12-11 12:43:08,906 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 50a90166-11b5-4977-a03a-92084b3aed12, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: ff015379-7e2e-4ebd-9b33-a1f4e099fb1c, checkpoint_id: 1f0d68ef-22fb-60da-8007-33bbb421463a, content_blocks count: 2
2025-12-11 12:43:08,907 - app.services.message_management_service - INFO - Saving assistant message ff015379-7e2e-4ebd-9b33-a1f4e099fb1c to thread 50a90166-11b5-4977-a03a-92084b3aed12 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:43:08,910 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message ff015379-7e2e-4ebd-9b33-a1f4e099fb1c
2025-12-11 12:43:08,911 - app.services.message_management_service - INFO - Successfully saved assistant message ff015379-7e2e-4ebd-9b33-a1f4e099fb1c to thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:43:08,911 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 44 (UUID: ff015379-7e2e-4ebd-9b33-a1f4e099fb1c) in thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:43:08,918 - app.repositories.messages_repository - ERROR - Error finding message 44 in thread 50a90166-11b5-4977-a03a-92084b3aed12: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('50a90166-11b5-4977-a03a-92084b3aed12', 44)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 12:43:08,918 - app.services.message_management_service - ERROR - Error finding message 44 in thread 50a90166-11b5-4977-a03a-92084b3aed12: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('50a90166-11b5-4977-a03a-92084b3aed12', 44)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 12:43:08,919 - app.services.message_management_service - ERROR - Error updating message 44 status: Message 44 not found in thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:43:08,919 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 50a90166-11b5-4977-a03a-92084b3aed12: Message 44 not found in thread 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:46:58,804 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:46:58,804 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:46:58,805 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:46:58,809 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:46:58,810 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:47:02,827 - server - INFO - Logging configuration complete
2025-12-11 12:47:02,828 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:47:02,855 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:47:02,877 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:47:02,885 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:47:03,362 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:47:03,363 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:47:03,363 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:47:03,363 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:49:23,775 - server - INFO - Shutting down Agent Backend API...
2025-12-11 12:49:23,775 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 12:49:23,776 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 12:49:23,779 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 12:49:23,779 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 12:49:28,000 - server - INFO - Logging configuration complete
2025-12-11 12:49:28,001 - server - INFO - Starting up Agent Backend API...
2025-12-11 12:49:28,034 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:49:28,058 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 12:49:28,070 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 12:49:28,554 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 12:49:28,554 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 12:49:28,554 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 12:49:28,554 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 12:49:32,523 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:49:36,751 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:49:37,822 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 50a90166-11b5-4977-a03a-92084b3aed12
2025-12-11 12:49:40,403 - app.services.chat_thread_service - INFO - Deleting thread 50a90166-11b5-4977-a03a-92084b3aed12 (delete_checkpoint=True)
2025-12-11 12:49:40,406 - app.services.chat_thread_service - INFO - Deleted chat thread: 50a90166-11b5-4977-a03a-92084b3aed12 (messages and content blocks deleted via cascade)
2025-12-11 12:49:40,406 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:49:46,220 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:49:46,220 - app.services.chat_thread_service - INFO - Creating new chat thread: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:49:46,223 - app.services.chat_thread_service - INFO - Created new chat thread: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382
2025-12-11 12:49:46,225 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:49:46,225 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382
2025-12-11 12:49:46,315 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:49:46,316 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 12:49:46,332 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382
2025-12-11 12:49:46,333 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:49:46,333 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:49:46,333 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:49:46,333 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '146e7979-d907-4d0f-bf8f-112a2a8adc39', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:49:46,334 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:49:46,334 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:49:46,336 - app.services.message_management_service - INFO - Generated message_id: eeae182c-97db-43a9-9f7f-0379b27719de for thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382
2025-12-11 12:49:46,337 - app.services.message_management_service - INFO - Saving user message eeae182c-97db-43a9-9f7f-0379b27719de to thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:49:46,341 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message eeae182c-97db-43a9-9f7f-0379b27719de
2025-12-11 12:49:46,342 - app.services.message_management_service - INFO - Successfully saved user message eeae182c-97db-43a9-9f7f-0379b27719de to thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382
2025-12-11 12:49:46,342 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382, message_id: eeae182c-97db-43a9-9f7f-0379b27719de
2025-12-11 12:49:46,343 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:49:47,538 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:49:48,797 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:49:49,300 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:49:49,629 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_2PjgJZZkCacgmLeLMpGzofae')]}
2025-12-11 12:49:50,314 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:49:51,651 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 146e7979-d907-4d0f-bf8f-112a2a8adc39, checkpoint_id: 1f0d68fe-2748-6e6c-8006-9e3a9302c324, content_blocks count: 3
2025-12-11 12:49:51,652 - app.services.message_management_service - INFO - Saving assistant message 146e7979-d907-4d0f-bf8f-112a2a8adc39 to thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:49:51,656 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 146e7979-d907-4d0f-bf8f-112a2a8adc39
2025-12-11 12:49:51,657 - app.services.message_management_service - INFO - Successfully saved assistant message 146e7979-d907-4d0f-bf8f-112a2a8adc39 to thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382
2025-12-11 12:49:51,657 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 46 (UUID: 146e7979-d907-4d0f-bf8f-112a2a8adc39) in thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382
2025-12-11 12:49:54,238 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:49:56,916 - app.services.chat_thread_service - INFO - Deleting thread 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382 (delete_checkpoint=True)
2025-12-11 12:49:56,918 - app.services.chat_thread_service - INFO - Deleted chat thread: 941bfa93-2cc0-4b1e-b9e7-e3c6b521a382 (messages and content blocks deleted via cascade)
2025-12-11 12:49:56,919 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:50:20,134 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:20,134 - app.services.chat_thread_service - INFO - Creating new chat thread: 5e350b3a-5c38-477f-906c-f757ba28ae55 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:20,135 - app.services.chat_thread_service - INFO - Created new chat thread: 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:20,137 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:50:20,137 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:20,205 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:20,206 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 12:50:20,211 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:20,211 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:50:20,211 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:20,212 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:50:20,212 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'd7fe49d9-75cc-444e-8c9a-6b335681694e', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:50:20,212 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:50:20,213 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:50:20,215 - app.services.message_management_service - INFO - Generated message_id: 39fdcb17-f4a9-4ec7-80c8-ac07664adc65 for thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:20,216 - app.services.message_management_service - INFO - Saving user message 39fdcb17-f4a9-4ec7-80c8-ac07664adc65 to thread 5e350b3a-5c38-477f-906c-f757ba28ae55 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:20,218 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 39fdcb17-f4a9-4ec7-80c8-ac07664adc65
2025-12-11 12:50:20,219 - app.services.message_management_service - INFO - Successfully saved user message 39fdcb17-f4a9-4ec7-80c8-ac07664adc65 to thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:20,219 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 5e350b3a-5c38-477f-906c-f757ba28ae55, message_id: 39fdcb17-f4a9-4ec7-80c8-ac07664adc65
2025-12-11 12:50:20,219 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:21,192 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:50:22,023 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:50:22,254 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: d7fe49d9-75cc-444e-8c9a-6b335681694e, checkpoint_id: 1f0d68ff-4b21-693d-8003-a50cb56b4f87, content_blocks count: 1
2025-12-11 12:50:22,254 - app.services.message_management_service - INFO - Saving assistant message d7fe49d9-75cc-444e-8c9a-6b335681694e to thread 5e350b3a-5c38-477f-906c-f757ba28ae55 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:22,257 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message d7fe49d9-75cc-444e-8c9a-6b335681694e
2025-12-11 12:50:22,258 - app.services.message_management_service - INFO - Successfully saved assistant message d7fe49d9-75cc-444e-8c9a-6b335681694e to thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:22,259 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 48 (UUID: d7fe49d9-75cc-444e-8c9a-6b335681694e) for approval in thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:25,265 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:25,270 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:25,270 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:50:25,270 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:25,271 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:50:25,271 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'a54f29b6-b472-49c7-81ff-dea677e660dc', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:50:25,271 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 12:50:25,271 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 12:50:25,276 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:25,285 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 12:50:25,577 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 12:50:25,601 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 5e350b3a-5c38-477f-906c-f757ba28ae55: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_FakXUqpA4quvzM8OzTGAMnQB", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_FakXUqpA4quvzM8OzTGAMnQB", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id '804a28a9-4cd5-3ce3-70dc-f4702ffb0f2a'
2025-12-11 12:50:25,608 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 5e350b3a-5c38-477f-906c-f757ba28ae55, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: a54f29b6-b472-49c7-81ff-dea677e660dc, checkpoint_id: 1f0d68ff-682c-6ffd-8007-0219411adc58, content_blocks count: 2
2025-12-11 12:50:25,608 - app.services.message_management_service - INFO - Saving assistant message a54f29b6-b472-49c7-81ff-dea677e660dc to thread 5e350b3a-5c38-477f-906c-f757ba28ae55 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:50:25,611 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message a54f29b6-b472-49c7-81ff-dea677e660dc
2025-12-11 12:50:25,612 - app.services.message_management_service - INFO - Successfully saved assistant message a54f29b6-b472-49c7-81ff-dea677e660dc to thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:25,612 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 49 (UUID: a54f29b6-b472-49c7-81ff-dea677e660dc) in thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:25,616 - app.repositories.messages_repository - ERROR - Error finding message 49 in thread 5e350b3a-5c38-477f-906c-f757ba28ae55: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('5e350b3a-5c38-477f-906c-f757ba28ae55', 49)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 12:50:25,617 - app.services.message_management_service - ERROR - Error finding message 49 in thread 5e350b3a-5c38-477f-906c-f757ba28ae55: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('5e350b3a-5c38-477f-906c-f757ba28ae55', 49)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 12:50:25,617 - app.services.message_management_service - ERROR - Error updating message 49 status: Message 49 not found in thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:50:25,617 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 5e350b3a-5c38-477f-906c-f757ba28ae55: Message 49 not found in thread 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:53:12,852 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 12:54:42,051 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 5e350b3a-5c38-477f-906c-f757ba28ae55
2025-12-11 12:54:47,360 - app.services.chat_thread_service - INFO - Deleting thread 5e350b3a-5c38-477f-906c-f757ba28ae55 (delete_checkpoint=True)
2025-12-11 12:54:47,362 - app.services.chat_thread_service - INFO - Deleted chat thread: 5e350b3a-5c38-477f-906c-f757ba28ae55 (messages and content blocks deleted via cascade)
2025-12-11 12:54:47,363 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 12:54:59,223 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:54:59,223 - app.services.chat_thread_service - INFO - Creating new chat thread: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:54:59,225 - app.services.chat_thread_service - INFO - Created new chat thread: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:54:59,227 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 12:54:59,227 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:54:59,302 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:54:59,303 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 12:54:59,308 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:54:59,308 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:54:59,308 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:54:59,308 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:54:59,309 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'a207abaa-8ea1-4201-b72f-ac04ed7208ca', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:54:59,309 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 12:54:59,309 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 12:54:59,312 - app.services.message_management_service - INFO - Generated message_id: 67f546bd-0976-44b3-9e80-06ecb681d6d4 for thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:54:59,312 - app.services.message_management_service - INFO - Saving user message 67f546bd-0976-44b3-9e80-06ecb681d6d4 to thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:54:59,314 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 67f546bd-0976-44b3-9e80-06ecb681d6d4
2025-12-11 12:54:59,315 - app.services.message_management_service - INFO - Successfully saved user message 67f546bd-0976-44b3-9e80-06ecb681d6d4 to thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:54:59,316 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, message_id: 67f546bd-0976-44b3-9e80-06ecb681d6d4
2025-12-11 12:54:59,316 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:55:00,184 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:55:01,501 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 12:55:01,732 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: a207abaa-8ea1-4201-b72f-ac04ed7208ca, checkpoint_id: 1f0d6909-b469-69cd-8003-d4a93ab46c75, content_blocks count: 1
2025-12-11 12:55:01,733 - app.services.message_management_service - INFO - Saving assistant message a207abaa-8ea1-4201-b72f-ac04ed7208ca to thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:55:01,736 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a207abaa-8ea1-4201-b72f-ac04ed7208ca
2025-12-11 12:55:01,737 - app.services.message_management_service - INFO - Successfully saved assistant message a207abaa-8ea1-4201-b72f-ac04ed7208ca to thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:01,739 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 51 (UUID: a207abaa-8ea1-4201-b72f-ac04ed7208ca) for approval in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:04,183 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:55:04,193 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:04,194 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 12:55:04,194 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:55:04,194 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 12:55:04,195 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'dbece393-70df-45db-bcb8-5f4b71682874', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 12:55:04,195 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 12:55:04,195 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 12:55:04,200 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:55:04,208 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 12:55:04,535 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 12:55:04,545 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_tMK5ZzN3Er6KFjH8yiSAkbM2", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_tMK5ZzN3Er6KFjH8yiSAkbM2", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id '237d427d-64cc-6bfb-af87-66edfa10d7ab'
2025-12-11 12:55:04,552 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: dbece393-70df-45db-bcb8-5f4b71682874, checkpoint_id: 1f0d6909-cc31-61f9-8007-5ea4f9cfd858, content_blocks count: 2
2025-12-11 12:55:04,552 - app.services.message_management_service - INFO - Saving assistant message dbece393-70df-45db-bcb8-5f4b71682874 to thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 12:55:04,554 - app.services.message_management_service - ERROR - Error updating block text_run--5766a216-4615-46e5-ab70-c3f3b75c39d3 status in message 1765457699306: Message 1765457699306 not found in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:04,554 - app.api.v1.endpoints.conversation - ERROR - Error updating block status for thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3, message 1765457699306, block text_run--5766a216-4615-46e5-ab70-c3f3b75c39d3: Message 1765457699306 not found in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:04,605 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message dbece393-70df-45db-bcb8-5f4b71682874
2025-12-11 12:55:04,608 - app.services.message_management_service - INFO - Successfully saved assistant message dbece393-70df-45db-bcb8-5f4b71682874 to thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:04,609 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 52 (UUID: dbece393-70df-45db-bcb8-5f4b71682874) in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:04,610 - app.repositories.messages_repository - ERROR - Error finding message 52 in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('68e6f4c7-34a8-4d47-89ff-e928689bb4b3', 52)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 12:55:04,610 - app.services.message_management_service - ERROR - Error finding message 52 in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('68e6f4c7-34a8-4d47-89ff-e928689bb4b3', 52)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 12:55:04,610 - app.services.message_management_service - ERROR - Error updating message 52 status: Message 52 not found in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 12:55:04,611 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3: Message 52 not found in thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3
2025-12-11 13:07:18,384 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:08:24,256 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:24,256 - app.services.chat_thread_service - INFO - Creating new chat thread: 3e4fe22f-a318-4159-b065-4681f13b9057 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:24,259 - app.services.chat_thread_service - INFO - Created new chat thread: 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:24,262 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:08:24,262 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:24,331 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:24,332 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:08:24,336 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:24,336 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:08:24,337 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:24,337 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:08:24,337 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '49aea17c-ae25-4698-948f-ea92ecf18a2b', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:08:24,337 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:08:24,338 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:08:24,340 - app.services.message_management_service - INFO - Generated message_id: 099c7f04-7583-4317-b002-3965cda3133e for thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:24,340 - app.services.message_management_service - INFO - Saving user message 099c7f04-7583-4317-b002-3965cda3133e to thread 3e4fe22f-a318-4159-b065-4681f13b9057 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:24,342 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 099c7f04-7583-4317-b002-3965cda3133e
2025-12-11 13:08:24,343 - app.services.message_management_service - INFO - Successfully saved user message 099c7f04-7583-4317-b002-3965cda3133e to thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:24,343 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 3e4fe22f-a318-4159-b065-4681f13b9057, message_id: 099c7f04-7583-4317-b002-3965cda3133e
2025-12-11 13:08:24,344 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:25,214 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:08:26,254 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:08:26,638 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 49aea17c-ae25-4698-948f-ea92ecf18a2b, checkpoint_id: 1f0d6927-b0a4-67b9-8003-528f2da690b3, content_blocks count: 1
2025-12-11 13:08:26,638 - app.services.message_management_service - INFO - Saving assistant message 49aea17c-ae25-4698-948f-ea92ecf18a2b to thread 3e4fe22f-a318-4159-b065-4681f13b9057 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:26,640 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 49aea17c-ae25-4698-948f-ea92ecf18a2b
2025-12-11 13:08:26,641 - app.services.message_management_service - INFO - Successfully saved assistant message 49aea17c-ae25-4698-948f-ea92ecf18a2b to thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:26,642 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 54 (UUID: 49aea17c-ae25-4698-948f-ea92ecf18a2b) for approval in thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:28,167 - app.services.message_management_service - ERROR - Error updating block text_run--376eeb58-35a2-445c-8651-fdf19820b02b status in message 1765458504334: Message 1765458504334 not found in thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:28,168 - app.api.v1.endpoints.conversation - ERROR - Error updating block status for thread 3e4fe22f-a318-4159-b065-4681f13b9057, message 1765458504334, block text_run--376eeb58-35a2-445c-8651-fdf19820b02b: Message 1765458504334 not found in thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:28,208 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:28,213 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:28,213 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:08:28,214 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:28,214 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:08:28,214 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '3e99c37c-28f3-40cd-a9f0-abde389a1cdc', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:08:28,215 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:08:28,215 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:08:28,221 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:28,230 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:08:28,541 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 13:08:28,551 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 3e4fe22f-a318-4159-b065-4681f13b9057: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_WoNAdckyD2awQZKq7fJR3xf0", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_WoNAdckyD2awQZKq7fJR3xf0", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id 'b1e8f92e-8513-e85c-06ff-15c62a26b5fe'
2025-12-11 13:08:28,557 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 3e4fe22f-a318-4159-b065-4681f13b9057, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 3e99c37c-28f3-40cd-a9f0-abde389a1cdc, checkpoint_id: 1f0d6927-bff4-6440-8007-dfaf8d4c0c95, content_blocks count: 2
2025-12-11 13:08:28,557 - app.services.message_management_service - INFO - Saving assistant message 3e99c37c-28f3-40cd-a9f0-abde389a1cdc to thread 3e4fe22f-a318-4159-b065-4681f13b9057 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:08:28,560 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message 3e99c37c-28f3-40cd-a9f0-abde389a1cdc
2025-12-11 13:08:28,561 - app.services.message_management_service - INFO - Successfully saved assistant message 3e99c37c-28f3-40cd-a9f0-abde389a1cdc to thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:28,561 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 55 (UUID: 3e99c37c-28f3-40cd-a9f0-abde389a1cdc) in thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:28,562 - app.repositories.messages_repository - ERROR - Error finding message 55 in thread 3e4fe22f-a318-4159-b065-4681f13b9057: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('3e4fe22f-a318-4159-b065-4681f13b9057', 55)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:08:28,563 - app.services.message_management_service - ERROR - Error finding message 55 in thread 3e4fe22f-a318-4159-b065-4681f13b9057: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('3e4fe22f-a318-4159-b065-4681f13b9057', 55)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:08:28,563 - app.services.message_management_service - ERROR - Error updating message 55 status: Message 55 not found in thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:08:28,563 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 3e4fe22f-a318-4159-b065-4681f13b9057: Message 55 not found in thread 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:09:03,810 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:10:09,277 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:10:10,061 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 3e4fe22f-a318-4159-b065-4681f13b9057
2025-12-11 13:10:16,658 - app.services.chat_thread_service - INFO - Deleting thread 3e4fe22f-a318-4159-b065-4681f13b9057 (delete_checkpoint=True)
2025-12-11 13:10:16,661 - app.services.chat_thread_service - INFO - Deleted chat thread: 3e4fe22f-a318-4159-b065-4681f13b9057 (messages and content blocks deleted via cascade)
2025-12-11 13:10:16,661 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:10:22,165 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:22,165 - app.services.chat_thread_service - INFO - Creating new chat thread: 49e42c7b-d469-41c5-a251-203ad645e96e with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:22,167 - app.services.chat_thread_service - INFO - Created new chat thread: 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:22,169 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:10:22,170 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:22,249 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:22,249 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:10:22,254 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:22,254 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:10:22,254 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:22,255 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:10:22,255 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '69ac4f15-979a-4620-a30d-143a9e885456', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:10:22,255 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:10:22,255 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:10:22,259 - app.services.message_management_service - INFO - Generated message_id: a590eeb1-eda8-42d9-a926-4cb5e105675e for thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:22,259 - app.services.message_management_service - INFO - Saving user message a590eeb1-eda8-42d9-a926-4cb5e105675e to thread 49e42c7b-d469-41c5-a251-203ad645e96e with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:22,262 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a590eeb1-eda8-42d9-a926-4cb5e105675e
2025-12-11 13:10:22,263 - app.services.message_management_service - INFO - Successfully saved user message a590eeb1-eda8-42d9-a926-4cb5e105675e to thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:22,263 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 49e42c7b-d469-41c5-a251-203ad645e96e, message_id: a590eeb1-eda8-42d9-a926-4cb5e105675e
2025-12-11 13:10:22,264 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:22,988 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:10:23,922 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:10:24,143 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 69ac4f15-979a-4620-a30d-143a9e885456, checkpoint_id: 1f0d692c-113f-6445-8003-dfb7c646e302, content_blocks count: 1
2025-12-11 13:10:24,144 - app.services.message_management_service - INFO - Saving assistant message 69ac4f15-979a-4620-a30d-143a9e885456 to thread 49e42c7b-d469-41c5-a251-203ad645e96e with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:24,147 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 69ac4f15-979a-4620-a30d-143a9e885456
2025-12-11 13:10:24,148 - app.services.message_management_service - INFO - Successfully saved assistant message 69ac4f15-979a-4620-a30d-143a9e885456 to thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:24,148 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 57 (UUID: 69ac4f15-979a-4620-a30d-143a9e885456) for approval in thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:25,668 - app.services.message_management_service - ERROR - Error updating block text_run--3c9ddeae-dd6f-47b8-8b8d-3c67a467b04f status in message 1765458622252: Message 1765458622252 not found in thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:25,668 - app.api.v1.endpoints.conversation - ERROR - Error updating block status for thread 49e42c7b-d469-41c5-a251-203ad645e96e, message 1765458622252, block text_run--3c9ddeae-dd6f-47b8-8b8d-3c67a467b04f: Message 1765458622252 not found in thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:25,669 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:25,674 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:25,675 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:10:25,675 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:25,675 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:10:25,676 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'c0db34f9-a6a4-4a31-b18d-33652acc4803', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:10:25,676 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:10:25,676 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:10:25,682 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:25,690 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:10:25,992 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 13:10:26,004 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 49e42c7b-d469-41c5-a251-203ad645e96e: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_l0emmXAUNTeEt9tklsPqRDnI", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_l0emmXAUNTeEt9tklsPqRDnI", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id '05a099e5-a257-67e3-fa76-908bb5204885'
2025-12-11 13:10:26,010 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 49e42c7b-d469-41c5-a251-203ad645e96e, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: c0db34f9-a6a4-4a31-b18d-33652acc4803, checkpoint_id: 1f0d692c-201f-6eee-8007-d67f59c9078e, content_blocks count: 2
2025-12-11 13:10:26,011 - app.services.message_management_service - INFO - Saving assistant message c0db34f9-a6a4-4a31-b18d-33652acc4803 to thread 49e42c7b-d469-41c5-a251-203ad645e96e with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:10:26,014 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message c0db34f9-a6a4-4a31-b18d-33652acc4803
2025-12-11 13:10:26,015 - app.services.message_management_service - INFO - Successfully saved assistant message c0db34f9-a6a4-4a31-b18d-33652acc4803 to thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:26,015 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 58 (UUID: c0db34f9-a6a4-4a31-b18d-33652acc4803) in thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:26,016 - app.repositories.messages_repository - ERROR - Error finding message 58 in thread 49e42c7b-d469-41c5-a251-203ad645e96e: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('49e42c7b-d469-41c5-a251-203ad645e96e', 58)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:10:26,017 - app.services.message_management_service - ERROR - Error finding message 58 in thread 49e42c7b-d469-41c5-a251-203ad645e96e: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('49e42c7b-d469-41c5-a251-203ad645e96e', 58)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:10:26,017 - app.services.message_management_service - ERROR - Error updating message 58 status: Message 58 not found in thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:10:26,017 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 49e42c7b-d469-41c5-a251-203ad645e96e: Message 58 not found in thread 49e42c7b-d469-41c5-a251-203ad645e96e
2025-12-11 13:12:15,079 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:13:18,757 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:18,757 - app.services.chat_thread_service - INFO - Creating new chat thread: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:18,759 - app.services.chat_thread_service - INFO - Created new chat thread: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:18,761 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:13:18,761 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:18,831 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:18,831 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:13:18,841 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:18,842 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:13:18,842 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:18,842 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:13:18,842 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '4de4d33d-0efa-47f4-8523-ca5806e3c988', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:13:18,843 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:13:18,843 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:13:18,846 - app.services.message_management_service - INFO - Generated message_id: 20b4f8ad-16cc-4d31-82c5-f6667b338c4c for thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:18,846 - app.services.message_management_service - INFO - Saving user message 20b4f8ad-16cc-4d31-82c5-f6667b338c4c to thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:18,849 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 20b4f8ad-16cc-4d31-82c5-f6667b338c4c
2025-12-11 13:13:18,850 - app.services.message_management_service - INFO - Successfully saved user message 20b4f8ad-16cc-4d31-82c5-f6667b338c4c to thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:18,850 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, message_id: 20b4f8ad-16cc-4d31-82c5-f6667b338c4c
2025-12-11 13:13:18,851 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:19,655 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:13:20,531 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:13:20,839 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 4de4d33d-0efa-47f4-8523-ca5806e3c988, checkpoint_id: 1f0d6932-a651-6894-8003-004bdc606445, content_blocks count: 1
2025-12-11 13:13:20,839 - app.services.message_management_service - INFO - Saving assistant message 4de4d33d-0efa-47f4-8523-ca5806e3c988 to thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:20,842 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 4de4d33d-0efa-47f4-8523-ca5806e3c988
2025-12-11 13:13:20,843 - app.services.message_management_service - INFO - Successfully saved assistant message 4de4d33d-0efa-47f4-8523-ca5806e3c988 to thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:20,844 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 60 (UUID: 4de4d33d-0efa-47f4-8523-ca5806e3c988) for approval in thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:23,199 - app.services.message_management_service - ERROR - Failed to update block text_run--aec8cecb-a0aa-42dd-9207-460bf0f19719 status in message 4de4d33d-0efa-47f4-8523-ca5806e3c988
2025-12-11 13:13:23,235 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:23,243 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:23,243 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:13:23,244 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:23,244 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:13:23,245 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'f8d5d8c1-1529-447e-88d9-c90567790bab', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:13:23,245 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:13:23,246 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:13:23,253 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:23,263 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:13:23,677 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 13:13:23,690 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_BBNvGYqkUEdWWZLJiiN8AFwg", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_BBNvGYqkUEdWWZLJiiN8AFwg", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id '39d1bbaf-f79d-d851-723e-5e546047e65f'
2025-12-11 13:13:23,697 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: f8d5d8c1-1529-447e-88d9-c90567790bab, checkpoint_id: 1f0d6932-bda2-6691-8007-1f5f46a08ae1, content_blocks count: 2
2025-12-11 13:13:23,697 - app.services.message_management_service - INFO - Saving assistant message f8d5d8c1-1529-447e-88d9-c90567790bab to thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:13:23,701 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message f8d5d8c1-1529-447e-88d9-c90567790bab
2025-12-11 13:13:23,702 - app.services.message_management_service - INFO - Successfully saved assistant message f8d5d8c1-1529-447e-88d9-c90567790bab to thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:23,702 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 61 (UUID: f8d5d8c1-1529-447e-88d9-c90567790bab) in thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:23,703 - app.repositories.messages_repository - ERROR - Error finding message 61 in thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('1a8b0a42-fe3f-47cd-ba89-057d797ca99a', 61)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:13:23,703 - app.services.message_management_service - ERROR - Error finding message 61 in thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('1a8b0a42-fe3f-47cd-ba89-057d797ca99a', 61)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:13:23,704 - app.services.message_management_service - ERROR - Error updating message 61 status: Message 61 not found in thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:13:23,704 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a: Message 61 not found in thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:17:01,434 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:18:12,739 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:18:12,739 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:18:12,741 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:18:12,748 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:18:12,748 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:18:16,721 - server - INFO - Logging configuration complete
2025-12-11 13:18:16,722 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:18:16,754 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:18:16,779 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:18:16,789 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:18:17,320 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:18:17,321 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:18:17,321 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:18:17,321 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:18:20,731 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:18:20,731 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:18:20,732 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:18:20,737 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:18:20,738 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:18:23,375 - server - INFO - Logging configuration complete
2025-12-11 13:18:23,375 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:18:23,393 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:18:23,416 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:18:23,425 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:18:23,806 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:18:23,807 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:18:23,807 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:18:23,807 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:21:03,612 - app.services.chat_thread_service - INFO - Deleting thread 68e6f4c7-34a8-4d47-89ff-e928689bb4b3 (delete_checkpoint=True)
2025-12-11 13:21:03,626 - app.services.chat_thread_service - INFO - Deleted chat thread: 68e6f4c7-34a8-4d47-89ff-e928689bb4b3 (messages and content blocks deleted via cascade)
2025-12-11 13:21:03,627 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:21:05,738 - app.services.chat_thread_service - INFO - Deleting thread 49e42c7b-d469-41c5-a251-203ad645e96e (delete_checkpoint=True)
2025-12-11 13:21:05,740 - app.services.chat_thread_service - INFO - Deleted chat thread: 49e42c7b-d469-41c5-a251-203ad645e96e (messages and content blocks deleted via cascade)
2025-12-11 13:21:05,740 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:21:07,635 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 1a8b0a42-fe3f-47cd-ba89-057d797ca99a
2025-12-11 13:21:12,586 - app.services.chat_thread_service - INFO - Deleting thread 1a8b0a42-fe3f-47cd-ba89-057d797ca99a (delete_checkpoint=True)
2025-12-11 13:21:12,587 - app.services.chat_thread_service - INFO - Deleted chat thread: 1a8b0a42-fe3f-47cd-ba89-057d797ca99a (messages and content blocks deleted via cascade)
2025-12-11 13:21:12,588 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:21:19,108 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:21:19,108 - app.services.chat_thread_service - INFO - Creating new chat thread: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:21:19,112 - app.services.chat_thread_service - INFO - Created new chat thread: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:21:19,116 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:21:19,116 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:21:19,204 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:21:19,204 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:21:19,223 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:21:19,223 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:21:19,223 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:21:19,223 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:21:19,224 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'f23df432-26d6-414b-bdc5-0e9a238934ff', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:21:19,224 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:21:19,224 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:21:19,227 - app.services.message_management_service - INFO - Generated message_id: cbbaa2b5-8807-4830-a745-3d5bf4796117 for thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:21:19,227 - app.services.message_management_service - INFO - Saving user message cbbaa2b5-8807-4830-a745-3d5bf4796117 to thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:21:19,231 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message cbbaa2b5-8807-4830-a745-3d5bf4796117
2025-12-11 13:21:19,232 - app.services.message_management_service - INFO - Successfully saved user message cbbaa2b5-8807-4830-a745-3d5bf4796117 to thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:21:19,232 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, message_id: cbbaa2b5-8807-4830-a745-3d5bf4796117
2025-12-11 13:21:19,233 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:21:20,004 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:21:21,161 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:21:21,622 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: f23df432-26d6-414b-bdc5-0e9a238934ff, checkpoint_id: 1f0d6944-8f74-6a1b-8003-4dc23961fe40, content_blocks count: 1
2025-12-11 13:21:21,623 - app.services.message_management_service - INFO - Saving assistant message f23df432-26d6-414b-bdc5-0e9a238934ff to thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:21:21,625 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message f23df432-26d6-414b-bdc5-0e9a238934ff
2025-12-11 13:21:21,626 - app.services.message_management_service - INFO - Successfully saved assistant message f23df432-26d6-414b-bdc5-0e9a238934ff to thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:21:21,626 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 63 (UUID: f23df432-26d6-414b-bdc5-0e9a238934ff) for approval in thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:22:07,482 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:22:07,489 - app.services.message_management_service - ERROR - Failed to update block text_run--47e6ceaf-79e0-4af6-b049-756e0e5909dd status in message f23df432-26d6-414b-bdc5-0e9a238934ff
2025-12-11 13:22:07,490 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:22:07,490 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:22:07,490 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:22:07,491 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:22:07,491 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '3784469c-5fcf-4de6-a15d-96a38cbed87d', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:22:07,491 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:22:07,491 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:22:07,497 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:22:07,505 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:22:07,993 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 13:22:08,020 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_ZpldQbNqNbagRkbbnMRnpzOs", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_ZpldQbNqNbagRkbbnMRnpzOs", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id '03909731-b3e6-7adc-49aa-4283f9da2714'
2025-12-11 13:22:08,027 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 3784469c-5fcf-4de6-a15d-96a38cbed87d, checkpoint_id: 1f0d6946-452a-6194-8007-e7e3a5490d51, content_blocks count: 2
2025-12-11 13:22:08,028 - app.services.message_management_service - INFO - Saving assistant message 3784469c-5fcf-4de6-a15d-96a38cbed87d to thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:22:08,032 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message 3784469c-5fcf-4de6-a15d-96a38cbed87d
2025-12-11 13:22:08,034 - app.services.message_management_service - INFO - Successfully saved assistant message 3784469c-5fcf-4de6-a15d-96a38cbed87d to thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:22:08,034 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 64 (UUID: 3784469c-5fcf-4de6-a15d-96a38cbed87d) in thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:22:08,036 - app.repositories.messages_repository - ERROR - Error finding message 64 in thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa', 64)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:22:08,037 - app.services.message_management_service - ERROR - Error finding message 64 in thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa', 64)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:22:08,037 - app.services.message_management_service - ERROR - Error updating message 64 status: Message 64 not found in thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:22:08,037 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa: Message 64 not found in thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa
2025-12-11 13:29:34,711 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:29:40,010 - app.services.chat_thread_service - INFO - Deleting thread dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa (delete_checkpoint=True)
2025-12-11 13:29:40,013 - app.services.chat_thread_service - INFO - Deleted chat thread: dd4e5bb3-030f-4a66-8d0b-63a472d4e0fa (messages and content blocks deleted via cascade)
2025-12-11 13:29:40,013 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:29:43,502 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:29:49,881 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:29:49,882 - app.services.chat_thread_service - INFO - Creating new chat thread: 9328aaf0-d907-4857-b84e-4669b2b5b131 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:29:49,884 - app.services.chat_thread_service - INFO - Created new chat thread: 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:29:49,886 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:29:49,886 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:29:49,957 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:29:49,958 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:29:49,962 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:29:49,963 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:29:49,963 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:29:49,963 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:29:49,964 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'f1b19356-0857-4b9a-b3bc-e13e25107fdc', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:29:49,964 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:29:49,964 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:29:49,967 - app.services.message_management_service - INFO - Generated message_id: c7a86d04-4e45-4089-9f62-d72aa0aae770 for thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:29:49,967 - app.services.message_management_service - INFO - Saving user message c7a86d04-4e45-4089-9f62-d72aa0aae770 to thread 9328aaf0-d907-4857-b84e-4669b2b5b131 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:29:49,970 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message c7a86d04-4e45-4089-9f62-d72aa0aae770
2025-12-11 13:29:49,971 - app.services.message_management_service - INFO - Successfully saved user message c7a86d04-4e45-4089-9f62-d72aa0aae770 to thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:29:49,971 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 9328aaf0-d907-4857-b84e-4669b2b5b131, message_id: c7a86d04-4e45-4089-9f62-d72aa0aae770
2025-12-11 13:29:49,971 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:29:51,217 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:29:52,236 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:29:52,465 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: f1b19356-0857-4b9a-b3bc-e13e25107fdc, checkpoint_id: 1f0d6957-973d-6343-8003-a6a0d33c6cfd, content_blocks count: 1
2025-12-11 13:29:52,466 - app.services.message_management_service - INFO - Saving assistant message f1b19356-0857-4b9a-b3bc-e13e25107fdc to thread 9328aaf0-d907-4857-b84e-4669b2b5b131 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:29:52,469 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message f1b19356-0857-4b9a-b3bc-e13e25107fdc
2025-12-11 13:29:52,470 - app.services.message_management_service - INFO - Successfully saved assistant message f1b19356-0857-4b9a-b3bc-e13e25107fdc to thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:29:52,470 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 66 (UUID: f1b19356-0857-4b9a-b3bc-e13e25107fdc) for approval in thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:30:01,332 - app.services.message_management_service - ERROR - Failed to update block text_ee0338b4-bd9a-4e19-8112-60ff05b427d9 status in message f1b19356-0857-4b9a-b3bc-e13e25107fdc
2025-12-11 13:30:01,369 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:30:01,374 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:30:01,375 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:30:01,375 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:30:01,375 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:30:01,376 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '4aaa3328-bfa3-4446-8394-5941a4be6034', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:30:01,376 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:30:01,376 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:30:01,383 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:30:01,390 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:30:01,847 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 13:30:01,860 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 9328aaf0-d907-4857-b84e-4669b2b5b131: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_xFAJMOvrUxLQuAQt2po517Kg", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_xFAJMOvrUxLQuAQt2po517Kg", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id '457d7c0e-863d-7750-78ff-ca3114938e22'
2025-12-11 13:30:01,867 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 9328aaf0-d907-4857-b84e-4669b2b5b131, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 4aaa3328-bfa3-4446-8394-5941a4be6034, checkpoint_id: 1f0d6957-ec7d-617f-8007-b8ded1bcda0c, content_blocks count: 2
2025-12-11 13:30:01,867 - app.services.message_management_service - INFO - Saving assistant message 4aaa3328-bfa3-4446-8394-5941a4be6034 to thread 9328aaf0-d907-4857-b84e-4669b2b5b131 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:30:01,871 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message 4aaa3328-bfa3-4446-8394-5941a4be6034
2025-12-11 13:30:01,872 - app.services.message_management_service - INFO - Successfully saved assistant message 4aaa3328-bfa3-4446-8394-5941a4be6034 to thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:30:01,872 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 67 (UUID: 4aaa3328-bfa3-4446-8394-5941a4be6034) in thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:30:01,873 - app.repositories.messages_repository - ERROR - Error finding message 67 in thread 9328aaf0-d907-4857-b84e-4669b2b5b131: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('9328aaf0-d907-4857-b84e-4669b2b5b131', 67)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:30:01,874 - app.services.message_management_service - ERROR - Error finding message 67 in thread 9328aaf0-d907-4857-b84e-4669b2b5b131: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('9328aaf0-d907-4857-b84e-4669b2b5b131', 67)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:30:01,874 - app.services.message_management_service - ERROR - Error updating message 67 status: Message 67 not found in thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:30:01,874 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 9328aaf0-d907-4857-b84e-4669b2b5b131: Message 67 not found in thread 9328aaf0-d907-4857-b84e-4669b2b5b131
2025-12-11 13:31:48,107 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:31:48,108 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:31:48,109 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:31:48,112 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:31:48,112 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:31:52,039 - server - INFO - Logging configuration complete
2025-12-11 13:31:52,040 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:31:52,068 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:31:52,093 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:31:52,102 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:31:52,615 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:31:52,615 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:31:52,616 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:31:52,616 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:32:06,146 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:32:06,146 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:32:06,147 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:32:06,151 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:32:06,151 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:32:08,841 - server - INFO - Logging configuration complete
2025-12-11 13:32:08,841 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:32:08,863 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:32:08,894 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:32:08,904 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:32:09,283 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:32:09,284 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:32:09,284 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:32:09,284 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:35:04,782 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:35:04,783 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:35:04,784 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:35:04,790 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:35:04,791 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:35:24,603 - server - INFO - Logging configuration complete
2025-12-11 13:35:24,603 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:35:24,621 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:35:24,644 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:35:24,654 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:35:25,030 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:35:25,031 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:35:25,031 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:35:25,031 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:36:48,622 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:36:48,623 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:36:48,624 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:36:48,627 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:36:48,627 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:36:52,573 - server - INFO - Logging configuration complete
2025-12-11 13:36:52,573 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:36:52,593 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:36:52,621 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:36:52,634 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:36:53,039 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:36:53,039 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:36:53,040 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:36:53,040 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:37:02,803 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:37:05,339 - app.services.chat_thread_service - INFO - Deleting thread 9328aaf0-d907-4857-b84e-4669b2b5b131 (delete_checkpoint=True)
2025-12-11 13:37:05,343 - app.services.chat_thread_service - INFO - Deleted chat thread: 9328aaf0-d907-4857-b84e-4669b2b5b131 (messages and content blocks deleted via cascade)
2025-12-11 13:37:05,343 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:37:11,188 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:37:18,507 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:18,507 - app.services.chat_thread_service - INFO - Creating new chat thread: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:18,510 - app.services.chat_thread_service - INFO - Created new chat thread: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb
2025-12-11 13:37:18,513 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:37:18,513 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb
2025-12-11 13:37:18,591 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:18,591 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 13:37:18,614 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb
2025-12-11 13:37:18,614 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:37:18,614 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:18,614 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:37:18,615 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '2faabfb4-5061-4781-ac55-fa32a77c670b', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:37:18,615 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:37:18,615 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:37:18,617 - app.services.message_management_service - INFO - Generated message_id: d2836dd7-0355-4e04-9dd3-803af3765346 for thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb
2025-12-11 13:37:18,618 - app.services.message_management_service - INFO - Saving user message d2836dd7-0355-4e04-9dd3-803af3765346 to thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:18,622 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message d2836dd7-0355-4e04-9dd3-803af3765346
2025-12-11 13:37:18,623 - app.services.message_management_service - INFO - Successfully saved user message d2836dd7-0355-4e04-9dd3-803af3765346 to thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb
2025-12-11 13:37:18,623 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb, message_id: d2836dd7-0355-4e04-9dd3-803af3765346
2025-12-11 13:37:18,623 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:19,557 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:37:20,761 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:37:21,341 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:37:21,576 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_ZpwYKhdfnGxLfITGuwsfX5Wz')]}
2025-12-11 13:37:22,312 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:37:24,036 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 2faabfb4-5061-4781-ac55-fa32a77c670b, checkpoint_id: 1f0d6968-69bf-6408-8006-4f2135159ba7, content_blocks count: 3
2025-12-11 13:37:24,037 - app.services.message_management_service - INFO - Saving assistant message 2faabfb4-5061-4781-ac55-fa32a77c670b to thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:24,041 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 2faabfb4-5061-4781-ac55-fa32a77c670b
2025-12-11 13:37:24,042 - app.services.message_management_service - INFO - Successfully saved assistant message 2faabfb4-5061-4781-ac55-fa32a77c670b to thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb
2025-12-11 13:37:24,042 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 69 (UUID: 2faabfb4-5061-4781-ac55-fa32a77c670b) in thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb
2025-12-11 13:37:26,654 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:37:29,210 - app.services.chat_thread_service - INFO - Deleting thread 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb (delete_checkpoint=True)
2025-12-11 13:37:29,211 - app.services.chat_thread_service - INFO - Deleted chat thread: 1e1bfbe5-96f3-4c4f-a26a-8043d6aebceb (messages and content blocks deleted via cascade)
2025-12-11 13:37:29,212 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:37:46,912 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:46,913 - app.services.chat_thread_service - INFO - Creating new chat thread: e048fb7c-b7dc-4d49-bd49-9de1b516ef15 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:46,914 - app.services.chat_thread_service - INFO - Created new chat thread: e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:46,916 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:37:46,916 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:46,984 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:46,985 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:37:46,989 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:46,989 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:37:46,989 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:46,990 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:37:46,990 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '9a4092f6-5420-438a-aa0d-50e72b756d1b', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:37:46,990 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:37:46,990 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:37:46,993 - app.services.message_management_service - INFO - Generated message_id: feb203e8-c7f6-45c9-92b9-f3c0e11f8fbd for thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:46,993 - app.services.message_management_service - INFO - Saving user message feb203e8-c7f6-45c9-92b9-f3c0e11f8fbd to thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:46,995 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message feb203e8-c7f6-45c9-92b9-f3c0e11f8fbd
2025-12-11 13:37:46,996 - app.services.message_management_service - INFO - Successfully saved user message feb203e8-c7f6-45c9-92b9-f3c0e11f8fbd to thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:46,996 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15, message_id: feb203e8-c7f6-45c9-92b9-f3c0e11f8fbd
2025-12-11 13:37:46,997 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:47,786 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:37:48,731 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:37:49,183 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 9a4092f6-5420-438a-aa0d-50e72b756d1b, checkpoint_id: 1f0d6969-5992-6b5f-8003-db85adf61acf, content_blocks count: 1
2025-12-11 13:37:49,184 - app.services.message_management_service - INFO - Saving assistant message 9a4092f6-5420-438a-aa0d-50e72b756d1b to thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:49,186 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 9a4092f6-5420-438a-aa0d-50e72b756d1b
2025-12-11 13:37:49,187 - app.services.message_management_service - INFO - Successfully saved assistant message 9a4092f6-5420-438a-aa0d-50e72b756d1b to thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:49,187 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 71 (UUID: 9a4092f6-5420-438a-aa0d-50e72b756d1b) for approval in thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:50,723 - app.repositories.message_content_repository - INFO - Updated block text_run--68ffec90-b195-4dcc-b565-c0484e557d1f with fields: ['needs_approval', 'message_status']
2025-12-11 13:37:50,723 - app.services.message_management_service - INFO - Updated block text_run--68ffec90-b195-4dcc-b565-c0484e557d1f status in message 9a4092f6-5420-438a-aa0d-50e72b756d1b: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 13:37:50,759 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:50,765 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:50,766 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:37:50,766 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:50,767 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:37:50,767 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '51127341-9fa5-4cfb-8ec9-ced07eff3113', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:37:50,767 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:37:50,767 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:37:50,774 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:50,785 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:37:51,227 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 13:37:51,251 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_0KctgBzQIvzWvu35ILISP7nB", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "An assistant message with 'tool_calls' must be followed by tool messages responding to each 'tool_call_id'. The following tool_call_ids did not have response messages: call_0KctgBzQIvzWvu35ILISP7nB", 'type': 'invalid_request_error', 'param': 'messages.[3].role', 'code': None}}
During task with name 'joiner' and id '786f7ca4-fbd5-d67e-bcce-c8a133e2b998'
2025-12-11 13:37:51,257 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: e048fb7c-b7dc-4d49-bd49-9de1b516ef15, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 51127341-9fa5-4cfb-8ec9-ced07eff3113, checkpoint_id: 1f0d6969-68fa-6a3c-8007-7bb991667455, content_blocks count: 2
2025-12-11 13:37:51,258 - app.services.message_management_service - INFO - Saving assistant message 51127341-9fa5-4cfb-8ec9-ced07eff3113 to thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:37:51,261 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message 51127341-9fa5-4cfb-8ec9-ced07eff3113
2025-12-11 13:37:51,262 - app.services.message_management_service - INFO - Successfully saved assistant message 51127341-9fa5-4cfb-8ec9-ced07eff3113 to thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:51,262 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 72 (UUID: 51127341-9fa5-4cfb-8ec9-ced07eff3113) in thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:51,264 - app.repositories.messages_repository - ERROR - Error finding message 72 in thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('e048fb7c-b7dc-4d49-bd49-9de1b516ef15', 72)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:37:51,264 - app.services.message_management_service - ERROR - Error finding message 72 in thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('e048fb7c-b7dc-4d49-bd49-9de1b516ef15', 72)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:37:51,264 - app.services.message_management_service - ERROR - Error updating message 72 status: Message 72 not found in thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:51,264 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15: Message 72 not found in thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:37:57,780 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:38:00,638 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:38:04,300 - app.api.v1.endpoints.conversation - INFO - Restoring conversation e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:38:10,394 - app.api.v1.endpoints.conversation - INFO - Restoring conversation e048fb7c-b7dc-4d49-bd49-9de1b516ef15
2025-12-11 13:38:13,847 - app.services.chat_thread_service - INFO - Deleting thread e048fb7c-b7dc-4d49-bd49-9de1b516ef15 (delete_checkpoint=True)
2025-12-11 13:38:13,848 - app.services.chat_thread_service - INFO - Deleted chat thread: e048fb7c-b7dc-4d49-bd49-9de1b516ef15 (messages and content blocks deleted via cascade)
2025-12-11 13:38:13,848 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:43:11,111 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:43:11,112 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:43:11,113 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:43:11,118 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:43:11,118 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:43:13,655 - server - INFO - Logging configuration complete
2025-12-11 13:43:13,655 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:43:13,676 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:43:13,701 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:43:13,711 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:43:14,117 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:43:14,118 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:43:14,118 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:43:14,118 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:43:17,865 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:43:32,366 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:32,367 - app.services.chat_thread_service - INFO - Creating new chat thread: e5dd093a-7692-48c8-bba7-583bdae80393 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:32,370 - app.services.chat_thread_service - INFO - Created new chat thread: e5dd093a-7692-48c8-bba7-583bdae80393
2025-12-11 13:43:32,394 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:43:32,394 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: e5dd093a-7692-48c8-bba7-583bdae80393
2025-12-11 13:43:32,477 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: e5dd093a-7692-48c8-bba7-583bdae80393, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:32,478 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 13:43:32,498 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: e5dd093a-7692-48c8-bba7-583bdae80393
2025-12-11 13:43:32,498 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:43:32,498 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: e5dd093a-7692-48c8-bba7-583bdae80393, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:32,498 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:43:32,499 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': 'ff7b39bf-37ff-4595-ad22-1be0aea830be', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:43:32,499 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:43:32,499 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: e5dd093a-7692-48c8-bba7-583bdae80393, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:43:32,502 - app.services.message_management_service - INFO - Generated message_id: 6d08cae3-d88f-4661-b66b-37f28650184e for thread e5dd093a-7692-48c8-bba7-583bdae80393
2025-12-11 13:43:32,502 - app.services.message_management_service - INFO - Saving user message 6d08cae3-d88f-4661-b66b-37f28650184e to thread e5dd093a-7692-48c8-bba7-583bdae80393 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:32,507 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 6d08cae3-d88f-4661-b66b-37f28650184e
2025-12-11 13:43:32,509 - app.services.message_management_service - INFO - Successfully saved user message 6d08cae3-d88f-4661-b66b-37f28650184e to thread e5dd093a-7692-48c8-bba7-583bdae80393
2025-12-11 13:43:32,509 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread e5dd093a-7692-48c8-bba7-583bdae80393, message_id: 6d08cae3-d88f-4661-b66b-37f28650184e
2025-12-11 13:43:32,509 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: e5dd093a-7692-48c8-bba7-583bdae80393, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:33,277 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:43:34,454 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:43:34,998 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:43:35,516 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_f3WUJvJJ9gfeTisqXZ3PQWto')]}
2025-12-11 13:43:36,471 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:43:38,080 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: e5dd093a-7692-48c8-bba7-583bdae80393, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: ff7b39bf-37ff-4595-ad22-1be0aea830be, checkpoint_id: 1f0d6976-408d-640b-8005-08caeb83467a, content_blocks count: 3
2025-12-11 13:43:38,081 - app.services.message_management_service - INFO - Saving assistant message ff7b39bf-37ff-4595-ad22-1be0aea830be to thread e5dd093a-7692-48c8-bba7-583bdae80393 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:38,083 - sqlalchemy.pool.impl.AsyncAdaptedQueuePool - ERROR - Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x742140aa4310>>
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
asyncio.exceptions.CancelledError: Cancelled by cancel scope 742131f01d90
2025-12-11 13:43:38,087 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:43:38,088 - sqlalchemy.pool.impl.AsyncAdaptedQueuePool - ERROR - Exception terminating connection <AdaptedConnection <asyncpg.connection.Connection object at 0x742140aa4310>>
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/pool/base.py", line 372, in _close_connection
    self._dialect.do_terminate(connection)
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 1136, in do_terminate
    dbapi_connection.terminate()
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/dialects/postgresql/asyncpg.py", line 907, in terminate
    self.await_(asyncio.shield(self._connection.close(timeout=2)))
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
asyncio.exceptions.CancelledError: Cancelled by cancel scope 742131f01d90
2025-12-11 13:43:41,370 - app.services.chat_thread_service - INFO - Deleting thread e5dd093a-7692-48c8-bba7-583bdae80393 (delete_checkpoint=True)
2025-12-11 13:43:41,395 - app.services.chat_thread_service - INFO - Deleted chat thread: e5dd093a-7692-48c8-bba7-583bdae80393 (messages and content blocks deleted via cascade)
2025-12-11 13:43:41,396 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:43:42,322 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:43:48,580 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:48,581 - app.services.chat_thread_service - INFO - Creating new chat thread: 13e4dc75-1e26-41a5-9021-a894aff04bb0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:48,583 - app.services.chat_thread_service - INFO - Created new chat thread: 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:48,602 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:43:48,603 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:48,684 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:48,684 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:43:48,690 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:48,690 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:43:48,690 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:48,690 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:43:48,691 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'ae7c0a51-60cd-4879-a923-7c63cf5c61db', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:43:48,691 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:43:48,691 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:43:48,695 - app.services.message_management_service - INFO - Generated message_id: 2bcff80c-15f9-442a-8fe4-bc5005a171b5 for thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:48,695 - app.services.message_management_service - INFO - Saving user message 2bcff80c-15f9-442a-8fe4-bc5005a171b5 to thread 13e4dc75-1e26-41a5-9021-a894aff04bb0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:48,700 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 2bcff80c-15f9-442a-8fe4-bc5005a171b5
2025-12-11 13:43:48,701 - app.services.message_management_service - INFO - Successfully saved user message 2bcff80c-15f9-442a-8fe4-bc5005a171b5 to thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:48,701 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 13e4dc75-1e26-41a5-9021-a894aff04bb0, message_id: 2bcff80c-15f9-442a-8fe4-bc5005a171b5
2025-12-11 13:43:48,702 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:49,377 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:43:50,160 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:43:50,438 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: ae7c0a51-60cd-4879-a923-7c63cf5c61db, checkpoint_id: 1f0d6976-cec5-6011-8003-d90099c3fb1d, content_blocks count: 1
2025-12-11 13:43:50,439 - app.services.message_management_service - INFO - Saving assistant message ae7c0a51-60cd-4879-a923-7c63cf5c61db to thread 13e4dc75-1e26-41a5-9021-a894aff04bb0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:50,441 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message ae7c0a51-60cd-4879-a923-7c63cf5c61db
2025-12-11 13:43:50,442 - app.services.message_management_service - INFO - Successfully saved assistant message ae7c0a51-60cd-4879-a923-7c63cf5c61db to thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:50,443 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 76 (UUID: ae7c0a51-60cd-4879-a923-7c63cf5c61db) for approval in thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:52,648 - app.repositories.message_content_repository - INFO - Updated block text_run--dc5b5184-961b-4755-8e8f-c8384f761124 with fields: ['needs_approval', 'message_status']
2025-12-11 13:43:52,648 - app.services.message_management_service - INFO - Updated block text_run--dc5b5184-961b-4755-8e8f-c8384f761124 status in message ae7c0a51-60cd-4879-a923-7c63cf5c61db: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 13:43:52,681 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:52,685 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:52,686 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:43:52,686 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:52,686 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:43:52,687 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '71344237-91f9-4d8d-8752-aa58bfae774f', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:43:52,687 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:43:52,687 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:43:52,692 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:52,701 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:43:53,003 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 13:43:53,020 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 13e4dc75-1e26-41a5-9021-a894aff04bb0: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[6].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 150, in <lambda>
    self.joiner_node = lambda state: self.joiner.execute(state)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/joiner_node.py", line 74, in execute
    decision = llm_with_structure.invoke(decision_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 3080, in invoke
    input_ = context.run(step.invoke, input_, config, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1119, in _stream
    _handle_openai_bad_request(e)
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1096, in _stream
    with context_manager as response:
  File "/usr/local/lib/python3.11/site-packages/openai/lib/streaming/chat/_completions.py", line 150, in __enter__
    raw_stream = self.__api_request()
                 ^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[6].role', 'code': None}}
During task with name 'joiner' and id 'c9df9ad9-a115-20d0-730d-98b447c27153'
2025-12-11 13:43:53,026 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 13e4dc75-1e26-41a5-9021-a894aff04bb0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 71344237-91f9-4d8d-8752-aa58bfae774f, checkpoint_id: 1f0d6976-e477-6c65-8007-b5e0584552dd, content_blocks count: 2
2025-12-11 13:43:53,026 - app.services.message_management_service - INFO - Saving assistant message 71344237-91f9-4d8d-8752-aa58bfae774f to thread 13e4dc75-1e26-41a5-9021-a894aff04bb0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:43:53,030 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message 71344237-91f9-4d8d-8752-aa58bfae774f
2025-12-11 13:43:53,031 - app.services.message_management_service - INFO - Successfully saved assistant message 71344237-91f9-4d8d-8752-aa58bfae774f to thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:53,031 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 77 (UUID: 71344237-91f9-4d8d-8752-aa58bfae774f) in thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:53,033 - app.repositories.messages_repository - ERROR - Error finding message 77 in thread 13e4dc75-1e26-41a5-9021-a894aff04bb0: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('13e4dc75-1e26-41a5-9021-a894aff04bb0', 77)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:43:53,034 - app.services.message_management_service - ERROR - Error finding message 77 in thread 13e4dc75-1e26-41a5-9021-a894aff04bb0: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('13e4dc75-1e26-41a5-9021-a894aff04bb0', 77)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 13:43:53,034 - app.services.message_management_service - ERROR - Error updating message 77 status: Message 77 not found in thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:43:53,034 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 13e4dc75-1e26-41a5-9021-a894aff04bb0: Message 77 not found in thread 13e4dc75-1e26-41a5-9021-a894aff04bb0
2025-12-11 13:52:37,990 - server - INFO - Shutting down Agent Backend API...
2025-12-11 13:52:37,990 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 13:52:37,991 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 13:52:37,996 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 13:52:37,997 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 13:52:41,731 - server - INFO - Logging configuration complete
2025-12-11 13:52:41,731 - server - INFO - Starting up Agent Backend API...
2025-12-11 13:52:41,763 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:52:41,787 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 13:52:41,797 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 13:52:42,266 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 13:52:42,266 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 13:52:42,266 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 13:52:42,267 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 13:59:33,854 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 13:59:37,060 - app.services.chat_thread_service - INFO - Deleting thread 13e4dc75-1e26-41a5-9021-a894aff04bb0 (delete_checkpoint=True)
2025-12-11 13:59:37,062 - app.services.chat_thread_service - INFO - Deleted chat thread: 13e4dc75-1e26-41a5-9021-a894aff04bb0 (messages and content blocks deleted via cascade)
2025-12-11 13:59:37,062 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 13:59:46,075 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:46,075 - app.services.chat_thread_service - INFO - Creating new chat thread: b93ec736-e680-4c72-9fd6-bcc47bafe44f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:46,078 - app.services.chat_thread_service - INFO - Created new chat thread: b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:46,080 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 13:59:46,081 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:46,156 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:46,156 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 13:59:46,178 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:46,178 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:59:46,179 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:46,179 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:59:46,180 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'a543b5a4-aeae-47ce-98f6-1ce1406b596b', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:59:46,180 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 13:59:46,180 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 13:59:46,183 - app.services.message_management_service - INFO - Generated message_id: 8e3ac918-ef0b-4d94-8af6-624a8506e8be for thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:46,183 - app.services.message_management_service - INFO - Saving user message 8e3ac918-ef0b-4d94-8af6-624a8506e8be to thread b93ec736-e680-4c72-9fd6-bcc47bafe44f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:46,188 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 8e3ac918-ef0b-4d94-8af6-624a8506e8be
2025-12-11 13:59:46,189 - app.services.message_management_service - INFO - Successfully saved user message 8e3ac918-ef0b-4d94-8af6-624a8506e8be to thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:46,189 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread b93ec736-e680-4c72-9fd6-bcc47bafe44f, message_id: 8e3ac918-ef0b-4d94-8af6-624a8506e8be
2025-12-11 13:59:46,190 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:54,224 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:59:54,954 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:59:55,404 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: a543b5a4-aeae-47ce-98f6-1ce1406b596b, checkpoint_id: 1f0d699a-c163-6839-8003-f17f4e99d404, content_blocks count: 1
2025-12-11 13:59:55,404 - app.services.message_management_service - INFO - Saving assistant message a543b5a4-aeae-47ce-98f6-1ce1406b596b to thread b93ec736-e680-4c72-9fd6-bcc47bafe44f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:55,407 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a543b5a4-aeae-47ce-98f6-1ce1406b596b
2025-12-11 13:59:55,408 - app.services.message_management_service - INFO - Successfully saved assistant message a543b5a4-aeae-47ce-98f6-1ce1406b596b to thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:55,408 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 79 (UUID: a543b5a4-aeae-47ce-98f6-1ce1406b596b) for approval in thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:57,775 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:57,783 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 13:59:57,784 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 13:59:57,784 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:57,784 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 13:59:57,784 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '700f963d-f9e2-44e2-9a81-1607444ed862', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 13:59:57,785 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 13:59:57,785 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 13:59:57,792 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 13:59:57,798 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 13:59:58,434 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 13:59:58,468 - app.repositories.message_content_repository - INFO - Updated block text_run--65806df4-d8e2-4590-83ac-baa88a591d1f with fields: ['needs_approval', 'message_status']
2025-12-11 13:59:58,468 - app.services.message_management_service - INFO - Updated block text_run--65806df4-d8e2-4590-83ac-baa88a591d1f status in message a543b5a4-aeae-47ce-98f6-1ce1406b596b: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 14:00:00,813 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:00:02,915 - app.agents.nodes.explainer_node - INFO - Generated explanation for step using sql_db_list_tables
2025-12-11 14:00:03,288 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 14:00:03,306 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread b93ec736-e680-4c72-9fd6-bcc47bafe44f: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[6].role', 'code': None}}
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 656, in invoke
    input = context.run(step.invoke, input, config, **kwargs)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 455, in agent_node
    response = llm_with_tools.invoke(all_messages)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/runnables/base.py", line 5495, in invoke
    return self.bound.invoke(
           ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 393, in invoke
    self.generate_prompt(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1019, in generate_prompt
    return self.generate(prompt_messages, stop=stop, callbacks=callbacks, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 837, in generate
    self._generate_with_cache(
  File "/usr/local/lib/python3.11/site-packages/langchain_core/language_models/chat_models.py", line 1074, in _generate_with_cache
    for chunk in self._stream(messages, stop=stop, **kwargs):
  File "/usr/local/lib/python3.11/site-packages/langchain_openai/chat_models/base.py", line 1093, in _stream
    response = self.client.create(**payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_utils/_utils.py", line 287, in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 1150, in create
    return self._post(
           ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1259, in post
    return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))
                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1047, in request
    raise self._make_status_error_from_response(err.response) from None
openai.BadRequestError: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[6].role', 'code': None}}
During task with name 'agent' and id 'f777edf9-12e7-3aa1-992f-a9a31ad1cf0b'
2025-12-11 14:00:03,311 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: b93ec736-e680-4c72-9fd6-bcc47bafe44f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 700f963d-f9e2-44e2-9a81-1607444ed862, checkpoint_id: 1f0d699b-091a-6f0a-8009-65612958c18e, content_blocks count: 2
2025-12-11 14:00:03,312 - app.services.message_management_service - INFO - Saving assistant message 700f963d-f9e2-44e2-9a81-1607444ed862 to thread b93ec736-e680-4c72-9fd6-bcc47bafe44f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:00:03,315 - app.repositories.message_content_repository - INFO - Inserted 2 content blocks for message 700f963d-f9e2-44e2-9a81-1607444ed862
2025-12-11 14:00:03,316 - app.services.message_management_service - INFO - Successfully saved assistant message 700f963d-f9e2-44e2-9a81-1607444ed862 to thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 14:00:03,317 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 80 (UUID: 700f963d-f9e2-44e2-9a81-1607444ed862) in thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 14:00:03,322 - app.repositories.messages_repository - ERROR - Error finding message 80 in thread b93ec736-e680-4c72-9fd6-bcc47bafe44f: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('b93ec736-e680-4c72-9fd6-bcc47bafe44f', 80)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 14:00:03,322 - app.services.message_management_service - ERROR - Error finding message 80 in thread b93ec736-e680-4c72-9fd6-bcc47bafe44f: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('b93ec736-e680-4c72-9fd6-bcc47bafe44f', 80)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 14:00:03,322 - app.services.message_management_service - ERROR - Error updating message 80 status: Message 80 not found in thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 14:00:03,323 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread b93ec736-e680-4c72-9fd6-bcc47bafe44f: Message 80 not found in thread b93ec736-e680-4c72-9fd6-bcc47bafe44f
2025-12-11 14:05:09,042 - server - INFO - Shutting down Agent Backend API...
2025-12-11 14:05:09,042 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 14:05:09,043 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 14:05:09,047 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 14:05:09,047 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 14:05:12,623 - server - INFO - Logging configuration complete
2025-12-11 14:05:12,624 - server - INFO - Starting up Agent Backend API...
2025-12-11 14:05:12,651 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 14:05:12,674 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 14:05:12,682 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 14:05:13,199 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 14:05:13,199 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 14:05:13,200 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 14:05:13,200 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 14:47:06,072 - server - INFO - Shutting down Agent Backend API...
2025-12-11 14:47:06,073 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 14:47:06,074 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 14:47:06,078 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 14:47:06,078 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 14:47:09,508 - server - INFO - Logging configuration complete
2025-12-11 14:47:09,508 - server - INFO - Starting up Agent Backend API...
2025-12-11 14:47:09,534 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 14:47:09,555 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 14:47:09,563 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 14:47:10,058 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 14:47:10,058 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 14:47:10,058 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 14:47:10,058 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 14:47:17,692 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 14:47:20,306 - app.services.chat_thread_service - INFO - Deleting thread b93ec736-e680-4c72-9fd6-bcc47bafe44f (delete_checkpoint=True)
2025-12-11 14:47:20,308 - app.services.chat_thread_service - INFO - Deleted chat thread: b93ec736-e680-4c72-9fd6-bcc47bafe44f (messages and content blocks deleted via cascade)
2025-12-11 14:47:20,309 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 14:47:23,232 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:23,232 - app.services.chat_thread_service - INFO - Creating new chat thread: 95704b22-26ea-4603-a1c8-c3b30560fa7d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:23,236 - app.services.chat_thread_service - INFO - Created new chat thread: 95704b22-26ea-4603-a1c8-c3b30560fa7d
2025-12-11 14:47:23,238 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 14:47:23,238 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 95704b22-26ea-4603-a1c8-c3b30560fa7d
2025-12-11 14:47:23,318 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 95704b22-26ea-4603-a1c8-c3b30560fa7d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:23,318 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 14:47:23,348 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 95704b22-26ea-4603-a1c8-c3b30560fa7d
2025-12-11 14:47:23,349 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 14:47:23,349 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 95704b22-26ea-4603-a1c8-c3b30560fa7d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:23,349 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 14:47:23,349 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '08a6bb14-4f50-40cc-b9ce-c77cf8c0b0c6', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 14:47:23,350 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 14:47:23,350 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 95704b22-26ea-4603-a1c8-c3b30560fa7d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 14:47:23,353 - app.services.message_management_service - INFO - Generated message_id: 8c806df7-a1c3-4c2b-99fe-e6abcf83a585 for thread 95704b22-26ea-4603-a1c8-c3b30560fa7d
2025-12-11 14:47:23,353 - app.services.message_management_service - INFO - Saving user message 8c806df7-a1c3-4c2b-99fe-e6abcf83a585 to thread 95704b22-26ea-4603-a1c8-c3b30560fa7d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:23,358 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 8c806df7-a1c3-4c2b-99fe-e6abcf83a585
2025-12-11 14:47:23,359 - app.services.message_management_service - INFO - Successfully saved user message 8c806df7-a1c3-4c2b-99fe-e6abcf83a585 to thread 95704b22-26ea-4603-a1c8-c3b30560fa7d
2025-12-11 14:47:23,359 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 95704b22-26ea-4603-a1c8-c3b30560fa7d, message_id: 8c806df7-a1c3-4c2b-99fe-e6abcf83a585
2025-12-11 14:47:23,360 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 95704b22-26ea-4603-a1c8-c3b30560fa7d, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:24,827 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:47:26,016 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:47:27,263 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:47:27,502 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_DduLGcZYsW3DIzUd4VYarC7s')]}
2025-12-11 14:47:28,775 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:47:30,087 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 95704b22-26ea-4603-a1c8-c3b30560fa7d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 08a6bb14-4f50-40cc-b9ce-c77cf8c0b0c6, checkpoint_id: 1f0d6a05-19c5-6441-8006-be2790d22e9d, content_blocks count: 3
2025-12-11 14:47:30,087 - app.services.message_management_service - INFO - Saving assistant message 08a6bb14-4f50-40cc-b9ce-c77cf8c0b0c6 to thread 95704b22-26ea-4603-a1c8-c3b30560fa7d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:30,091 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 08a6bb14-4f50-40cc-b9ce-c77cf8c0b0c6
2025-12-11 14:47:30,093 - app.services.message_management_service - INFO - Successfully saved assistant message 08a6bb14-4f50-40cc-b9ce-c77cf8c0b0c6 to thread 95704b22-26ea-4603-a1c8-c3b30560fa7d
2025-12-11 14:47:30,093 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 82 (UUID: 08a6bb14-4f50-40cc-b9ce-c77cf8c0b0c6) in thread 95704b22-26ea-4603-a1c8-c3b30560fa7d
2025-12-11 14:47:36,439 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 14:47:41,608 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:41,608 - app.services.chat_thread_service - INFO - Creating new chat thread: 7fc039a0-bd81-4082-b511-eef1285e994d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:41,610 - app.services.chat_thread_service - INFO - Created new chat thread: 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:41,612 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 14:47:41,612 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:41,684 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:41,684 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 14:47:41,688 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:41,689 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 14:47:41,689 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:41,689 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 14:47:41,689 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '9c232883-4bbd-44cc-a1bb-39ed105c3758', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 14:47:41,690 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 14:47:41,690 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 14:47:41,692 - app.services.message_management_service - INFO - Generated message_id: 593acd03-d06e-463a-9d7d-9bfa931fc767 for thread 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:41,693 - app.services.message_management_service - INFO - Saving user message 593acd03-d06e-463a-9d7d-9bfa931fc767 to thread 7fc039a0-bd81-4082-b511-eef1285e994d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:41,695 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 593acd03-d06e-463a-9d7d-9bfa931fc767
2025-12-11 14:47:41,696 - app.services.message_management_service - INFO - Successfully saved user message 593acd03-d06e-463a-9d7d-9bfa931fc767 to thread 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:41,696 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 7fc039a0-bd81-4082-b511-eef1285e994d, message_id: 593acd03-d06e-463a-9d7d-9bfa931fc767
2025-12-11 14:47:41,697 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:42,896 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:47:43,728 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:47:43,948 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 9c232883-4bbd-44cc-a1bb-39ed105c3758, checkpoint_id: 1f0d6a05-9df2-65ff-8003-12fbcb78a960, content_blocks count: 1
2025-12-11 14:47:43,948 - app.services.message_management_service - INFO - Saving assistant message 9c232883-4bbd-44cc-a1bb-39ed105c3758 to thread 7fc039a0-bd81-4082-b511-eef1285e994d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:43,950 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 9c232883-4bbd-44cc-a1bb-39ed105c3758
2025-12-11 14:47:43,951 - app.services.message_management_service - INFO - Successfully saved assistant message 9c232883-4bbd-44cc-a1bb-39ed105c3758 to thread 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:43,952 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 84 (UUID: 9c232883-4bbd-44cc-a1bb-39ed105c3758) for approval in thread 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:45,503 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:45,508 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:45,508 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 14:47:45,508 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:45,509 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 14:47:45,509 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'e7f6588a-c11d-4147-8d56-e0c9d0b149fb', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 14:47:45,509 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 14:47:45,509 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 14:47:45,515 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:45,523 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 14:47:45,525 - app.repositories.message_content_repository - INFO - Updated block text_run--f81a450b-1d3c-4abd-94b7-3ac8768d1f8e with fields: ['needs_approval', 'message_status']
2025-12-11 14:47:45,526 - app.services.message_management_service - INFO - Updated block text_run--f81a450b-1d3c-4abd-94b7-3ac8768d1f8e status in message 9c232883-4bbd-44cc-a1bb-39ed105c3758: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 14:47:47,758 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:47:49,651 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: e7f6588a-c11d-4147-8d56-e0c9d0b149fb, checkpoint_id: 1f0d6a05-d459-6eb5-8008-f35e66ec1031, content_blocks count: 3
2025-12-11 14:47:49,651 - app.services.message_management_service - INFO - Saving assistant message e7f6588a-c11d-4147-8d56-e0c9d0b149fb to thread 7fc039a0-bd81-4082-b511-eef1285e994d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:47:49,654 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message e7f6588a-c11d-4147-8d56-e0c9d0b149fb
2025-12-11 14:47:49,655 - app.services.message_management_service - INFO - Successfully saved assistant message e7f6588a-c11d-4147-8d56-e0c9d0b149fb to thread 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:47:49,655 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 85 (UUID: e7f6588a-c11d-4147-8d56-e0c9d0b149fb) in thread 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:49:26,934 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 14:49:30,977 - app.services.chat_thread_service - INFO - Deleting thread 95704b22-26ea-4603-a1c8-c3b30560fa7d (delete_checkpoint=True)
2025-12-11 14:49:30,979 - app.services.chat_thread_service - INFO - Deleted chat thread: 95704b22-26ea-4603-a1c8-c3b30560fa7d (messages and content blocks deleted via cascade)
2025-12-11 14:49:30,979 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 14:49:32,610 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 14:49:33,683 - app.api.v1.endpoints.graph - INFO - Fetching explorer data for thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, checkpoint_id: 1f0d6a05-d459-6eb5-8008-f35e66ec1031
2025-12-11 14:49:33,683 - app.services.agent_service - INFO - Getting explorer data for thread_id: 7fc039a0-bd81-4082-b511-eef1285e994d, checkpoint_id: 1f0d6a05-d459-6eb5-8008-f35e66ec1031
2025-12-11 14:49:33,685 - app.services.agent_service - INFO - Successfully built explorer data with 1 steps
2025-12-11 14:50:15,710 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check what schema of albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:15,711 - app.services.chat_thread_service - INFO - Creating new chat thread: 70b9aaac-0e11-44a2-9192-d3a1738b20ee with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:15,712 - app.services.chat_thread_service - INFO - Created new chat thread: 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:15,714 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 14:50:15,714 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:15,786 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:15,786 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check what schema of albums table', use_planning: True, use_explainer: False
2025-12-11 14:50:15,791 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:15,791 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 14:50:15,791 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:15,792 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 14:50:15,792 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check what schema of albums table', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '76e2c9e3-2e28-4fa2-9ba6-33d835a5581c', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 14:50:15,792 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check what schema of albums table'
2025-12-11 14:50:15,792 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check what schema of albums table'
2025-12-11 14:50:15,794 - app.services.message_management_service - INFO - Generated message_id: e62c9c5e-6274-4daf-b404-76dfdb2d1a05 for thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:15,794 - app.services.message_management_service - INFO - Saving user message e62c9c5e-6274-4daf-b404-76dfdb2d1a05 to thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:15,796 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message e62c9c5e-6274-4daf-b404-76dfdb2d1a05
2025-12-11 14:50:15,797 - app.services.message_management_service - INFO - Successfully saved user message e62c9c5e-6274-4daf-b404-76dfdb2d1a05 to thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:15,797 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee, message_id: e62c9c5e-6274-4daf-b404-76dfdb2d1a05
2025-12-11 14:50:15,798 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:16,859 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:50:18,152 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 14:50:18,610 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 76e2c9e3-2e28-4fa2-9ba6-33d835a5581c, checkpoint_id: 1f0d6a0b-60e6-6e9a-8003-5482669c59fc, content_blocks count: 1
2025-12-11 14:50:18,610 - app.services.message_management_service - INFO - Saving assistant message 76e2c9e3-2e28-4fa2-9ba6-33d835a5581c to thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:18,612 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 76e2c9e3-2e28-4fa2-9ba6-33d835a5581c
2025-12-11 14:50:18,614 - app.services.message_management_service - INFO - Successfully saved assistant message 76e2c9e3-2e28-4fa2-9ba6-33d835a5581c to thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:18,614 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 87 (UUID: 76e2c9e3-2e28-4fa2-9ba6-33d835a5581c) for approval in thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:22,082 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:22,089 - app.repositories.message_content_repository - INFO - Updated block text_run--00fa14f9-fb15-4b24-9b26-3d9f04b05a23 with fields: ['needs_approval', 'message_status']
2025-12-11 14:50:22,089 - app.services.message_management_service - INFO - Updated block text_run--00fa14f9-fb15-4b24-9b26-3d9f04b05a23 status in message 76e2c9e3-2e28-4fa2-9ba6-33d835a5581c: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 14:50:22,091 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 14:50:22,091 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 14:50:22,091 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:22,092 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 14:50:22,092 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 14:50:22,092 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 14:50:22,093 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 14:50:22,097 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:22,104 - app.agents.nodes.task_parser_node - INFO - Parsed 2 tasks from plan
2025-12-11 14:50:22,116 - app.agents.nodes.task_executor_node - ERROR - Task 2 failed: 1 validation error for _InfoSQLDatabaseToolInput
table_names
  Field required [type=missing, input_value={'_description': 'Examine...a of the albums table.'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.11/v/missing
2025-12-11 14:50:22,123 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee: At key 'observations': Can receive only one value per step. Use an Annotated key to handle multiple values.
For troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2689, in stream
    loop.after_tick()
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_loop.py", line 523, in after_tick
    self.updated_channels = apply_writes(
                            ^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_algo.py", line 293, in apply_writes
    if channels[chan].update(vals) and next_version is not None:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/channels/last_value.py", line 64, in update
    raise InvalidUpdateError(msg)
langgraph.errors.InvalidUpdateError: At key 'observations': Can receive only one value per step. Use an Annotated key to handle multiple values.
For troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE
2025-12-11 14:50:22,127 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 70b9aaac-0e11-44a2-9192-d3a1738b20ee, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 5a9d105a-ba07-4521-b478-f1e6431f2e8a, checkpoint_id: None, content_blocks count: 2
2025-12-11 14:50:22,127 - app.services.message_management_service - INFO - Saving assistant message 5a9d105a-ba07-4521-b478-f1e6431f2e8a to thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 14:50:22,134 - app.repositories.message_content_repository - ERROR - Error adding content blocks for message 5a9d105a-ba07-4521-b478-f1e6431f2e8a: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 280 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'tool_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129158), '5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'error_5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'text', False, None, '{"text": "Error: At key \'observations\': Can receive only one value per step. Use an Annotated key to handle multiple values.\\nFor troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE"}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129191))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 14:50:22,134 - app.services.message_management_service - ERROR - Failed to save content blocks for message 5a9d105a-ba07-4521-b478-f1e6431f2e8a: Failed to add content blocks: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 280 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'tool_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129158), '5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'error_5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'text', False, None, '{"text": "Error: At key \'observations\': Can receive only one value per step. Use an Annotated key to handle multiple values.\\nFor troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE"}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129191))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 14:50:22,134 - app.services.message_management_service - ERROR - Failed to rollback message 5a9d105a-ba07-4521-b478-f1e6431f2e8a: 'MessagesRepository' object has no attribute 'delete_message_by_id'
2025-12-11 14:50:22,134 - app.services.message_management_service - ERROR - Error saving assistant message to thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee: Failed to save content blocks for assistant message: Failed to add content blocks: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 280 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'tool_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129158), '5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'error_5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'text', False, None, '{"text": "Error: At key \'observations\': Can receive only one value per step. Use an Annotated key to handle multiple values.\\nFor troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE"}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129191))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 14:50:22,135 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee: Failed to save content blocks for assistant message: Failed to add content blocks: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 280 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'tool_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129158), '5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'error_5a9d105a-ba07-4521-b478-f1e6431f2e8a', 'text', False, None, '{"text": "Error: At key \'observations\': Can receive only one value per step. Use an Annotated key to handle multiple values.\\nFor troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE"}', datetime.datetime(2025, 12, 11, 14, 50, 22, 129191))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 15:40:38,036 - server - INFO - Shutting down Agent Backend API...
2025-12-11 15:40:38,036 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 15:40:38,037 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 15:40:38,040 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 15:40:38,041 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 15:40:41,546 - server - INFO - Logging configuration complete
2025-12-11 15:40:41,547 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:40:41,578 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:40:41,602 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:40:41,611 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:40:43,072 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:40:43,073 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:40:43,073 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:40:43,073 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 15:40:45,486 - server - INFO - Logging configuration complete
2025-12-11 15:40:45,487 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:40:45,504 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:40:45,526 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:40:45,534 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:40:45,914 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:40:45,914 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:40:45,914 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:40:45,914 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 15:45:06,577 - server - INFO - Shutting down Agent Backend API...
2025-12-11 15:45:06,577 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 15:45:06,578 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 15:45:06,583 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 15:45:06,583 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 15:52:18,878 - server - INFO - Logging configuration complete
2025-12-11 15:52:18,879 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:52:18,908 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:52:18,935 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:52:18,946 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:52:19,413 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:52:19,414 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:52:19,414 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:52:19,414 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 15:52:21,320 - server - INFO - Shutting down Agent Backend API...
2025-12-11 15:52:21,320 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 15:52:21,321 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 15:52:21,324 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 15:52:21,325 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 15:52:23,735 - server - INFO - Logging configuration complete
2025-12-11 15:52:23,735 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:52:23,754 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:52:23,778 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:52:23,789 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:52:24,131 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:52:24,131 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:52:24,132 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:52:24,132 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 15:52:28,497 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 15:52:30,255 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 70b9aaac-0e11-44a2-9192-d3a1738b20ee
2025-12-11 15:52:30,272 - app.services.agent_service - ERROR - Failed to get current state for 70b9aaac-0e11-44a2-9192-d3a1738b20ee: At key 'observations': Can receive only one value per step. Use an Annotated key to handle multiple values.
For troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE
2025-12-11 15:52:38,593 - app.services.chat_thread_service - INFO - Deleting thread 70b9aaac-0e11-44a2-9192-d3a1738b20ee (delete_checkpoint=True)
2025-12-11 15:52:38,596 - app.services.chat_thread_service - INFO - Deleted chat thread: 70b9aaac-0e11-44a2-9192-d3a1738b20ee (messages and content blocks deleted via cascade)
2025-12-11 15:52:38,596 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 15:52:44,467 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check what schema of albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:44,467 - app.services.chat_thread_service - INFO - Creating new chat thread: 24562033-3c17-40ce-aed1-7327e4ba9952 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:44,470 - app.services.chat_thread_service - INFO - Created new chat thread: 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:44,472 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 15:52:44,472 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:44,554 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:44,554 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check what schema of albums table', use_planning: True, use_explainer: False
2025-12-11 15:52:44,572 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:44,572 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 15:52:44,573 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:44,573 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 15:52:44,574 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check what schema of albums table', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'ff3e03b5-33e0-403e-90d8-6a9930f0e741', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 15:52:44,574 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check what schema of albums table'
2025-12-11 15:52:44,574 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check what schema of albums table'
2025-12-11 15:52:44,577 - app.services.message_management_service - INFO - Generated message_id: 3437bc49-c68a-4abb-a058-58f46db71eaf for thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:44,577 - app.services.message_management_service - INFO - Saving user message 3437bc49-c68a-4abb-a058-58f46db71eaf to thread 24562033-3c17-40ce-aed1-7327e4ba9952 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:44,582 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 3437bc49-c68a-4abb-a058-58f46db71eaf
2025-12-11 15:52:44,583 - app.services.message_management_service - INFO - Successfully saved user message 3437bc49-c68a-4abb-a058-58f46db71eaf to thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:44,583 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 24562033-3c17-40ce-aed1-7327e4ba9952, message_id: 3437bc49-c68a-4abb-a058-58f46db71eaf
2025-12-11 15:52:44,583 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:46,140 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 15:52:48,070 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 15:52:48,759 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: ff3e03b5-33e0-403e-90d8-6a9930f0e741, checkpoint_id: 1f0d6a97-1524-6bba-8003-8e2d0c247c15, content_blocks count: 1
2025-12-11 15:52:48,759 - app.services.message_management_service - INFO - Saving assistant message ff3e03b5-33e0-403e-90d8-6a9930f0e741 to thread 24562033-3c17-40ce-aed1-7327e4ba9952 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:48,762 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message ff3e03b5-33e0-403e-90d8-6a9930f0e741
2025-12-11 15:52:48,763 - app.services.message_management_service - INFO - Successfully saved assistant message ff3e03b5-33e0-403e-90d8-6a9930f0e741 to thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:48,764 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 90 (UUID: ff3e03b5-33e0-403e-90d8-6a9930f0e741) for approval in thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:53,254 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:53,264 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:53,264 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 15:52:53,264 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:53,265 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 15:52:53,265 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'bbb927be-06da-43b9-bc25-fd1ba6bf968c', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 15:52:53,265 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 15:52:53,265 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 15:52:53,271 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:54,340 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 15:52:54,448 - app.repositories.message_content_repository - INFO - Updated block text_run--59f679b8-fcac-4aed-92c7-b85b53134a42 with fields: ['needs_approval', 'message_status']
2025-12-11 15:52:54,448 - app.services.message_management_service - INFO - Updated block text_run--59f679b8-fcac-4aed-92c7-b85b53134a42 status in message ff3e03b5-33e0-403e-90d8-6a9930f0e741: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 15:52:54,456 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_list_tables: {'tool_input': ''}
2025-12-11 15:52:55,505 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 15:52:55,656 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_schema: {'table_names': 'albums'}
2025-12-11 15:52:55,656 - app.agents.nodes.task_parser_node - INFO - Parsed 2 tasks from plan
2025-12-11 15:52:55,657 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0, 2: 0}
2025-12-11 15:52:55,657 - app.agents.nodes.task_scheduler_node - INFO - Executing 2 independent tasks in parallel
2025-12-11 15:52:57,294 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 15:52:57,342 - app.agents.nodes.task_executor_node - INFO - Task 2 (sql_db_schema) is now executable
2025-12-11 15:52:57,344 - app.agents.data_exploration_agent - INFO - No more tasks, going to joiner
2025-12-11 15:52:57,348 - app.agents.nodes.task_executor_node - INFO - Task 1 (sql_db_list_tables) is now executable
2025-12-11 15:52:57,350 - app.agents.data_exploration_agent - INFO - No more tasks, going to joiner
2025-12-11 15:52:57,359 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 24562033-3c17-40ce-aed1-7327e4ba9952: At key 'observations': Can receive only one value per step. Use an Annotated key to handle multiple values.
For troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2689, in stream
    loop.after_tick()
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_loop.py", line 523, in after_tick
    self.updated_channels = apply_writes(
                            ^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_algo.py", line 293, in apply_writes
    if channels[chan].update(vals) and next_version is not None:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/channels/last_value.py", line 64, in update
    raise InvalidUpdateError(msg)
langgraph.errors.InvalidUpdateError: At key 'observations': Can receive only one value per step. Use an Annotated key to handle multiple values.
For troubleshooting, visit: https://python.langchain.com/docs/troubleshooting/errors/INVALID_CONCURRENT_GRAPH_UPDATE
2025-12-11 15:52:57,364 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 24562033-3c17-40ce-aed1-7327e4ba9952, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: bbb927be-06da-43b9-bc25-fd1ba6bf968c, checkpoint_id: None, content_blocks count: 3
2025-12-11 15:52:57,365 - app.services.message_management_service - INFO - Saving assistant message bbb927be-06da-43b9-bc25-fd1ba6bf968c to thread 24562033-3c17-40ce-aed1-7327e4ba9952 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 15:52:57,371 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message bbb927be-06da-43b9-bc25-fd1ba6bf968c
2025-12-11 15:52:57,372 - app.services.message_management_service - INFO - Successfully saved assistant message bbb927be-06da-43b9-bc25-fd1ba6bf968c to thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:57,373 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 91 (UUID: bbb927be-06da-43b9-bc25-fd1ba6bf968c) in thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:57,377 - app.repositories.messages_repository - ERROR - Error finding message 91 in thread 24562033-3c17-40ce-aed1-7327e4ba9952: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('24562033-3c17-40ce-aed1-7327e4ba9952', 91)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 15:52:57,378 - app.services.message_management_service - ERROR - Error finding message 91 in thread 24562033-3c17-40ce-aed1-7327e4ba9952: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('24562033-3c17-40ce-aed1-7327e4ba9952', 91)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 15:52:57,378 - app.services.message_management_service - ERROR - Error updating message 91 status: Message 91 not found in thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:52:57,378 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 24562033-3c17-40ce-aed1-7327e4ba9952: Message 91 not found in thread 24562033-3c17-40ce-aed1-7327e4ba9952
2025-12-11 15:58:26,994 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 15:58:32,648 - app.services.chat_thread_service - INFO - Deleting thread 24562033-3c17-40ce-aed1-7327e4ba9952 (delete_checkpoint=True)
2025-12-11 15:58:32,650 - app.services.chat_thread_service - INFO - Deleted chat thread: 24562033-3c17-40ce-aed1-7327e4ba9952 (messages and content blocks deleted via cascade)
2025-12-11 15:58:32,650 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 15:58:34,033 - server - INFO - Shutting down Agent Backend API...
2025-12-11 15:58:34,033 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 15:58:34,034 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 15:58:34,047 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 15:58:34,048 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 15:58:37,679 - server - INFO - Logging configuration complete
2025-12-11 15:58:37,679 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:58:37,711 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:58:37,735 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:58:37,744 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:58:38,208 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:58:38,208 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:58:38,208 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:58:38,209 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 15:58:56,249 - server - INFO - Shutting down Agent Backend API...
2025-12-11 15:58:56,249 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 15:58:56,250 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 15:58:56,253 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 15:58:56,253 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 15:58:58,749 - server - INFO - Logging configuration complete
2025-12-11 15:58:58,749 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:58:58,767 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:58:58,791 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:58:58,802 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:58:59,163 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:58:59,163 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:58:59,164 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:58:59,164 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 15:59:37,646 - server - INFO - Shutting down Agent Backend API...
2025-12-11 15:59:37,647 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 15:59:37,648 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 15:59:37,651 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 15:59:37,651 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 15:59:40,356 - server - INFO - Logging configuration complete
2025-12-11 15:59:40,356 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:59:40,375 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:59:40,400 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:59:40,410 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:59:42,306 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:59:42,306 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:59:42,306 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:59:42,307 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 15:59:44,844 - server - INFO - Logging configuration complete
2025-12-11 15:59:44,845 - server - INFO - Starting up Agent Backend API...
2025-12-11 15:59:44,862 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:59:44,887 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 15:59:44,896 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 15:59:45,507 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 15:59:45,507 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 15:59:45,508 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 15:59:45,508 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:00:30,128 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 7fc039a0-bd81-4082-b511-eef1285e994d
2025-12-11 16:00:46,977 - app.services.chat_thread_service - INFO - Deleting thread 7fc039a0-bd81-4082-b511-eef1285e994d (delete_checkpoint=True)
2025-12-11 16:00:46,981 - app.services.chat_thread_service - INFO - Deleted chat thread: 7fc039a0-bd81-4082-b511-eef1285e994d (messages and content blocks deleted via cascade)
2025-12-11 16:00:46,981 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:00:50,843 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:00:50,843 - app.services.chat_thread_service - INFO - Creating new chat thread: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:00:50,846 - app.services.chat_thread_service - INFO - Created new chat thread: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3
2025-12-11 16:00:50,850 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:00:50,850 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3
2025-12-11 16:00:50,930 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:00:50,930 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: False, use_explainer: False
2025-12-11 16:00:50,947 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3
2025-12-11 16:00:50,948 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:00:50,948 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:00:50,949 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:00:50,949 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '6fafb580-0b2c-4b6a-aa43-0679df3c3f66', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:00:50,949 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 16:00:50,950 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 16:00:50,952 - app.services.message_management_service - INFO - Generated message_id: 0dc5376f-1008-468e-b4a1-1d2d9e837017 for thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3
2025-12-11 16:00:50,953 - app.services.message_management_service - INFO - Saving user message 0dc5376f-1008-468e-b4a1-1d2d9e837017 to thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:00:50,958 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 0dc5376f-1008-468e-b4a1-1d2d9e837017
2025-12-11 16:00:50,959 - app.services.message_management_service - INFO - Successfully saved user message 0dc5376f-1008-468e-b4a1-1d2d9e837017 to thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3
2025-12-11 16:00:50,960 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3, message_id: 0dc5376f-1008-468e-b4a1-1d2d9e837017
2025-12-11 16:00:50,960 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:00:51,834 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:00:53,581 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:00:54,915 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:00:55,235 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_SMi5GMDei8W1umjLQXx3Yk59')]}
2025-12-11 16:00:55,904 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:00:57,676 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 6fafb580-0b2c-4b6a-aa43-0679df3c3f66, checkpoint_id: 1f0d6aa9-4bd0-62a3-8006-97772c1d5945, content_blocks count: 3
2025-12-11 16:00:57,676 - app.services.message_management_service - INFO - Saving assistant message 6fafb580-0b2c-4b6a-aa43-0679df3c3f66 to thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:00:57,681 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 6fafb580-0b2c-4b6a-aa43-0679df3c3f66
2025-12-11 16:00:57,683 - app.services.message_management_service - INFO - Successfully saved assistant message 6fafb580-0b2c-4b6a-aa43-0679df3c3f66 to thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3
2025-12-11 16:00:57,683 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 93 (UUID: 6fafb580-0b2c-4b6a-aa43-0679df3c3f66) in thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3
2025-12-11 16:01:01,159 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:01:03,721 - app.services.chat_thread_service - INFO - Deleting thread 84e871f0-5ebf-4f82-90e7-95125a4dbdd3 (delete_checkpoint=True)
2025-12-11 16:01:03,723 - app.services.chat_thread_service - INFO - Deleted chat thread: 84e871f0-5ebf-4f82-90e7-95125a4dbdd3 (messages and content blocks deleted via cascade)
2025-12-11 16:01:03,724 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:01:06,951 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:06,952 - app.services.chat_thread_service - INFO - Creating new chat thread: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:06,953 - app.services.chat_thread_service - INFO - Created new chat thread: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:06,956 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:01:06,956 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:07,031 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:07,031 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 16:01:07,036 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:07,037 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:01:07,037 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:07,037 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:01:07,038 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'ba6c3c98-6ac0-4a3d-926c-ce57bbdda9ff', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:01:07,038 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 16:01:07,038 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 16:01:07,041 - app.services.message_management_service - INFO - Generated message_id: 74fc4122-e673-4d5f-8eb6-11a177e322ae for thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:07,041 - app.services.message_management_service - INFO - Saving user message 74fc4122-e673-4d5f-8eb6-11a177e322ae to thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:07,043 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 74fc4122-e673-4d5f-8eb6-11a177e322ae
2025-12-11 16:01:07,044 - app.services.message_management_service - INFO - Successfully saved user message 74fc4122-e673-4d5f-8eb6-11a177e322ae to thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:07,045 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, message_id: 74fc4122-e673-4d5f-8eb6-11a177e322ae
2025-12-11 16:01:07,046 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:07,963 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:01:08,743 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:01:09,053 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: ba6c3c98-6ac0-4a3d-926c-ce57bbdda9ff, checkpoint_id: 1f0d6aa9-b853-6e05-8003-26298200c1cc, content_blocks count: 1
2025-12-11 16:01:09,053 - app.services.message_management_service - INFO - Saving assistant message ba6c3c98-6ac0-4a3d-926c-ce57bbdda9ff to thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:09,057 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message ba6c3c98-6ac0-4a3d-926c-ce57bbdda9ff
2025-12-11 16:01:09,058 - app.services.message_management_service - INFO - Successfully saved assistant message ba6c3c98-6ac0-4a3d-926c-ce57bbdda9ff to thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:09,058 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 95 (UUID: ba6c3c98-6ac0-4a3d-926c-ce57bbdda9ff) for approval in thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:11,006 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:11,013 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:11,013 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:01:11,014 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:11,014 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:01:11,014 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '4b3caf43-c416-4284-8760-46fe395d91fe', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:01:11,014 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 16:01:11,015 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 16:01:11,022 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:11,536 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:01:11,543 - app.repositories.message_content_repository - INFO - Updated block text_run--70891958-1dd1-4cdc-9657-6132bbd367e6 with fields: ['needs_approval', 'message_status']
2025-12-11 16:01:11,543 - app.services.message_management_service - INFO - Updated block text_run--70891958-1dd1-4cdc-9657-6132bbd367e6 status in message ba6c3c98-6ac0-4a3d-926c-ce57bbdda9ff: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 16:01:11,638 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_list_tables: {'tool_input': ''}
2025-12-11 16:01:11,639 - app.agents.nodes.task_parser_node - INFO - Parsed 1 tasks from plan
2025-12-11 16:01:11,640 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0}
2025-12-11 16:01:11,640 - app.agents.nodes.task_scheduler_node - INFO - Executing 1 independent tasks in parallel
2025-12-11 16:01:12,605 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:01:12,640 - app.agents.data_exploration_agent - INFO - No more tasks, going to joiner
2025-12-11 16:01:13,222 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:01:15,237 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 4b3caf43-c416-4284-8760-46fe395d91fe, checkpoint_id: 1f0d6aa9-f350-61d7-8008-886de821a297, content_blocks count: 3
2025-12-11 16:01:15,238 - app.services.message_management_service - INFO - Saving assistant message 4b3caf43-c416-4284-8760-46fe395d91fe to thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:15,241 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 4b3caf43-c416-4284-8760-46fe395d91fe
2025-12-11 16:01:15,242 - app.services.message_management_service - INFO - Successfully saved assistant message 4b3caf43-c416-4284-8760-46fe395d91fe to thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:15,242 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 96 (UUID: 4b3caf43-c416-4284-8760-46fe395d91fe) in thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:18,940 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:01:23,131 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:01:25,079 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 7f7d79b0-79b4-4a94-a421-99906ce0e6c0
2025-12-11 16:01:47,041 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'what table exist in database' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:47,042 - app.services.chat_thread_service - INFO - Creating new chat thread: b2d50127-602e-4355-9658-3a8aea5e06fb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:47,043 - app.services.chat_thread_service - INFO - Created new chat thread: b2d50127-602e-4355-9658-3a8aea5e06fb
2025-12-11 16:01:47,045 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:01:47,046 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: b2d50127-602e-4355-9658-3a8aea5e06fb
2025-12-11 16:01:47,117 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: b2d50127-602e-4355-9658-3a8aea5e06fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:47,118 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'what table exist in database', use_planning: True, use_explainer: False
2025-12-11 16:01:47,122 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: b2d50127-602e-4355-9658-3a8aea5e06fb
2025-12-11 16:01:47,123 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:01:47,123 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: b2d50127-602e-4355-9658-3a8aea5e06fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:47,123 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:01:47,124 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'what table exist in database', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'f9395342-5593-4533-8f6c-4fefdc057e8b', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:01:47,124 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'what table exist in database'
2025-12-11 16:01:47,124 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: b2d50127-602e-4355-9658-3a8aea5e06fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'what table exist in database'
2025-12-11 16:01:47,127 - app.services.message_management_service - INFO - Generated message_id: 5bbf4cca-b578-440d-bbe2-c44e4c2f7dd2 for thread b2d50127-602e-4355-9658-3a8aea5e06fb
2025-12-11 16:01:47,127 - app.services.message_management_service - INFO - Saving user message 5bbf4cca-b578-440d-bbe2-c44e4c2f7dd2 to thread b2d50127-602e-4355-9658-3a8aea5e06fb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:47,129 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 5bbf4cca-b578-440d-bbe2-c44e4c2f7dd2
2025-12-11 16:01:47,130 - app.services.message_management_service - INFO - Successfully saved user message 5bbf4cca-b578-440d-bbe2-c44e4c2f7dd2 to thread b2d50127-602e-4355-9658-3a8aea5e06fb
2025-12-11 16:01:47,131 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread b2d50127-602e-4355-9658-3a8aea5e06fb, message_id: 5bbf4cca-b578-440d-bbe2-c44e4c2f7dd2
2025-12-11 16:01:47,132 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: b2d50127-602e-4355-9658-3a8aea5e06fb, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:48,103 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:01:48,904 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:01:49,285 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: b2d50127-602e-4355-9658-3a8aea5e06fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: f9395342-5593-4533-8f6c-4fefdc057e8b, checkpoint_id: 1f0d6aab-3804-6416-8003-afbe5bcab0b7, content_blocks count: 1
2025-12-11 16:01:49,286 - app.services.message_management_service - INFO - Saving assistant message f9395342-5593-4533-8f6c-4fefdc057e8b to thread b2d50127-602e-4355-9658-3a8aea5e06fb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:01:49,288 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message f9395342-5593-4533-8f6c-4fefdc057e8b
2025-12-11 16:01:49,289 - app.services.message_management_service - INFO - Successfully saved assistant message f9395342-5593-4533-8f6c-4fefdc057e8b to thread b2d50127-602e-4355-9658-3a8aea5e06fb
2025-12-11 16:01:49,290 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 98 (UUID: f9395342-5593-4533-8f6c-4fefdc057e8b) for approval in thread b2d50127-602e-4355-9658-3a8aea5e06fb
2025-12-11 16:01:53,346 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:01:55,878 - app.services.chat_thread_service - INFO - Deleting thread b2d50127-602e-4355-9658-3a8aea5e06fb (delete_checkpoint=True)
2025-12-11 16:01:55,880 - app.services.chat_thread_service - INFO - Deleted chat thread: b2d50127-602e-4355-9658-3a8aea5e06fb (messages and content blocks deleted via cascade)
2025-12-11 16:01:55,880 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:02:09,531 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check schema for albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:09,532 - app.services.chat_thread_service - INFO - Creating new chat thread: 120ca539-93ab-4621-95b0-0a501119853c with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:09,533 - app.services.chat_thread_service - INFO - Created new chat thread: 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:09,535 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:02:09,535 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:09,607 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:09,608 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check schema for albums table', use_planning: True, use_explainer: False
2025-12-11 16:02:09,613 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:09,613 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:02:09,613 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:09,614 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:02:09,614 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check schema for albums table', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '97948d40-61b5-460f-bd79-1224ab7baffd', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:02:09,614 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check schema for albums table'
2025-12-11 16:02:09,615 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check schema for albums table'
2025-12-11 16:02:09,617 - app.services.message_management_service - INFO - Generated message_id: 5ac554ee-eabc-4912-a9db-bcad76c84dc4 for thread 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:09,617 - app.services.message_management_service - INFO - Saving user message 5ac554ee-eabc-4912-a9db-bcad76c84dc4 to thread 120ca539-93ab-4621-95b0-0a501119853c with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:09,620 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 5ac554ee-eabc-4912-a9db-bcad76c84dc4
2025-12-11 16:02:09,621 - app.services.message_management_service - INFO - Successfully saved user message 5ac554ee-eabc-4912-a9db-bcad76c84dc4 to thread 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:09,621 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 120ca539-93ab-4621-95b0-0a501119853c, message_id: 5ac554ee-eabc-4912-a9db-bcad76c84dc4
2025-12-11 16:02:09,622 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:10,529 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:02:11,345 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:02:11,857 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 97948d40-61b5-460f-bd79-1224ab7baffd, checkpoint_id: 1f0d6aac-0f43-656e-8003-62e7ca9a49f3, content_blocks count: 1
2025-12-11 16:02:11,858 - app.services.message_management_service - INFO - Saving assistant message 97948d40-61b5-460f-bd79-1224ab7baffd to thread 120ca539-93ab-4621-95b0-0a501119853c with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:11,860 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 97948d40-61b5-460f-bd79-1224ab7baffd
2025-12-11 16:02:11,861 - app.services.message_management_service - INFO - Successfully saved assistant message 97948d40-61b5-460f-bd79-1224ab7baffd to thread 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:11,861 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 100 (UUID: 97948d40-61b5-460f-bd79-1224ab7baffd) for approval in thread 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:17,728 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:17,735 - app.repositories.message_content_repository - INFO - Updated block text_run--73035234-3833-4465-934e-05b2fa58164c with fields: ['needs_approval', 'message_status']
2025-12-11 16:02:17,735 - app.services.message_management_service - INFO - Updated block text_run--73035234-3833-4465-934e-05b2fa58164c status in message 97948d40-61b5-460f-bd79-1224ab7baffd: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 16:02:17,737 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 120ca539-93ab-4621-95b0-0a501119853c
2025-12-11 16:02:17,737 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:02:17,738 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:17,738 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:02:17,738 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:02:17,739 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 16:02:17,739 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 16:02:17,772 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:18,439 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:02:18,735 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_list_tables: {'tool_input': ''}
2025-12-11 16:02:19,148 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:02:19,222 - app.agents.nodes.task_parser_node - INFO - Task 2 dependencies: [1]
2025-12-11 16:02:19,739 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:02:19,854 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_schema: {'table_names': 'albums'}
2025-12-11 16:02:19,855 - app.agents.nodes.task_parser_node - INFO - Parsed 2 tasks from plan
2025-12-11 16:02:19,856 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0, 2: 1}
2025-12-11 16:02:19,856 - app.agents.nodes.task_scheduler_node - INFO - Executing 1 independent tasks in parallel
2025-12-11 16:02:20,635 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:02:20,685 - app.agents.nodes.task_executor_node - INFO - Task 2 (sql_db_schema) is now executable
2025-12-11 16:02:20,686 - app.agents.data_exploration_agent - INFO - No more tasks, going to joiner
2025-12-11 16:02:23,944 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:02:26,009 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 16:02:26,016 - app.agents.nodes.planner_node - ERROR - Error in initial planning: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[7].role', 'code': None}}
2025-12-11 16:02:26,023 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 120ca539-93ab-4621-95b0-0a501119853c, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa, checkpoint_id: 1f0d6aac-9660-6e05-8009-28de7d6ab567, content_blocks count: 3
2025-12-11 16:02:26,023 - app.services.message_management_service - INFO - Saving assistant message 6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa to thread 120ca539-93ab-4621-95b0-0a501119853c with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:02:26,027 - app.repositories.message_content_repository - ERROR - Error adding content blocks for message 6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_call_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 410 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'tool_call_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25746), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'text_run--af4e232e-5376-47f7-a4f9-ff4ac6b6f932', 'text', True, None, '{"text": "Simple plan: Analyze the query \'check schema for albums table\' using available database tools like sql_db_list_tables, sql_db_schema, and sql_db_to_df."}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25775), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'explorer_1f0d6aac-9660-6e05-8009-28de7d6ab567', 'explorer', True, None, '{"checkpointId": "1f0d6aac-9660-6e05-8009-28de7d6ab567"}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25786))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 16:02:26,028 - app.services.message_management_service - ERROR - Failed to save content blocks for message 6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa: Failed to add content blocks: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_call_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 410 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'tool_call_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25746), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'text_run--af4e232e-5376-47f7-a4f9-ff4ac6b6f932', 'text', True, None, '{"text": "Simple plan: Analyze the query \'check schema for albums table\' using available database tools like sql_db_list_tables, sql_db_schema, and sql_db_to_df."}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25775), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'explorer_1f0d6aac-9660-6e05-8009-28de7d6ab567', 'explorer', True, None, '{"checkpointId": "1f0d6aac-9660-6e05-8009-28de7d6ab567"}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25786))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 16:02:26,028 - app.services.message_management_service - ERROR - Failed to rollback message 6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa: 'MessagesRepository' object has no attribute 'delete_message_by_id'
2025-12-11 16:02:26,028 - app.services.message_management_service - ERROR - Error saving assistant message to thread 120ca539-93ab-4621-95b0-0a501119853c: Failed to save content blocks for assistant message: Failed to add content blocks: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_call_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 410 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'tool_call_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25746), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'text_run--af4e232e-5376-47f7-a4f9-ff4ac6b6f932', 'text', True, None, '{"text": "Simple plan: Analyze the query \'check schema for albums table\' using available database tools like sql_db_list_tables, sql_db_schema, and sql_db_to_df."}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25775), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'explorer_1f0d6aac-9660-6e05-8009-28de7d6ab567', 'explorer', True, None, '{"checkpointId": "1f0d6aac-9660-6e05-8009-28de7d6ab567"}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25786))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 16:02:26,029 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to save assistant message for approval in thread 120ca539-93ab-4621-95b0-0a501119853c: Failed to save content blocks for assistant message: Failed to add content blocks: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.UniqueViolationError'>: duplicate key value violates unique constraint "ix_message_content_block_id"
DETAIL:  Key (block_id)=(tool_call_task_1) already exists.
[SQL: INSERT INTO message_content (chat_message_id, block_id, type, needs_approval, message_status, data, created_at) SELECT p0::VARCHAR, p1::VARCHAR, p2::VARCHAR, p3::BOOLEAN, p4::message_status_enum, p5::JSONB, p6::TIMESTAMP WITH TIME ZONE FROM (VALUES ( ... 410 characters truncated ...  p5, p6, sen_counter) ORDER BY sen_counter RETURNING message_content.id, message_content.id AS id__1]
[parameters: ('6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'tool_call_task_1', 'tool_calls', False, None, '{"toolCalls": [{"name": "unknown", "input": {}, "output": "albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks", "status": "approved"}], "content": null}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25746), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'text_run--af4e232e-5376-47f7-a4f9-ff4ac6b6f932', 'text', True, None, '{"text": "Simple plan: Analyze the query \'check schema for albums table\' using available database tools like sql_db_list_tables, sql_db_schema, and sql_db_to_df."}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25775), '6c2ab40b-b67b-4e9d-ba24-0ea1ae14cefa', 'explorer_1f0d6aac-9660-6e05-8009-28de7d6ab567', 'explorer', True, None, '{"checkpointId": "1f0d6aac-9660-6e05-8009-28de7d6ab567"}', datetime.datetime(2025, 12, 11, 16, 2, 26, 25786))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
2025-12-11 16:07:15,324 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:07:15,324 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:07:15,325 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:07:15,329 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:07:15,329 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:07:18,862 - server - INFO - Logging configuration complete
2025-12-11 16:07:18,862 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:07:18,890 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:18,913 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:18,923 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:07:19,382 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:07:19,382 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:07:19,383 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:07:19,383 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:07:20,286 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:07:20,286 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:07:20,287 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:07:20,290 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:07:20,290 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:07:22,796 - server - INFO - Logging configuration complete
2025-12-11 16:07:22,797 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:07:22,818 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:22,842 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:22,852 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:07:23,223 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:07:23,223 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:07:23,224 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:07:23,224 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:07:24,728 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:07:24,728 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:07:24,729 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:07:24,732 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:07:24,733 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:07:27,341 - server - INFO - Logging configuration complete
2025-12-11 16:07:27,342 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:07:27,362 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:27,385 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:27,395 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:07:27,699 - app.services.agent_service - ERROR - Failed to initialize agent service: TaskSchedulerNode.__init__() takes 2 positional arguments but 3 were given
2025-12-11 16:07:30,255 - server - INFO - Logging configuration complete
2025-12-11 16:07:30,255 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:07:30,273 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:30,294 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:07:30,304 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:07:30,645 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:07:30,646 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:07:30,646 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:07:30,646 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:13:02,106 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:13:05,307 - app.services.chat_thread_service - INFO - Deleting thread 120ca539-93ab-4621-95b0-0a501119853c (delete_checkpoint=True)
2025-12-11 16:13:05,310 - app.services.chat_thread_service - INFO - Deleted chat thread: 120ca539-93ab-4621-95b0-0a501119853c (messages and content blocks deleted via cascade)
2025-12-11 16:13:05,310 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:13:10,325 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check schema for albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:10,326 - app.services.chat_thread_service - INFO - Creating new chat thread: ba14ac22-5ad5-44d8-82bb-13cded5bd929 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:10,329 - app.services.chat_thread_service - INFO - Created new chat thread: ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:10,332 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:13:10,332 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:10,417 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:10,417 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check schema for albums table', use_planning: True, use_explainer: False
2025-12-11 16:13:10,442 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:10,442 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:13:10,442 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:10,442 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:13:10,443 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check schema for albums table', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'b8baf577-ad2b-4407-b177-767651deb37b', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:13:10,443 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check schema for albums table'
2025-12-11 16:13:10,443 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check schema for albums table'
2025-12-11 16:13:10,446 - app.services.message_management_service - INFO - Generated message_id: 8cddee3f-3fee-4bdd-9673-e30b9e249fa4 for thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:10,446 - app.services.message_management_service - INFO - Saving user message 8cddee3f-3fee-4bdd-9673-e30b9e249fa4 to thread ba14ac22-5ad5-44d8-82bb-13cded5bd929 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:10,451 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 8cddee3f-3fee-4bdd-9673-e30b9e249fa4
2025-12-11 16:13:10,452 - app.services.message_management_service - INFO - Successfully saved user message 8cddee3f-3fee-4bdd-9673-e30b9e249fa4 to thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:10,452 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread ba14ac22-5ad5-44d8-82bb-13cded5bd929, message_id: 8cddee3f-3fee-4bdd-9673-e30b9e249fa4
2025-12-11 16:13:10,453 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:11,697 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:13:12,666 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:13:13,114 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: b8baf577-ad2b-4407-b177-767651deb37b, checkpoint_id: 1f0d6ac4-b180-6467-8003-013a27896fe5, content_blocks count: 1
2025-12-11 16:13:13,115 - app.services.message_management_service - INFO - Saving assistant message b8baf577-ad2b-4407-b177-767651deb37b to thread ba14ac22-5ad5-44d8-82bb-13cded5bd929 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:13,117 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message b8baf577-ad2b-4407-b177-767651deb37b
2025-12-11 16:13:13,118 - app.services.message_management_service - INFO - Successfully saved assistant message b8baf577-ad2b-4407-b177-767651deb37b to thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:13,119 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 103 (UUID: b8baf577-ad2b-4407-b177-767651deb37b) for approval in thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:17,765 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:17,771 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:17,771 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:13:17,771 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:17,772 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:13:17,772 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '968be3ff-fd45-4b3c-a105-5cdfd6addb2a', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:13:17,773 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 16:13:17,773 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 16:13:17,779 - app.repositories.message_content_repository - INFO - Updated block text_run--803ed730-9cc7-4406-9506-841b8598bad2 with fields: ['needs_approval', 'message_status']
2025-12-11 16:13:17,779 - app.services.message_management_service - INFO - Updated block text_run--803ed730-9cc7-4406-9506-841b8598bad2 status in message b8baf577-ad2b-4407-b177-767651deb37b: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 16:13:17,780 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:18,475 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:13:18,599 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_list_tables: {'tool_input': ''}
2025-12-11 16:13:19,034 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:13:19,120 - app.agents.nodes.task_parser_node - INFO - Task 2 dependencies: [1]
2025-12-11 16:13:19,661 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:13:19,810 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_schema: {'table_names': 'albums'}
2025-12-11 16:13:19,810 - app.agents.nodes.task_parser_node - INFO - Parsed 2 tasks from plan
2025-12-11 16:13:19,812 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0, 2: 1}
2025-12-11 16:13:19,812 - app.agents.nodes.task_scheduler_node - INFO - Executing 1 independent tasks in parallel
2025-12-11 16:13:19,832 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread ba14ac22-5ad5-44d8-82bb-13cded5bd929: tool_call() got an unexpected keyword argument 'function'
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 658, in invoke
    input = step.invoke(input, config)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/graph/_branch.py", line 166, in _route
    result = self.path.invoke(value, config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 393, in invoke
    ret = context.run(self.func, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 362, in route_tasks
    return self.task_scheduler.route_tasks(state)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/task_scheduler_node.py", line 49, in route_tasks
    ai_message = self._create_ai_message_for_tasks(level_0_tasks)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/task_scheduler_node.py", line 126, in _create_ai_message_for_tasks
    return AIMessage(
           ^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/ai.py", line 192, in __init__
    super().__init__(content=content, **kwargs)
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/base.py", line 72, in __init__
    super().__init__(content=content, **kwargs)
  File "/usr/local/lib/python3.11/site-packages/langchain_core/load/serializable.py", line 130, in __init__
    super().__init__(*args, **kwargs)
  File "/usr/local/lib/python3.11/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/ai.py", line 229, in _backwards_compat_tool_calls
    values["tool_calls"] = [
                           ^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/ai.py", line 230, in <listcomp>
    create_tool_call(**{k: v for k, v in tc.items() if k != "type"})
TypeError: tool_call() got an unexpected keyword argument 'function'
During task with name 'task_parser' and id 'c19706b3-c13f-9304-e495-e829bfdec5fb'
2025-12-11 16:13:19,841 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: ba14ac22-5ad5-44d8-82bb-13cded5bd929, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 968be3ff-fd45-4b3c-a105-5cdfd6addb2a, checkpoint_id: 1f0d6ac4-de23-6ca9-8005-1756c073c462, content_blocks count: 1
2025-12-11 16:13:19,841 - app.services.message_management_service - INFO - Saving assistant message 968be3ff-fd45-4b3c-a105-5cdfd6addb2a to thread ba14ac22-5ad5-44d8-82bb-13cded5bd929 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:13:19,844 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 968be3ff-fd45-4b3c-a105-5cdfd6addb2a
2025-12-11 16:13:19,846 - app.services.message_management_service - INFO - Successfully saved assistant message 968be3ff-fd45-4b3c-a105-5cdfd6addb2a to thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:19,846 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 104 (UUID: 968be3ff-fd45-4b3c-a105-5cdfd6addb2a) in thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:19,852 - app.repositories.messages_repository - ERROR - Error finding message 104 in thread ba14ac22-5ad5-44d8-82bb-13cded5bd929: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('ba14ac22-5ad5-44d8-82bb-13cded5bd929', 104)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 16:13:19,852 - app.services.message_management_service - ERROR - Error finding message 104 in thread ba14ac22-5ad5-44d8-82bb-13cded5bd929: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('ba14ac22-5ad5-44d8-82bb-13cded5bd929', 104)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 16:13:19,852 - app.services.message_management_service - ERROR - Error updating message 104 status: Message 104 not found in thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:13:19,853 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread ba14ac22-5ad5-44d8-82bb-13cded5bd929: Message 104 not found in thread ba14ac22-5ad5-44d8-82bb-13cded5bd929
2025-12-11 16:15:02,561 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:15:02,561 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:15:02,562 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:15:02,568 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:15:02,568 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:15:06,029 - server - INFO - Logging configuration complete
2025-12-11 16:15:06,030 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:15:06,057 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:15:06,083 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:15:06,093 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:15:06,548 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:15:06,549 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:15:06,549 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:15:06,549 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:15:18,256 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:15:20,661 - app.services.chat_thread_service - INFO - Deleting thread 7f7d79b0-79b4-4a94-a421-99906ce0e6c0 (delete_checkpoint=True)
2025-12-11 16:15:20,664 - app.services.chat_thread_service - INFO - Deleted chat thread: 7f7d79b0-79b4-4a94-a421-99906ce0e6c0 (messages and content blocks deleted via cascade)
2025-12-11 16:15:20,664 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:15:25,703 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:15:27,950 - app.services.chat_thread_service - INFO - Deleting thread ba14ac22-5ad5-44d8-82bb-13cded5bd929 (delete_checkpoint=True)
2025-12-11 16:15:27,952 - app.services.chat_thread_service - INFO - Deleted chat thread: ba14ac22-5ad5-44d8-82bb-13cded5bd929 (messages and content blocks deleted via cascade)
2025-12-11 16:15:27,952 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:15:30,533 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check schema for albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:30,533 - app.services.chat_thread_service - INFO - Creating new chat thread: 19eec903-51e0-4ffe-86b9-289f25aa6d84 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:30,537 - app.services.chat_thread_service - INFO - Created new chat thread: 19eec903-51e0-4ffe-86b9-289f25aa6d84
2025-12-11 16:15:30,540 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:15:30,540 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 19eec903-51e0-4ffe-86b9-289f25aa6d84
2025-12-11 16:15:30,625 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 19eec903-51e0-4ffe-86b9-289f25aa6d84, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:30,625 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check schema for albums table', use_planning: False, use_explainer: False
2025-12-11 16:15:30,647 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 19eec903-51e0-4ffe-86b9-289f25aa6d84
2025-12-11 16:15:30,648 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:15:30,648 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 19eec903-51e0-4ffe-86b9-289f25aa6d84, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:30,648 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:15:30,649 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check schema for albums table', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '04b978b3-8913-44a5-a8e2-460e688b34b8', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:15:30,649 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check schema for albums table'
2025-12-11 16:15:30,649 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 19eec903-51e0-4ffe-86b9-289f25aa6d84, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check schema for albums table'
2025-12-11 16:15:30,652 - app.services.message_management_service - INFO - Generated message_id: e71922e6-6079-4cb3-85e0-871e0aa779f7 for thread 19eec903-51e0-4ffe-86b9-289f25aa6d84
2025-12-11 16:15:30,652 - app.services.message_management_service - INFO - Saving user message e71922e6-6079-4cb3-85e0-871e0aa779f7 to thread 19eec903-51e0-4ffe-86b9-289f25aa6d84 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:30,657 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message e71922e6-6079-4cb3-85e0-871e0aa779f7
2025-12-11 16:15:30,658 - app.services.message_management_service - INFO - Successfully saved user message e71922e6-6079-4cb3-85e0-871e0aa779f7 to thread 19eec903-51e0-4ffe-86b9-289f25aa6d84
2025-12-11 16:15:30,659 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 19eec903-51e0-4ffe-86b9-289f25aa6d84, message_id: e71922e6-6079-4cb3-85e0-871e0aa779f7
2025-12-11 16:15:30,659 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 19eec903-51e0-4ffe-86b9-289f25aa6d84, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:31,613 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:32,746 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:33,301 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:33,703 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_JWahSVlsH7fOHZRB6j6l6Sc6')]}
2025-12-11 16:15:34,788 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:35,548 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:36,112 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='\nCREATE TABLE albums (\n\t"AlbumId" INTEGER NOT NULL, \n\t"Title" NVARCHAR(160) NOT NULL, \n\t"ArtistId" INTEGER NOT NULL, \n\tPRIMARY KEY ("AlbumId"), \n\tFOREIGN KEY("ArtistId") REFERENCES artists ("ArtistId")\n)\n\n/*\n3 rows from albums table:\nAlbumId\tTitle\tArtistId\n1\tFor Those About To Rock We Salute You\t1\n2\tBalls to the Wall\t2\n3\tRestless and Wild\t2\n*/', name='sql_db_schema', tool_call_id='call_sLqmnK2l8xMsbeGITb5BCtF0')]}
2025-12-11 16:15:36,920 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:39,945 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: 19eec903-51e0-4ffe-86b9-289f25aa6d84, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 04b978b3-8913-44a5-a8e2-460e688b34b8, checkpoint_id: 1f0d6aca-29be-665f-8009-a2962aa7159b, content_blocks count: 4
2025-12-11 16:15:39,945 - app.services.message_management_service - INFO - Saving assistant message 04b978b3-8913-44a5-a8e2-460e688b34b8 to thread 19eec903-51e0-4ffe-86b9-289f25aa6d84 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:39,950 - app.repositories.message_content_repository - INFO - Inserted 4 content blocks for message 04b978b3-8913-44a5-a8e2-460e688b34b8
2025-12-11 16:15:39,952 - app.services.message_management_service - INFO - Successfully saved assistant message 04b978b3-8913-44a5-a8e2-460e688b34b8 to thread 19eec903-51e0-4ffe-86b9-289f25aa6d84
2025-12-11 16:15:39,952 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 106 (UUID: 04b978b3-8913-44a5-a8e2-460e688b34b8) in thread 19eec903-51e0-4ffe-86b9-289f25aa6d84
2025-12-11 16:15:42,459 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:15:47,732 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check schema for albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:47,733 - app.services.chat_thread_service - INFO - Creating new chat thread: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:47,734 - app.services.chat_thread_service - INFO - Created new chat thread: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:47,736 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:15:47,737 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:47,820 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:47,821 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check schema for albums table', use_planning: True, use_explainer: False
2025-12-11 16:15:47,827 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:47,828 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:15:47,828 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:47,828 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:15:47,829 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check schema for albums table', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '728806a4-994c-4537-b039-34398518735c', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:15:47,829 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check schema for albums table'
2025-12-11 16:15:47,829 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check schema for albums table'
2025-12-11 16:15:47,832 - app.services.message_management_service - INFO - Generated message_id: 25876f6f-00da-4f4a-998a-719a7f935818 for thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:47,832 - app.services.message_management_service - INFO - Saving user message 25876f6f-00da-4f4a-998a-719a7f935818 to thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:47,835 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 25876f6f-00da-4f4a-998a-719a7f935818
2025-12-11 16:15:47,836 - app.services.message_management_service - INFO - Successfully saved user message 25876f6f-00da-4f4a-998a-719a7f935818 to thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:47,836 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, message_id: 25876f6f-00da-4f4a-998a-719a7f935818
2025-12-11 16:15:47,837 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:48,746 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:49,504 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:49,997 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 728806a4-994c-4537-b039-34398518735c, checkpoint_id: 1f0d6aca-89a6-64a5-8003-07ffbd065e52, content_blocks count: 1
2025-12-11 16:15:49,997 - app.services.message_management_service - INFO - Saving assistant message 728806a4-994c-4537-b039-34398518735c to thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:49,999 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 728806a4-994c-4537-b039-34398518735c
2025-12-11 16:15:50,000 - app.services.message_management_service - INFO - Successfully saved assistant message 728806a4-994c-4537-b039-34398518735c to thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:50,000 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 108 (UUID: 728806a4-994c-4537-b039-34398518735c) for approval in thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:51,879 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:51,884 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:51,885 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:15:51,885 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:51,885 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:15:51,885 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': 'cecc853f-39a6-454a-b810-e0c0f85d8466', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:15:51,886 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 16:15:51,886 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 16:15:51,893 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:52,697 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:52,709 - app.repositories.message_content_repository - INFO - Updated block text_run--f025c220-d096-4b96-9402-07693e1ce5a0 with fields: ['needs_approval', 'message_status']
2025-12-11 16:15:52,709 - app.services.message_management_service - INFO - Updated block text_run--f025c220-d096-4b96-9402-07693e1ce5a0 status in message 728806a4-994c-4537-b039-34398518735c: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 16:15:52,902 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_list_tables: {'tool_input': ''}
2025-12-11 16:15:53,416 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:53,472 - app.agents.nodes.task_parser_node - INFO - Task 2 dependencies: [1]
2025-12-11 16:15:53,961 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:15:54,080 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_schema: {'table_names': 'albums'}
2025-12-11 16:15:54,080 - app.agents.nodes.task_parser_node - INFO - Parsed 2 tasks from plan
2025-12-11 16:15:54,081 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0, 2: 1}
2025-12-11 16:15:54,082 - app.agents.nodes.task_scheduler_node - INFO - Executing 1 independent tasks in parallel
2025-12-11 16:15:54,096 - app.api.v1.endpoints.streaming_graph - ERROR - Streaming graph error for thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f: tool_call() got an unexpected keyword argument 'function'
Traceback (most recent call last):
  File "/app/app/api/v1/endpoints/streaming_graph.py", line 253, in event_generator
    for msg, metadata in agent.graph.stream(input_state, config, stream_mode="messages"):
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/main.py", line 2679, in stream
    for _ in runner.tick(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 258, in tick
    _panic_or_proceed(
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_runner.py", line 520, in _panic_or_proceed
    raise exc
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_executor.py", line 80, in done
    task.result()
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/usr/local/lib/python3.11/concurrent/futures/thread.py", line 58, in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/pregel/_retry.py", line 42, in run_with_retry
    return task.proc.invoke(task.input, config)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 658, in invoke
    input = step.invoke(input, config)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 400, in invoke
    ret = self.func(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/graph/_branch.py", line 166, in _route
    result = self.path.invoke(value, config)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langgraph/_internal/_runnable.py", line 393, in invoke
    ret = context.run(self.func, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/data_exploration_agent.py", line 362, in route_tasks
    return self.task_scheduler.route_tasks(state)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/task_scheduler_node.py", line 49, in route_tasks
    ai_message = self._create_ai_message_for_tasks(level_0_tasks)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/app/agents/nodes/task_scheduler_node.py", line 126, in _create_ai_message_for_tasks
    return AIMessage(
           ^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/ai.py", line 192, in __init__
    super().__init__(content=content, **kwargs)
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/base.py", line 72, in __init__
    super().__init__(content=content, **kwargs)
  File "/usr/local/lib/python3.11/site-packages/langchain_core/load/serializable.py", line 130, in __init__
    super().__init__(*args, **kwargs)
  File "/usr/local/lib/python3.11/site-packages/pydantic/main.py", line 253, in __init__
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/ai.py", line 229, in _backwards_compat_tool_calls
    values["tool_calls"] = [
                           ^
  File "/usr/local/lib/python3.11/site-packages/langchain_core/messages/ai.py", line 230, in <listcomp>
    create_tool_call(**{k: v for k, v in tc.items() if k != "type"})
TypeError: tool_call() got an unexpected keyword argument 'function'
During task with name 'task_parser' and id '65f02d0a-e664-32f3-518e-a0cdcc054cdb'
2025-12-11 16:15:54,103 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for error with thread_id: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: cecc853f-39a6-454a-b810-e0c0f85d8466, checkpoint_id: 1f0d6aca-9bdc-6a3e-8005-51722adb378b, content_blocks count: 1
2025-12-11 16:15:54,104 - app.services.message_management_service - INFO - Saving assistant message cecc853f-39a6-454a-b810-e0c0f85d8466 to thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:15:54,106 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message cecc853f-39a6-454a-b810-e0c0f85d8466
2025-12-11 16:15:54,107 - app.services.message_management_service - INFO - Successfully saved assistant message cecc853f-39a6-454a-b810-e0c0f85d8466 to thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:54,108 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant error message 109 (UUID: cecc853f-39a6-454a-b810-e0c0f85d8466) in thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:54,109 - app.repositories.messages_repository - ERROR - Error finding message 109 in thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('40b5f6c1-65c0-4556-97fa-b04a0e6ce58f', 109)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 16:15:54,110 - app.services.message_management_service - ERROR - Error finding message 109 in thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f: Failed to find message: (sqlalchemy.dialects.postgresql.asyncpg.ProgrammingError) <class 'asyncpg.exceptions.UndefinedFunctionError'>: operator does not exist: character varying = integer
HINT:  No operator matches the given name and argument types. You might need to add explicit type casts.
[SQL: SELECT chat_messages.id, chat_messages.message_id, chat_messages.thread_id, chat_messages.sender, chat_messages.message_type, chat_messages.message_status, chat_messages.checkpoint_id, chat_messages.user_id, chat_messages.timestamp 
FROM chat_messages 
WHERE chat_messages.thread_id = $1::VARCHAR AND chat_messages.message_id = $2::INTEGER]
[parameters: ('40b5f6c1-65c0-4556-97fa-b04a0e6ce58f', 109)]
(Background on this error at: https://sqlalche.me/e/20/f405)
2025-12-11 16:15:54,110 - app.services.message_management_service - ERROR - Error updating message 109 status: Message 109 not found in thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:15:54,110 - app.api.v1.endpoints.streaming_graph - ERROR - Failed to persist error message for thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f: Message 109 not found in thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f
2025-12-11 16:16:38,597 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:16:38,597 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:16:38,598 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:16:38,603 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:16:38,604 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:16:42,185 - server - INFO - Logging configuration complete
2025-12-11 16:16:42,186 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:16:42,215 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:16:42,239 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:16:42,249 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:16:42,713 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:16:42,713 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:16:42,714 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:16:42,714 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:16:45,122 - server - INFO - Logging configuration complete
2025-12-11 16:16:45,122 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:16:45,140 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:16:45,163 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:16:45,174 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:16:45,542 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:16:45,543 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:16:45,543 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:16:45,543 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:17:13,341 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:17:15,677 - app.services.chat_thread_service - INFO - Deleting thread 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f (delete_checkpoint=True)
2025-12-11 16:17:15,680 - app.services.chat_thread_service - INFO - Deleted chat thread: 40b5f6c1-65c0-4556-97fa-b04a0e6ce58f (messages and content blocks deleted via cascade)
2025-12-11 16:17:15,680 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:17:22,405 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check schema for albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:22,406 - app.services.chat_thread_service - INFO - Creating new chat thread: e79dbb5e-f9df-4a67-b408-7fda87c0566d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:22,408 - app.services.chat_thread_service - INFO - Created new chat thread: e79dbb5e-f9df-4a67-b408-7fda87c0566d
2025-12-11 16:17:22,411 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:17:22,411 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: e79dbb5e-f9df-4a67-b408-7fda87c0566d
2025-12-11 16:17:22,494 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: e79dbb5e-f9df-4a67-b408-7fda87c0566d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:22,494 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check schema for albums table', use_planning: False, use_explainer: False
2025-12-11 16:17:22,522 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: e79dbb5e-f9df-4a67-b408-7fda87c0566d
2025-12-11 16:17:22,522 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:17:22,522 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: e79dbb5e-f9df-4a67-b408-7fda87c0566d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:22,522 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:17:22,523 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check schema for albums table', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '3f5a8a2b-b3d0-4453-8307-73bccc90d7f1', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:17:22,523 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check schema for albums table'
2025-12-11 16:17:22,523 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: e79dbb5e-f9df-4a67-b408-7fda87c0566d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check schema for albums table'
2025-12-11 16:17:22,526 - app.services.message_management_service - INFO - Generated message_id: 31312e5d-3791-4884-bd8d-6774f576fcd6 for thread e79dbb5e-f9df-4a67-b408-7fda87c0566d
2025-12-11 16:17:22,526 - app.services.message_management_service - INFO - Saving user message 31312e5d-3791-4884-bd8d-6774f576fcd6 to thread e79dbb5e-f9df-4a67-b408-7fda87c0566d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:22,531 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 31312e5d-3791-4884-bd8d-6774f576fcd6
2025-12-11 16:17:22,532 - app.services.message_management_service - INFO - Successfully saved user message 31312e5d-3791-4884-bd8d-6774f576fcd6 to thread e79dbb5e-f9df-4a67-b408-7fda87c0566d
2025-12-11 16:17:22,532 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread e79dbb5e-f9df-4a67-b408-7fda87c0566d, message_id: 31312e5d-3791-4884-bd8d-6774f576fcd6
2025-12-11 16:17:22,533 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: e79dbb5e-f9df-4a67-b408-7fda87c0566d, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:23,408 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:24,749 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:26,030 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:26,579 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:17:26,697 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='albums, artists, customers, employees, genres, invoice_items, invoices, media_types, playlist_track, playlists, tracks', name='sql_db_list_tables', tool_call_id='call_xCGVkAsWPnvVPQdk7v6CClB2')]}
2025-12-11 16:17:28,079 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:28,849 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:29,355 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='\nCREATE TABLE albums (\n\t"AlbumId" INTEGER NOT NULL, \n\t"Title" NVARCHAR(160) NOT NULL, \n\t"ArtistId" INTEGER NOT NULL, \n\tPRIMARY KEY ("AlbumId"), \n\tFOREIGN KEY("ArtistId") REFERENCES artists ("ArtistId")\n)\n\n/*\n3 rows from albums table:\nAlbumId\tTitle\tArtistId\n1\tFor Those About To Rock We Salute You\t1\n2\tBalls to the Wall\t2\n3\tRestless and Wild\t2\n*/', name='sql_db_schema', tool_call_id='call_VTVttB0DxyuUM8zk01JzbiRl')]}
2025-12-11 16:17:30,269 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:32,789 - app.services.chat_thread_service - INFO - Deleting thread e79dbb5e-f9df-4a67-b408-7fda87c0566d (delete_checkpoint=True)
2025-12-11 16:17:34,105 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: e79dbb5e-f9df-4a67-b408-7fda87c0566d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 3f5a8a2b-b3d0-4453-8307-73bccc90d7f1, checkpoint_id: 1f0d6ace-6a7e-6d6a-8009-f0a376c2d265, content_blocks count: 4
2025-12-11 16:17:34,105 - app.services.message_management_service - INFO - Saving assistant message 3f5a8a2b-b3d0-4453-8307-73bccc90d7f1 to thread e79dbb5e-f9df-4a67-b408-7fda87c0566d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:34,109 - app.repositories.message_content_repository - INFO - Inserted 4 content blocks for message 3f5a8a2b-b3d0-4453-8307-73bccc90d7f1
2025-12-11 16:17:34,111 - app.services.message_management_service - INFO - Successfully saved assistant message 3f5a8a2b-b3d0-4453-8307-73bccc90d7f1 to thread e79dbb5e-f9df-4a67-b408-7fda87c0566d
2025-12-11 16:17:34,111 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 111 (UUID: 3f5a8a2b-b3d0-4453-8307-73bccc90d7f1) in thread e79dbb5e-f9df-4a67-b408-7fda87c0566d
2025-12-11 16:17:34,114 - app.services.chat_thread_service - INFO - Deleted chat thread: e79dbb5e-f9df-4a67-b408-7fda87c0566d (messages and content blocks deleted via cascade)
2025-12-11 16:17:34,114 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:17:36,806 - app.services.chat_thread_service - INFO - Deleting thread 19eec903-51e0-4ffe-86b9-289f25aa6d84 (delete_checkpoint=True)
2025-12-11 16:17:36,808 - app.services.chat_thread_service - INFO - Deleted chat thread: 19eec903-51e0-4ffe-86b9-289f25aa6d84 (messages and content blocks deleted via cascade)
2025-12-11 16:17:36,808 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:17:41,014 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check schema for albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:41,015 - app.services.chat_thread_service - INFO - Creating new chat thread: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:41,017 - app.services.chat_thread_service - INFO - Created new chat thread: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:41,019 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:17:41,020 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:41,086 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:41,087 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check schema for albums table', use_planning: True, use_explainer: False
2025-12-11 16:17:41,091 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:41,091 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:17:41,091 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:41,092 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:17:41,092 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check schema for albums table', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'fe6a3e6c-2212-4485-910f-221384af6b52', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:17:41,093 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check schema for albums table'
2025-12-11 16:17:41,093 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check schema for albums table'
2025-12-11 16:17:41,097 - app.services.message_management_service - INFO - Generated message_id: 0568191f-7a5a-48b9-80f9-7d94570ef077 for thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:41,097 - app.services.message_management_service - INFO - Saving user message 0568191f-7a5a-48b9-80f9-7d94570ef077 to thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:41,100 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 0568191f-7a5a-48b9-80f9-7d94570ef077
2025-12-11 16:17:41,101 - app.services.message_management_service - INFO - Successfully saved user message 0568191f-7a5a-48b9-80f9-7d94570ef077 to thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:41,102 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, message_id: 0568191f-7a5a-48b9-80f9-7d94570ef077
2025-12-11 16:17:41,102 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:41,871 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:42,901 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:43,514 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: fe6a3e6c-2212-4485-910f-221384af6b52, checkpoint_id: 1f0d6ace-c43d-63c7-8003-7da779d4e9b9, content_blocks count: 1
2025-12-11 16:17:43,514 - app.services.message_management_service - INFO - Saving assistant message fe6a3e6c-2212-4485-910f-221384af6b52 to thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:43,516 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message fe6a3e6c-2212-4485-910f-221384af6b52
2025-12-11 16:17:43,517 - app.services.message_management_service - INFO - Successfully saved assistant message fe6a3e6c-2212-4485-910f-221384af6b52 to thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:43,518 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 113 (UUID: fe6a3e6c-2212-4485-910f-221384af6b52) for approval in thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:45,486 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:45,492 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:45,492 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:17:45,492 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:45,493 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:17:45,493 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '8ca3aa15-62aa-44a1-ae45-8c8662175ab5', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:17:45,493 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 16:17:45,494 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 16:17:45,500 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:46,022 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:46,032 - app.repositories.message_content_repository - INFO - Updated block text_run--3a553e36-3518-4b61-b77e-6c970303f061 with fields: ['needs_approval', 'message_status']
2025-12-11 16:17:46,033 - app.services.message_management_service - INFO - Updated block text_run--3a553e36-3518-4b61-b77e-6c970303f061 status in message fe6a3e6c-2212-4485-910f-221384af6b52: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 16:17:46,209 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_list_tables: {'tool_input': ''}
2025-12-11 16:17:46,652 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:46,731 - app.agents.nodes.task_parser_node - INFO - Task 2 dependencies: [1]
2025-12-11 16:17:47,243 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:47,542 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_schema: {'table_names': 'albums'}
2025-12-11 16:17:47,542 - app.agents.nodes.task_parser_node - INFO - Parsed 2 tasks from plan
2025-12-11 16:17:47,544 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0, 2: 1}
2025-12-11 16:17:47,544 - app.agents.nodes.task_scheduler_node - INFO - Executing 1 independent tasks in parallel
2025-12-11 16:17:47,549 - app.agents.nodes.task_executor_node - INFO - Task 2 (sql_db_schema) is now executable
2025-12-11 16:17:47,550 - app.agents.data_exploration_agent - INFO - No more tasks, going to joiner
2025-12-11 16:17:48,030 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:17:50,832 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 16:17:50,839 - app.agents.nodes.planner_node - ERROR - Error in initial planning: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[7].role', 'code': None}}
2025-12-11 16:17:50,848 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 8ca3aa15-62aa-44a1-ae45-8c8662175ab5, checkpoint_id: 1f0d6acf-0a2d-6d2e-8009-26027c6ecd5b, content_blocks count: 3
2025-12-11 16:17:50,848 - app.services.message_management_service - INFO - Saving assistant message 8ca3aa15-62aa-44a1-ae45-8c8662175ab5 to thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:17:50,852 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 8ca3aa15-62aa-44a1-ae45-8c8662175ab5
2025-12-11 16:17:50,853 - app.services.message_management_service - INFO - Successfully saved assistant message 8ca3aa15-62aa-44a1-ae45-8c8662175ab5 to thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:17:50,853 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 114 (UUID: 8ca3aa15-62aa-44a1-ae45-8c8662175ab5) for approval in thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d
2025-12-11 16:45:22,787 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:45:22,788 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:45:22,789 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:45:22,797 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:45:22,797 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:45:26,367 - server - INFO - Logging configuration complete
2025-12-11 16:45:26,367 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:45:26,395 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:45:26,421 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:45:26,430 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:45:26,896 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:45:26,896 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:45:26,896 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:45:26,897 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:45:44,433 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:45:44,433 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:45:44,434 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:45:44,437 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:45:44,438 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:45:46,915 - server - INFO - Logging configuration complete
2025-12-11 16:45:46,916 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:45:46,936 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:45:46,961 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:45:46,971 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:45:47,345 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:45:47,346 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:45:47,346 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:45:47,346 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:48:36,913 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:48:36,914 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:48:36,915 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:48:36,919 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:48:36,919 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:48:40,564 - server - INFO - Logging configuration complete
2025-12-11 16:48:40,565 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:48:40,596 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:48:40,625 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:48:40,635 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:48:41,008 - app.services.agent_service - ERROR - Failed to initialize agent service: cannot import name 'get_text2sql_tool' from 'app.agents.tools.text2sql_tool' (/app/app/agents/tools/text2sql_tool.py)
2025-12-11 16:49:12,704 - server - INFO - Logging configuration complete
2025-12-11 16:49:12,705 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:49:12,725 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:49:12,751 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:49:12,761 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:49:13,152 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:49:13,153 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:49:13,153 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:49:13,153 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:51:28,850 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:51:28,850 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:51:28,851 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:51:28,854 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:51:28,855 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:51:32,651 - server - INFO - Logging configuration complete
2025-12-11 16:51:32,652 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:51:32,682 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:51:32,706 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:51:32,716 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:51:33,399 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:51:33,399 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:51:33,400 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:51:33,400 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:51:35,890 - server - INFO - Logging configuration complete
2025-12-11 16:51:35,890 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:51:35,908 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:51:35,933 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:51:35,944 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:51:36,307 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:51:36,308 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:51:36,308 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:51:36,308 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 16:52:34,069 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:52:36,576 - app.services.chat_thread_service - INFO - Deleting thread 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d (delete_checkpoint=True)
2025-12-11 16:52:36,579 - app.services.chat_thread_service - INFO - Deleted chat thread: 6bdf0f5b-601e-40fd-a076-5d100b2a3e4d (messages and content blocks deleted via cascade)
2025-12-11 16:52:36,579 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:52:41,441 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'check schema for albums table' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:52:41,442 - app.services.chat_thread_service - INFO - Creating new chat thread: bbe24f2a-4482-4714-b4ca-da651cf863d2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:52:41,447 - app.services.chat_thread_service - INFO - Created new chat thread: bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:52:41,449 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:52:41,450 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:52:41,529 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:52:41,530 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'check schema for albums table', use_planning: False, use_explainer: False
2025-12-11 16:52:41,555 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:52:41,556 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:52:41,556 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:52:41,556 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:52:41,557 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'check schema for albums table', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '96dd563e-fe1b-4592-b20e-ac8992468750', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:52:41,557 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'check schema for albums table'
2025-12-11 16:52:41,557 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'check schema for albums table'
2025-12-11 16:52:41,560 - app.services.message_management_service - INFO - Generated message_id: 35d9a1ca-69e4-45d3-833a-9fc266941ab0 for thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:52:41,560 - app.services.message_management_service - INFO - Saving user message 35d9a1ca-69e4-45d3-833a-9fc266941ab0 to thread bbe24f2a-4482-4714-b4ca-da651cf863d2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:52:41,565 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 35d9a1ca-69e4-45d3-833a-9fc266941ab0
2025-12-11 16:52:41,565 - app.services.message_management_service - INFO - Successfully saved user message 35d9a1ca-69e4-45d3-833a-9fc266941ab0 to thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:52:41,566 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread bbe24f2a-4482-4714-b4ca-da651cf863d2, message_id: 35d9a1ca-69e4-45d3-833a-9fc266941ab0
2025-12-11 16:52:41,567 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:52:42,811 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:52:44,195 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:52:45,475 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:52:45,859 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content="[(0, 'AlbumId', 'INTEGER', 1, None, 1), (1, 'Title', 'NVARCHAR(160)', 1, None, 0), (2, 'ArtistId', 'INTEGER', 1, None, 0)]", name='sql_db_query', tool_call_id='call_I8Dhb6wmyaOlQ13ZNSZShf2z')]}
2025-12-11 16:52:47,089 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:52:51,247 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 96dd563e-fe1b-4592-b20e-ac8992468750, checkpoint_id: 1f0d6b1d-4923-66a7-8006-d74ff14a8cbe, content_blocks count: 3
2025-12-11 16:52:51,248 - app.services.message_management_service - INFO - Saving assistant message 96dd563e-fe1b-4592-b20e-ac8992468750 to thread bbe24f2a-4482-4714-b4ca-da651cf863d2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:52:51,252 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 96dd563e-fe1b-4592-b20e-ac8992468750
2025-12-11 16:52:51,253 - app.services.message_management_service - INFO - Successfully saved assistant message 96dd563e-fe1b-4592-b20e-ac8992468750 to thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:52:51,253 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 116 (UUID: 96dd563e-fe1b-4592-b20e-ac8992468750) in thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:53:29,591 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:29,591 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'vfdgv', use_planning: False, use_explainer: False
2025-12-11 16:53:29,598 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:53:29,599 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:53:29,599 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:29,599 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:53:29,600 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'vfdgv', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '190731c3-77e7-41f4-b584-3efcd02c6b2f', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:53:29,600 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'vfdgv'
2025-12-11 16:53:29,601 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'vfdgv'
2025-12-11 16:53:29,607 - app.services.message_management_service - INFO - Generated message_id: a6cbd4e3-7974-4040-a90a-e9b19dc8d71f for thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:53:29,607 - app.services.message_management_service - INFO - Saving user message a6cbd4e3-7974-4040-a90a-e9b19dc8d71f to thread bbe24f2a-4482-4714-b4ca-da651cf863d2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:29,610 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a6cbd4e3-7974-4040-a90a-e9b19dc8d71f
2025-12-11 16:53:29,611 - app.services.message_management_service - INFO - Successfully saved user message a6cbd4e3-7974-4040-a90a-e9b19dc8d71f to thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:53:29,611 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread bbe24f2a-4482-4714-b4ca-da651cf863d2, message_id: a6cbd4e3-7974-4040-a90a-e9b19dc8d71f
2025-12-11 16:53:29,612 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:30,537 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:53:30,965 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: bbe24f2a-4482-4714-b4ca-da651cf863d2, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 190731c3-77e7-41f4-b584-3efcd02c6b2f, checkpoint_id: 1f0d6b1e-c3f0-624e-8009-68ec29fee148, content_blocks count: 1
2025-12-11 16:53:30,965 - app.services.message_management_service - INFO - Saving assistant message 190731c3-77e7-41f4-b584-3efcd02c6b2f to thread bbe24f2a-4482-4714-b4ca-da651cf863d2 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:30,968 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 190731c3-77e7-41f4-b584-3efcd02c6b2f
2025-12-11 16:53:30,969 - app.services.message_management_service - INFO - Successfully saved assistant message 190731c3-77e7-41f4-b584-3efcd02c6b2f to thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:53:30,969 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 118 (UUID: 190731c3-77e7-41f4-b584-3efcd02c6b2f) in thread bbe24f2a-4482-4714-b4ca-da651cf863d2
2025-12-11 16:53:44,198 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:53:46,499 - app.services.chat_thread_service - INFO - Deleting thread bbe24f2a-4482-4714-b4ca-da651cf863d2 (delete_checkpoint=True)
2025-12-11 16:53:46,501 - app.services.chat_thread_service - INFO - Deleted chat thread: bbe24f2a-4482-4714-b4ca-da651cf863d2 (messages and content blocks deleted via cascade)
2025-12-11 16:53:46,501 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:53:51,621 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'slfnsfnl' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:51,621 - app.services.chat_thread_service - INFO - Creating new chat thread: b3803778-4dc6-43b9-9954-dc60c81f9132 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:51,623 - app.services.chat_thread_service - INFO - Created new chat thread: b3803778-4dc6-43b9-9954-dc60c81f9132
2025-12-11 16:53:51,624 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:53:51,625 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: b3803778-4dc6-43b9-9954-dc60c81f9132
2025-12-11 16:53:51,696 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: b3803778-4dc6-43b9-9954-dc60c81f9132, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:51,697 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'slfnsfnl', use_planning: False, use_explainer: False
2025-12-11 16:53:51,702 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: b3803778-4dc6-43b9-9954-dc60c81f9132
2025-12-11 16:53:51,702 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:53:51,703 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: b3803778-4dc6-43b9-9954-dc60c81f9132, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:51,703 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:53:51,703 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'slfnsfnl', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': 'bdb44099-3c19-4729-ac42-961fd288d7f9', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:53:51,704 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'slfnsfnl'
2025-12-11 16:53:51,704 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: b3803778-4dc6-43b9-9954-dc60c81f9132, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'slfnsfnl'
2025-12-11 16:53:51,707 - app.services.message_management_service - INFO - Generated message_id: b966b95f-d2a4-460f-8ec1-139fdbd6a215 for thread b3803778-4dc6-43b9-9954-dc60c81f9132
2025-12-11 16:53:51,707 - app.services.message_management_service - INFO - Saving user message b966b95f-d2a4-460f-8ec1-139fdbd6a215 to thread b3803778-4dc6-43b9-9954-dc60c81f9132 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:51,709 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message b966b95f-d2a4-460f-8ec1-139fdbd6a215
2025-12-11 16:53:51,710 - app.services.message_management_service - INFO - Successfully saved user message b966b95f-d2a4-460f-8ec1-139fdbd6a215 to thread b3803778-4dc6-43b9-9954-dc60c81f9132
2025-12-11 16:53:51,710 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread b3803778-4dc6-43b9-9954-dc60c81f9132, message_id: b966b95f-d2a4-460f-8ec1-139fdbd6a215
2025-12-11 16:53:51,711 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: b3803778-4dc6-43b9-9954-dc60c81f9132, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:52,423 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:53:52,791 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: b3803778-4dc6-43b9-9954-dc60c81f9132, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: bdb44099-3c19-4729-ac42-961fd288d7f9, checkpoint_id: 1f0d6b1f-9418-611c-8001-12e7637dcd9c, content_blocks count: 1
2025-12-11 16:53:52,791 - app.services.message_management_service - INFO - Saving assistant message bdb44099-3c19-4729-ac42-961fd288d7f9 to thread b3803778-4dc6-43b9-9954-dc60c81f9132 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:53:52,794 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message bdb44099-3c19-4729-ac42-961fd288d7f9
2025-12-11 16:53:52,795 - app.services.message_management_service - INFO - Successfully saved assistant message bdb44099-3c19-4729-ac42-961fd288d7f9 to thread b3803778-4dc6-43b9-9954-dc60c81f9132
2025-12-11 16:53:52,795 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 120 (UUID: bdb44099-3c19-4729-ac42-961fd288d7f9) in thread b3803778-4dc6-43b9-9954-dc60c81f9132
2025-12-11 16:53:58,477 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:54:17,251 - app.services.chat_thread_service - INFO - Deleting thread b3803778-4dc6-43b9-9954-dc60c81f9132 (delete_checkpoint=True)
2025-12-11 16:54:17,253 - app.services.chat_thread_service - INFO - Deleted chat thread: b3803778-4dc6-43b9-9954-dc60c81f9132 (messages and content blocks deleted via cascade)
2025-12-11 16:54:17,253 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:55:24,027 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'can you pls plot 5 most playlist track time?' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:24,028 - app.services.chat_thread_service - INFO - Creating new chat thread: 3cd7825f-8dd8-4f1e-9823-8233bbd12845 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:24,029 - app.services.chat_thread_service - INFO - Created new chat thread: 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:24,031 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:55:24,031 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:24,103 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:24,104 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'can you pls plot 5 most playlist track time?', use_planning: True, use_explainer: False
2025-12-11 16:55:24,109 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:24,109 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:55:24,109 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:24,109 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:55:24,110 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'can you pls plot 5 most playlist track time?', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'c96df4ec-65d0-4098-be73-578917358ce9', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:55:24,110 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'can you pls plot 5 most playlist track time?'
2025-12-11 16:55:24,110 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'can you pls plot 5 most playlist track time?'
2025-12-11 16:55:24,113 - app.services.message_management_service - INFO - Generated message_id: 3ce16041-1f67-48ca-a868-3a31491bb7fd for thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:24,114 - app.services.message_management_service - INFO - Saving user message 3ce16041-1f67-48ca-a868-3a31491bb7fd to thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:24,116 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 3ce16041-1f67-48ca-a868-3a31491bb7fd
2025-12-11 16:55:24,117 - app.services.message_management_service - INFO - Successfully saved user message 3ce16041-1f67-48ca-a868-3a31491bb7fd to thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:24,117 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845, message_id: 3ce16041-1f67-48ca-a868-3a31491bb7fd
2025-12-11 16:55:24,118 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:24,863 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:25,766 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:27,443 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: c96df4ec-65d0-4098-be73-578917358ce9, checkpoint_id: 1f0d6b23-1ac2-65ee-8003-118c030c3c9a, content_blocks count: 1
2025-12-11 16:55:27,443 - app.services.message_management_service - INFO - Saving assistant message c96df4ec-65d0-4098-be73-578917358ce9 to thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:27,445 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message c96df4ec-65d0-4098-be73-578917358ce9
2025-12-11 16:55:27,446 - app.services.message_management_service - INFO - Successfully saved assistant message c96df4ec-65d0-4098-be73-578917358ce9 to thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:27,446 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 122 (UUID: c96df4ec-65d0-4098-be73-578917358ce9) for approval in thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:43,341 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:43,354 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:43,354 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:55:43,357 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:43,358 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:55:43,359 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '5d0a7388-c3af-4d7a-9eed-c1b09505ad2a', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:55:43,360 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 16:55:43,360 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 16:55:43,387 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:44,454 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:44,542 - app.repositories.message_content_repository - INFO - Updated block text_run--13b7e027-7b7d-4a5c-991e-431fb610ef3c with fields: ['needs_approval', 'message_status']
2025-12-11 16:55:44,542 - app.services.message_management_service - INFO - Updated block text_run--13b7e027-7b7d-4a5c-991e-431fb610ef3c status in message c96df4ec-65d0-4098-be73-578917358ce9: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 16:55:44,832 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_query: {'query': "SELECT track_name, track_time FROM playlists WHERE playlist_id = '1';"}
2025-12-11 16:55:45,407 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:45,470 - app.agents.nodes.task_parser_node - INFO - Task 2 dependencies: [1]
2025-12-11 16:55:46,008 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:46,707 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_to_df: {'sql_query': 'SELECT * FROM track_data', 'description': 'Convert track data to a pandas DataFrame for analysis'}
2025-12-11 16:55:47,363 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:47,434 - app.agents.nodes.task_parser_node - INFO - Task 3 dependencies: [2]
2025-12-11 16:55:48,448 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:48,728 - app.agents.nodes.task_parser_node - INFO - Generated args for python_repl: {'code': "print(df.nlargest(5, 'track_time'))"}
2025-12-11 16:55:49,146 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:49,260 - app.agents.nodes.task_parser_node - INFO - Task 4 dependencies: [2, 3]
2025-12-11 16:55:49,711 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:51,618 - app.agents.nodes.task_parser_node - INFO - Generated args for large_plotting_tool: {'x_column': 'track_name', 'y_column': 'track_time', 'plot_type': 'bar', 'title': '5 Longest Track Times', 'x_label': 'Track Name', 'y_label': 'Track Time (minutes)', 'fig_width': 12, 'fig_height': 8}
2025-12-11 16:55:51,618 - app.agents.nodes.task_parser_node - INFO - Parsed 4 tasks from plan
2025-12-11 16:55:51,619 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0, 2: 1, 3: 2, 4: 3}
2025-12-11 16:55:51,619 - app.agents.nodes.task_scheduler_node - INFO - Executing 1 independent tasks in parallel
2025-12-11 16:55:51,626 - app.agents.nodes.task_executor_node - INFO - Task 2 (sql_db_to_df) is now executable
2025-12-11 16:55:51,627 - app.agents.data_exploration_agent - INFO - No more tasks, going to joiner
2025-12-11 16:55:52,294 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:55:56,784 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 16:55:56,792 - app.agents.nodes.planner_node - ERROR - Error in initial planning: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[7].role', 'code': None}}
2025-12-11 16:55:56,799 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 3cd7825f-8dd8-4f1e-9823-8233bbd12845, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 5d0a7388-c3af-4d7a-9eed-c1b09505ad2a, checkpoint_id: 1f0d6b24-32b9-66ae-8009-196b812c782b, content_blocks count: 3
2025-12-11 16:55:56,800 - app.services.message_management_service - INFO - Saving assistant message 5d0a7388-c3af-4d7a-9eed-c1b09505ad2a to thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:55:56,803 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 5d0a7388-c3af-4d7a-9eed-c1b09505ad2a
2025-12-11 16:55:56,804 - app.services.message_management_service - INFO - Successfully saved assistant message 5d0a7388-c3af-4d7a-9eed-c1b09505ad2a to thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:55:56,804 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 123 (UUID: 5d0a7388-c3af-4d7a-9eed-c1b09505ad2a) for approval in thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 16:56:08,094 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'can you pls plot 5 most playlist track time?' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:56:08,096 - app.services.chat_thread_service - INFO - Creating new chat thread: c775a352-70ac-4a40-bb99-da230d14a406 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:56:08,098 - app.services.chat_thread_service - INFO - Created new chat thread: c775a352-70ac-4a40-bb99-da230d14a406
2025-12-11 16:56:08,101 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 16:56:08,101 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: c775a352-70ac-4a40-bb99-da230d14a406
2025-12-11 16:56:08,176 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: c775a352-70ac-4a40-bb99-da230d14a406, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:56:08,177 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'can you pls plot 5 most playlist track time?', use_planning: False, use_explainer: False
2025-12-11 16:56:08,183 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: c775a352-70ac-4a40-bb99-da230d14a406
2025-12-11 16:56:08,184 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 16:56:08,184 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: c775a352-70ac-4a40-bb99-da230d14a406, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:56:08,184 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 16:56:08,185 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'can you pls plot 5 most playlist track time?', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': '87d27337-040a-4a6b-b075-41b3a2dcbe6f', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 16:56:08,185 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'can you pls plot 5 most playlist track time?'
2025-12-11 16:56:08,185 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: c775a352-70ac-4a40-bb99-da230d14a406, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'can you pls plot 5 most playlist track time?'
2025-12-11 16:56:08,189 - app.services.message_management_service - INFO - Generated message_id: 85719c67-526c-4ff2-83a3-69992f34248a for thread c775a352-70ac-4a40-bb99-da230d14a406
2025-12-11 16:56:08,189 - app.services.message_management_service - INFO - Saving user message 85719c67-526c-4ff2-83a3-69992f34248a to thread c775a352-70ac-4a40-bb99-da230d14a406 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:56:08,191 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 85719c67-526c-4ff2-83a3-69992f34248a
2025-12-11 16:56:08,193 - app.services.message_management_service - INFO - Successfully saved user message 85719c67-526c-4ff2-83a3-69992f34248a to thread c775a352-70ac-4a40-bb99-da230d14a406
2025-12-11 16:56:08,193 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread c775a352-70ac-4a40-bb99-da230d14a406, message_id: 85719c67-526c-4ff2-83a3-69992f34248a
2025-12-11 16:56:08,195 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: c775a352-70ac-4a40-bb99-da230d14a406, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:56:08,981 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:10,330 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:11,725 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:12,398 - app.agents.tools.data_analysis_tools - INFO - Executing SQL query: SELECT track_name, track_time FROM playlist_tracks ORDER BY track_time DESC LIMIT 5;
2025-12-11 16:56:12,400 - app.agents.tools.data_analysis_tools - ERROR - Error executing SQL query: (sqlite3.OperationalError) no such table: playlist_tracks
[SQL: SELECT track_name, track_time FROM playlist_tracks ORDER BY track_time DESC LIMIT 5;]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
2025-12-11 16:56:12,401 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='{"error": "Error executing SQL query: (sqlite3.OperationalError) no such table: playlist_tracks\\n[SQL: SELECT track_name, track_time FROM playlist_tracks ORDER BY track_time DESC LIMIT 5;]\\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}', name='sql_db_to_df', tool_call_id='call_tuJiPgfll2Uhulg1TtGXUon8')]}
2025-12-11 16:56:12,401 - app.agents.data_exploration_agent - INFO - sql_db_to_df raw output for tool_call_id=call_tuJiPgfll2Uhulg1TtGXUon8: {"error": "Error executing SQL query: (sqlite3.OperationalError) no such table: playlist_tracks\n[SQL: SELECT track_name, track_time FROM playlist_tracks ORDER BY track_time DESC LIMIT 5;]\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
2025-12-11 16:56:13,423 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:14,553 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:15,173 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content="[('albums',), ('sqlite_sequence',), ('artists',), ('customers',), ('employees',), ('genres',), ('invoices',), ('invoice_items',), ('media_types',), ('playlists',), ('playlist_track',), ('tracks',), ('sqlite_stat1',)]", name='sql_db_query', tool_call_id='call_6AB7MQcdUdG9wCtxv91xTmAL')]}
2025-12-11 16:56:16,092 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:16,933 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:17,537 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content="[(0, 'PlaylistId', 'INTEGER', 1, None, 1), (1, 'TrackId', 'INTEGER', 1, None, 2)]", name='sql_db_query', tool_call_id='call_MdvCR8T1RVZhw328noa8g2iy')]}
2025-12-11 16:56:18,663 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:22,185 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content="[('Occupation / Precipice', 5286953), ('Occupation / Precipice', 5286953), ('Through a Looking Glass', 5088838), ('Through a Looking Glass', 5088838), ('Greetings from Earth, Pt. 1', 2960293)]", name='sql_db_query', tool_call_id='call_XmQQC16iDsqJBjW8s3xUNJni')]}
2025-12-11 16:56:22,902 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:27,336 - app.agents.tools.data_analysis_tools - INFO - Executing SQL query: SELECT t.Name AS track_name, t.Milliseconds AS track_time FROM playlist_track pt JOIN tracks t ON pt.TrackId = t.TrackId ORDER BY t.Milliseconds DESC LIMIT 5;
2025-12-11 16:56:27,347 - app.services.redis_dataframe_service - INFO - Initialized RedisDataFrameService with TTL: 3600s
2025-12-11 16:56:27,353 - app.services.redis_dataframe_service - INFO - Stored DataFrame df:5c1655d4e8754f149135088b3a44be6b with shape (5, 2), expires at 2025-12-11 17:56:27.353222
2025-12-11 16:56:27,354 - app.agents.tools.data_analysis_tools - INFO - Successfully stored DataFrame df:5c1655d4e8754f149135088b3a44be6b with shape (5, 2)
2025-12-11 16:56:27,355 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='{"data_context": {"df_id": "df:5c1655d4e8754f149135088b3a44be6b", "sql_query": "SELECT t.Name AS track_name, t.Milliseconds AS track_time FROM playlist_track pt JOIN tracks t ON pt.TrackId = t.TrackId ORDER BY t.Milliseconds DESC LIMIT 5;", "columns": ["track_name", "track_time"], "shape": [5, 2], "created_at": "2025-12-11T16:56:27.353222", "expires_at": "2025-12-11T17:56:27.353222", "metadata": {}}, "description": "SQL query executed successfully and DataFrame stored in Redis with ID df:5c1655d4e8754f149135088b3a44be6b (5 rows \\u00d7 2 columns). Expires at 2025-12-11 17:56:27 UTC."}', name='sql_db_to_df', tool_call_id='call_4CBi5IRWfH4HW1tJIt7wMCFt')]}
2025-12-11 16:56:27,355 - app.agents.data_exploration_agent - INFO - sql_db_to_df raw output for tool_call_id=call_4CBi5IRWfH4HW1tJIt7wMCFt: {"data_context": {"df_id": "df:5c1655d4e8754f149135088b3a44be6b", "sql_query": "SELECT t.Name AS track_name, t.Milliseconds AS track_time FROM playlist_track pt JOIN tracks t ON pt.TrackId = t.TrackId ORDER BY t.Milliseconds DESC LIMIT 5;", "columns": ["track_name", "track_time"], "shape": [5, 2], "created_at": "2025-12-11T16:56:27.353222", "expires_at": "2025-12-11T17:56:27.353222", "metadata": {}}, "description": "SQL query executed successfully and DataFrame stored in Redis with ID df:5c1655d4e8754f149135088b3a44be6b (5 rows \u00d7 2 columns). Expires at 2025-12-11 17:56:27 UTC."}
2025-12-11 16:56:27,356 - app.agents.data_exploration_agent - INFO - Successfully updated data_context for tool_call_id=call_4CBi5IRWfH4HW1tJIt7wMCFt: df_id=df:5c1655d4e8754f149135088b3a44be6b
2025-12-11 16:56:28,644 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:30,732 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:32,062 - matplotlib.font_manager - INFO - generated new fontManager
2025-12-11 16:56:32,249 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content="Error: Required libraries not available: No module named 'app.services.supabase_storage_service'", name='large_plotting_tool', tool_call_id='call_WQeDwWxgOo7uaxHBVvLlVA25')]}
2025-12-11 16:56:32,918 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:35,247 - app.services.redis_dataframe_service - INFO - Retrieved DataFrame df:5c1655d4e8754f149135088b3a44be6b with shape (5, 2)
2025-12-11 16:56:35,248 - app.services.redis_dataframe_service - INFO - Extended TTL for DataFrame df:5c1655d4e8754f149135088b3a44be6b by 3600s
2025-12-11 16:56:35,249 - app.agents.tools.visualization_tools - INFO - Using DataFrame df:5c1655d4e8754f149135088b3a44be6b with shape (5, 2) for visualization
2025-12-11 16:56:35,762 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:36,933 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 16:56:41,329 - app.agents.tools.visualization_tools - INFO - Successfully transformed DataFrame df:5c1655d4e8754f149135088b3a44be6b into bar visualization
2025-12-11 16:56:41,331 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='{\n  "type": "bar",\n  "title": "Top 5 Longest Tracks",\n  "data": [\n    {\n      "track_name": "Occupation / Precipice",\n      "track_time": 5286953\n    },\n    {\n      "track_name": "Through a Looking Glass",\n      "track_time": 5088838\n    },\n    {\n      "track_name": "Greetings from Earth, Pt. 1",\n      "track_time": 2960293\n    }\n  ],\n  "config": {\n    "xAxis": {\n      "key": "track_name",\n      "label": "Track Name"\n    },\n    "yAxis": [\n      {\n        "key": "track_time",\n        "label": "Track Time (ms)",\n        "color": "#8884d8"\n      }\n    ],\n    "orientation": "vertical"\n  },\n  "metadata": {\n    "source": "smart_transform_for_viz",\n    "total_rows": 5,\n    "columns": [\n      "track_name",\n      "track_time"\n    ],\n    "reasoning": "Creating a bar chart for the top 5 longest tracks based on retrieved track time data.",\n    "df_id": "df:5c1655d4e8754f149135088b3a44be6b"\n  }\n}', name='smart_transform_for_viz', tool_call_id='call_Ilc6dUyrYrPhePsiwOcsQrFH')]}
2025-12-11 16:56:42,239 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 16:56:44,924 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: c775a352-70ac-4a40-bb99-da230d14a406, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 87d27337-040a-4a6b-b075-41b3a2dcbe6f, checkpoint_id: 1f0d6b25-fd99-60c7-8018-8a69b3177d91, content_blocks count: 10
2025-12-11 16:56:44,924 - app.services.message_management_service - INFO - Saving assistant message 87d27337-040a-4a6b-b075-41b3a2dcbe6f to thread c775a352-70ac-4a40-bb99-da230d14a406 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 16:56:44,930 - app.repositories.message_content_repository - INFO - Inserted 10 content blocks for message 87d27337-040a-4a6b-b075-41b3a2dcbe6f
2025-12-11 16:56:44,932 - app.services.message_management_service - INFO - Successfully saved assistant message 87d27337-040a-4a6b-b075-41b3a2dcbe6f to thread c775a352-70ac-4a40-bb99-da230d14a406
2025-12-11 16:56:44,932 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 125 (UUID: 87d27337-040a-4a6b-b075-41b3a2dcbe6f) in thread c775a352-70ac-4a40-bb99-da230d14a406
2025-12-11 16:57:19,827 - app.services.chat_thread_service - INFO - Deleting thread c775a352-70ac-4a40-bb99-da230d14a406 (delete_checkpoint=True)
2025-12-11 16:57:19,829 - app.services.chat_thread_service - INFO - Deleted chat thread: c775a352-70ac-4a40-bb99-da230d14a406 (messages and content blocks deleted via cascade)
2025-12-11 16:57:19,829 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 16:59:31,483 - server - INFO - Shutting down Agent Backend API...
2025-12-11 16:59:31,483 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 16:59:31,485 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 16:59:31,491 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 16:59:31,492 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 16:59:34,257 - server - INFO - Logging configuration complete
2025-12-11 16:59:34,257 - server - INFO - Starting up Agent Backend API...
2025-12-11 16:59:34,284 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:59:34,309 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 16:59:34,318 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 16:59:34,570 - app.agents.data_exploration_agent - INFO - Registered 6 tools:
2025-12-11 16:59:34,570 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 16:59:34,571 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 16:59:34,571 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 16:59:34,571 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 16:59:34,571 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 16:59:34,572 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 16:59:34,691 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 16:59:34,691 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 16:59:34,691 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 16:59:34,691 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 17:00:58,676 - server - INFO - Shutting down Agent Backend API...
2025-12-11 17:00:58,677 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 17:00:58,679 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 17:00:58,682 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 17:00:58,683 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 17:01:01,370 - server - INFO - Logging configuration complete
2025-12-11 17:01:01,371 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:01:01,389 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:01:01,414 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:01:01,424 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:01:01,703 - app.services.agent_service - ERROR - Failed to initialize agent service: "Text2SQLTool" object has no field "engine"
2025-12-11 17:02:11,271 - server - INFO - Logging configuration complete
2025-12-11 17:02:11,272 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:02:11,292 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:02:11,319 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:02:11,329 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:02:11,726 - app.services.agent_service - ERROR - Failed to initialize agent service: create_react_agent() got unexpected keyword arguments: {'state_modifier': "You are a SQL query generator expert.\n\nYour task is to generate ONLY the SQL query, nothing else.\n\nRULES:\n1. Use sql_db_list_tables to see available tables\n2. Use sql_db_schema to understand table structure\n3. Generate executable SQLite3 queries\n4. Return ONLY the SQL query as your final answer\n5. Do NOT execute the query - just generate it\n6. Use proper SQLite syntax and functions\n\nCOMMON PATTERNS:\n- Date filtering: strftime('%Y', date_column) = '2020'\n- Century calculation: (CAST(strftime('%Y', date_column) AS INTEGER) - 1) / 100 + 1\n- Current date: strftime('%Y-%m-%d', 'now')\n\nYour final answer must be ONLY the SQL query, no explanation."}
2025-12-11 17:02:14,277 - server - INFO - Logging configuration complete
2025-12-11 17:02:14,278 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:02:14,295 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:02:14,319 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:02:14,329 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:02:14,728 - app.services.agent_service - ERROR - Failed to initialize agent service: create_react_agent() got unexpected keyword arguments: {'state_modifier': "You are a SQL query generator expert.\n\nYour task is to generate ONLY the SQL query, nothing else.\n\nRULES:\n1. Use sql_db_list_tables to see available tables\n2. Use sql_db_schema to understand table structure\n3. Generate executable SQLite3 queries\n4. Return ONLY the SQL query as your final answer\n5. Do NOT execute the query - just generate it\n6. Use proper SQLite syntax and functions\n\nCOMMON PATTERNS:\n- Date filtering: strftime('%Y', date_column) = '2020'\n- Century calculation: (CAST(strftime('%Y', date_column) AS INTEGER) - 1) / 100 + 1\n- Current date: strftime('%Y-%m-%d', 'now')\n\nYour final answer must be ONLY the SQL query, no explanation."}
2025-12-11 17:04:43,633 - server - INFO - Logging configuration complete
2025-12-11 17:04:43,634 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:04:43,654 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:04:43,680 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:04:43,690 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:04:44,098 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 17:04:44,098 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 17:04:44,098 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 17:04:44,099 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 17:04:44,099 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 17:04:44,099 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 17:04:44,100 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 17:04:44,100 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 17:04:45,885 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 17:04:45,886 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 17:04:45,886 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 17:04:45,886 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 17:04:48,273 - server - INFO - Logging configuration complete
2025-12-11 17:04:48,273 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:04:48,293 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:04:48,317 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:04:48,327 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:04:48,739 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 17:04:48,739 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 17:04:48,740 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 17:04:48,740 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 17:04:48,740 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 17:04:48,741 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 17:04:48,741 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 17:04:48,741 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 17:04:48,839 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 17:04:48,839 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 17:04:48,840 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 17:04:48,840 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 17:05:51,543 - app.api.v1.endpoints.conversation - INFO - Restoring conversation 3cd7825f-8dd8-4f1e-9823-8233bbd12845
2025-12-11 17:05:55,758 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'can you pls plot 5 most playlist track time?' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:05:55,759 - app.services.chat_thread_service - INFO - Creating new chat thread: c764a260-0c20-477f-99b2-2a6ed3c6b350 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:05:55,762 - app.services.chat_thread_service - INFO - Created new chat thread: c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:05:55,765 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 17:05:55,765 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:05:55,845 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:05:55,846 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'can you pls plot 5 most playlist track time?', use_planning: False, use_explainer: False
2025-12-11 17:05:55,867 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:05:55,868 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 17:05:55,871 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:05:55,871 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 17:05:55,872 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'can you pls plot 5 most playlist track time?', 'use_planning': False, 'use_explainer': False, 'assistant_message_id': 'cae73dbe-2a10-4c4c-a10e-e2e227924e5d', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 17:05:55,872 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'can you pls plot 5 most playlist track time?'
2025-12-11 17:05:55,872 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'can you pls plot 5 most playlist track time?'
2025-12-11 17:05:55,876 - app.services.message_management_service - INFO - Generated message_id: e0a39bcb-cbbb-4b2d-ade0-7e7f1e7419a2 for thread c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:05:55,889 - app.services.message_management_service - INFO - Saving user message e0a39bcb-cbbb-4b2d-ade0-7e7f1e7419a2 to thread c764a260-0c20-477f-99b2-2a6ed3c6b350 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:05:55,897 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message e0a39bcb-cbbb-4b2d-ade0-7e7f1e7419a2
2025-12-11 17:05:55,899 - app.services.message_management_service - INFO - Successfully saved user message e0a39bcb-cbbb-4b2d-ade0-7e7f1e7419a2 to thread c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:05:55,905 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread c764a260-0c20-477f-99b2-2a6ed3c6b350, message_id: e0a39bcb-cbbb-4b2d-ade0-7e7f1e7419a2
2025-12-11 17:05:55,906 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:05:57,060 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:05:58,777 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:05:59,783 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:00,219 - app.agents.tools.text2sql_tool - INFO - Generating SQL for question: Select the top 5 playlists by number of tracks, along with the total track time for each playlist.
2025-12-11 17:06:02,098 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:04,694 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:06,243 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:07,786 - app.agents.tools.text2sql_tool - INFO - Generated SQL: SELECT p."Name", COUNT(pt."TrackId") AS track_count, SUM(t."Milliseconds") AS total_time
FROM playlists p
JOIN playlist_track pt ON p."PlaylistId" = pt."PlaylistId"
JOIN tracks t ON pt."TrackId" = t."TrackId"
GROUP BY p."PlaylistId"
ORDER BY track_count DESC
LIMIT 5;
2025-12-11 17:06:07,787 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='SELECT p."Name", COUNT(pt."TrackId") AS track_count, SUM(t."Milliseconds") AS total_time\nFROM playlists p\nJOIN playlist_track pt ON p."PlaylistId" = pt."PlaylistId"\nJOIN tracks t ON pt."TrackId" = t."TrackId"\nGROUP BY p."PlaylistId"\nORDER BY track_count DESC\nLIMIT 5;', name='text2SQL', tool_call_id='call_GDDHk9Y4lxv5Aysq8pfyp6Zg')]}
2025-12-11 17:06:09,290 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:12,567 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:13,591 - app.agents.tools.data_analysis_tools - INFO - Executing SQL query: SELECT p."Name", COUNT(pt."TrackId") AS track_count, SUM(t."Milliseconds") AS total_time
FROM playlists p
JOIN playlist_track pt ON p."PlaylistId" = pt."PlaylistId"
JOIN tracks t ON pt."TrackId" = t."TrackId"
GROUP BY p."PlaylistId"
ORDER BY track_count DESC
LIMIT 5;
2025-12-11 17:06:13,650 - app.services.redis_dataframe_service - INFO - Initialized RedisDataFrameService with TTL: 3600s
2025-12-11 17:06:13,653 - app.services.redis_dataframe_service - INFO - Stored DataFrame df:f51f89ab54224a86aae81b6f006e3e2d with shape (5, 3), expires at 2025-12-11 18:06:13.653322
2025-12-11 17:06:13,654 - app.agents.tools.data_analysis_tools - INFO - Successfully stored DataFrame df:f51f89ab54224a86aae81b6f006e3e2d with shape (5, 3)
2025-12-11 17:06:13,654 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='{"data_context": {"df_id": "df:f51f89ab54224a86aae81b6f006e3e2d", "sql_query": "SELECT p.\\"Name\\", COUNT(pt.\\"TrackId\\") AS track_count, SUM(t.\\"Milliseconds\\") AS total_time\\nFROM playlists p\\nJOIN playlist_track pt ON p.\\"PlaylistId\\" = pt.\\"PlaylistId\\"\\nJOIN tracks t ON pt.\\"TrackId\\" = t.\\"TrackId\\"\\nGROUP BY p.\\"PlaylistId\\"\\nORDER BY track_count DESC\\nLIMIT 5;", "columns": ["Name", "track_count", "total_time"], "shape": [5, 3], "created_at": "2025-12-11T17:06:13.653322", "expires_at": "2025-12-11T18:06:13.653322", "metadata": {}}, "description": "SQL query executed successfully and DataFrame stored in Redis with ID df:f51f89ab54224a86aae81b6f006e3e2d (5 rows \\u00d7 3 columns). Expires at 2025-12-11 18:06:13 UTC."}', name='sql_db_to_df', tool_call_id='call_XnJxl0gz2T8WBNaQPKT2DXM1')]}
2025-12-11 17:06:13,655 - app.agents.data_exploration_agent - INFO - sql_db_to_df raw output for tool_call_id=call_XnJxl0gz2T8WBNaQPKT2DXM1: {"data_context": {"df_id": "df:f51f89ab54224a86aae81b6f006e3e2d", "sql_query": "SELECT p.\"Name\", COUNT(pt.\"TrackId\") AS track_count, SUM(t.\"Milliseconds\") AS total_time\nFROM playlists p\nJOIN playlist_track pt ON p.\"PlaylistId\" = pt.\"PlaylistId\"\nJOIN tracks t ON pt.\"TrackId\" = t.\"TrackId\"\nGROUP BY p.\"PlaylistId\"\nORDER BY track_count DESC\nLIMIT 5;", "columns": ["Name", "track_count", "total_time"], "shape": [5, 3], "created_at": "2025-12-11T17:06:13.653322", "expires_at": "2025-12-11T18:06:13.653322", "metadata": {}}, "description": "SQL query executed successfully and DataFrame stored in Redis with ID df:f51f89ab54224a86aae81b6f006e3e2d (5 rows \u00d7 3 columns). Expires at 2025-12-11 18:06:13 UTC."}
2025-12-11 17:06:13,655 - app.agents.data_exploration_agent - INFO - Successfully updated data_context for tool_call_id=call_XnJxl0gz2T8WBNaQPKT2DXM1: df_id=df:f51f89ab54224a86aae81b6f006e3e2d
2025-12-11 17:06:15,500 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:17,314 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:18,370 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content="Error: Required libraries not available: No module named 'app.services.supabase_storage_service'", name='large_plotting_tool', tool_call_id='call_eeaIgYFgI6IewYd3Gkz0rUHf')]}
2025-12-11 17:06:19,989 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:23,104 - app.services.redis_dataframe_service - INFO - Retrieved DataFrame df:f51f89ab54224a86aae81b6f006e3e2d with shape (5, 3)
2025-12-11 17:06:23,105 - app.services.redis_dataframe_service - INFO - Extended TTL for DataFrame df:f51f89ab54224a86aae81b6f006e3e2d by 3600s
2025-12-11 17:06:23,106 - app.agents.tools.visualization_tools - INFO - Using DataFrame df:f51f89ab54224a86aae81b6f006e3e2d with shape (5, 3) for visualization
2025-12-11 17:06:23,700 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:27,752 - app.agents.tools.visualization_tools - INFO - Successfully transformed DataFrame df:f51f89ab54224a86aae81b6f006e3e2d into bar visualization
2025-12-11 17:06:27,753 - app.agents.data_exploration_agent - INFO - Tool node result: {'messages': [ToolMessage(content='{\n  "type": "bar",\n  "title": "Total Track Time of Top 5 Playlists",\n  "data": [\n    {\n      "Name": "Music",\n      "total_time": 877683083\n    },\n    {\n      "Name": "90\\u2019s Music",\n      "total_time": 398705153\n    },\n    {\n      "Name": "TV Shows",\n      "total_time": 501094957\n    }\n  ],\n  "config": {\n    "xAxis": {\n      "key": "Name",\n      "label": "Playlist Name"\n    },\n    "yAxis": [\n      {\n        "key": "total_time",\n        "label": "Total Time (in milliseconds)",\n        "color": "#8884d8"\n      }\n    ],\n    "orientation": "vertical"\n  },\n  "metadata": {\n    "source": "smart_transform_for_viz",\n    "total_rows": 5,\n    "columns": [\n      "Name",\n      "track_count",\n      "total_time"\n    ],\n    "reasoning": "Visualizing total track time of the top 5 playlists using an interactive bar chart.",\n    "df_id": "df:f51f89ab54224a86aae81b6f006e3e2d"\n  }\n}', name='smart_transform_for_viz', tool_call_id='call_c2yH2XozgOE26scxXOafIJqQ')]}
2025-12-11 17:06:29,984 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:06:33,017 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for completion with thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: cae73dbe-2a10-4c4c-a10e-e2e227924e5d, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11, content_blocks count: 7
2025-12-11 17:06:33,018 - app.services.message_management_service - INFO - Saving assistant message cae73dbe-2a10-4c4c-a10e-e2e227924e5d to thread c764a260-0c20-477f-99b2-2a6ed3c6b350 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:06:33,022 - app.repositories.message_content_repository - INFO - Inserted 7 content blocks for message cae73dbe-2a10-4c4c-a10e-e2e227924e5d
2025-12-11 17:06:33,024 - app.services.message_management_service - INFO - Successfully saved assistant message cae73dbe-2a10-4c4c-a10e-e2e227924e5d to thread c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:06:33,024 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant completion message 127 (UUID: cae73dbe-2a10-4c4c-a10e-e2e227924e5d) in thread c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:07:49,415 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 17:07:52,121 - app.services.chat_thread_service - INFO - Deleting thread 3cd7825f-8dd8-4f1e-9823-8233bbd12845 (delete_checkpoint=True)
2025-12-11 17:07:52,124 - app.services.chat_thread_service - INFO - Deleted chat thread: 3cd7825f-8dd8-4f1e-9823-8233bbd12845 (messages and content blocks deleted via cascade)
2025-12-11 17:07:52,124 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 17:07:56,231 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 17:07:58,517 - app.api.v1.endpoints.conversation - INFO - Restoring conversation c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:07:58,527 - app.api.v1.endpoints.conversation - ERROR - Error restoring conversation c764a260-0c20-477f-99b2-2a6ed3c6b350: 1 validation error for RestoreConversationData
data_context
  Input should be a valid dictionary or instance of DataContext [type=model_type, input_value=DataContext(df_id='df:f51...3, 653322), metadata={}), input_type=DataContext]
    For further information visit https://errors.pydantic.dev/2.11/v/model_type
2025-12-11 17:09:34,680 - server - INFO - Shutting down Agent Backend API...
2025-12-11 17:09:34,680 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 17:09:34,681 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 17:09:34,684 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 17:09:34,685 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 17:09:37,342 - server - INFO - Logging configuration complete
2025-12-11 17:09:37,342 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:09:37,362 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:09:37,389 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:09:37,400 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:09:37,787 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 17:09:37,787 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 17:09:37,788 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 17:09:37,788 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 17:09:37,788 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 17:09:37,789 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 17:09:37,789 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 17:09:37,789 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 17:09:37,875 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 17:09:37,875 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 17:09:37,875 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 17:09:37,875 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 17:09:53,910 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 17:09:55,618 - app.api.v1.endpoints.conversation - INFO - Restoring conversation c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:09:55,634 - app.api.v1.endpoints.conversation - ERROR - Error restoring conversation c764a260-0c20-477f-99b2-2a6ed3c6b350: 2 validation errors for RestoreConversationData
data_context.created_at
  Input should be a valid string [type=string_type, input_value=datetime.datetime(2025, 12, 11, 17, 6, 13, 653322), input_type=datetime]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
data_context.expires_at
  Input should be a valid string [type=string_type, input_value=datetime.datetime(2025, 12, 11, 18, 6, 13, 653322), input_type=datetime]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-12-11 17:10:20,778 - server - INFO - Shutting down Agent Backend API...
2025-12-11 17:10:20,779 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 17:10:20,780 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 17:10:20,783 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 17:10:20,783 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 17:10:23,347 - server - INFO - Logging configuration complete
2025-12-11 17:10:23,347 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:10:23,366 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:10:23,396 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:10:23,407 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:10:23,795 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 17:10:23,795 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 17:10:23,796 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 17:10:23,796 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 17:10:23,796 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 17:10:23,796 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 17:10:23,797 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 17:10:23,797 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 17:10:23,900 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 17:10:23,900 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 17:10:23,900 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 17:10:23,901 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 17:10:42,122 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 17:10:43,457 - app.api.v1.endpoints.conversation - INFO - Restoring conversation c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:10:43,551 - app.services.redis_dataframe_service - INFO - Initialized RedisDataFrameService with TTL: 3600s
2025-12-11 17:10:43,551 - app.api.v1.endpoints.data - INFO - Fetching preview for DataFrame: df:f51f89ab54224a86aae81b6f006e3e2d
2025-12-11 17:10:43,553 - app.services.redis_dataframe_service - INFO - Retrieved DataFrame df:f51f89ab54224a86aae81b6f006e3e2d with shape (5, 3)
2025-12-11 17:10:46,519 - app.api.v1.endpoints.graph - INFO - Fetching visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:46,519 - app.services.agent_service - INFO - Getting visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:46,532 - app.services.agent_service - INFO - Successfully retrieved 1 visualizations from checkpoint 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:47,432 - app.api.v1.endpoints.graph - INFO - Fetching visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:47,432 - app.services.agent_service - INFO - Getting visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:47,434 - app.services.agent_service - INFO - Successfully retrieved 1 visualizations from checkpoint 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:49,199 - app.api.v1.endpoints.graph - INFO - Fetching explorer data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:49,199 - app.services.agent_service - INFO - Getting explorer data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:10:49,202 - app.services.agent_service - INFO - Successfully built explorer data with 4 steps
2025-12-11 17:27:40,106 - app.api.v1.endpoints.graph - INFO - Fetching visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:27:40,107 - app.services.agent_service - INFO - Getting visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:27:40,110 - app.services.agent_service - INFO - Successfully retrieved 1 visualizations from checkpoint 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:32:04,105 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 17:32:47,394 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 17:32:51,131 - app.api.v1.endpoints.conversation - INFO - Restoring conversation c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:32:51,232 - app.api.v1.endpoints.data - INFO - Fetching preview for DataFrame: df:f51f89ab54224a86aae81b6f006e3e2d
2025-12-11 17:32:51,233 - app.services.redis_dataframe_service - INFO - Retrieved DataFrame df:f51f89ab54224a86aae81b6f006e3e2d with shape (5, 3)
2025-12-11 17:32:54,944 - app.api.v1.endpoints.graph - INFO - Fetching visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:32:54,944 - app.services.agent_service - INFO - Getting visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:32:54,947 - app.services.agent_service - INFO - Successfully retrieved 1 visualizations from checkpoint 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:35:14,952 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 17:35:18,750 - app.api.v1.endpoints.conversation - INFO - Restoring conversation c764a260-0c20-477f-99b2-2a6ed3c6b350
2025-12-11 17:35:18,839 - app.api.v1.endpoints.data - INFO - Fetching preview for DataFrame: df:f51f89ab54224a86aae81b6f006e3e2d
2025-12-11 17:35:18,840 - app.services.redis_dataframe_service - INFO - Retrieved DataFrame df:f51f89ab54224a86aae81b6f006e3e2d with shape (5, 3)
2025-12-11 17:35:21,124 - app.api.v1.endpoints.graph - INFO - Fetching visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:35:21,125 - app.services.agent_service - INFO - Getting visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:35:21,128 - app.services.agent_service - INFO - Successfully retrieved 1 visualizations from checkpoint 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:35:59,660 - app.api.v1.endpoints.graph - INFO - Fetching visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:35:59,660 - app.services.agent_service - INFO - Getting visualization data for thread_id: c764a260-0c20-477f-99b2-2a6ed3c6b350, checkpoint_id: 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:35:59,663 - app.services.agent_service - INFO - Successfully retrieved 1 visualizations from checkpoint 1f0d6b3b-e621-62a4-800f-18b8f4701a11
2025-12-11 17:36:29,567 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'the total track time of the top 5 playlists' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:36:29,568 - app.services.chat_thread_service - INFO - Creating new chat thread: efa558ae-7472-4f0a-ac41-a69ff6372726 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:36:29,572 - app.services.chat_thread_service - INFO - Created new chat thread: efa558ae-7472-4f0a-ac41-a69ff6372726
2025-12-11 17:36:29,574 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 17:36:29,574 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: efa558ae-7472-4f0a-ac41-a69ff6372726
2025-12-11 17:36:29,658 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: efa558ae-7472-4f0a-ac41-a69ff6372726, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:36:29,658 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'the total track time of the top 5 playlists', use_planning: True, use_explainer: False
2025-12-11 17:36:29,678 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: efa558ae-7472-4f0a-ac41-a69ff6372726
2025-12-11 17:36:29,678 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 17:36:29,678 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: efa558ae-7472-4f0a-ac41-a69ff6372726, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:36:29,679 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 17:36:29,679 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'the total track time of the top 5 playlists', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '78d76d02-f067-4bd1-b332-a582ac7d695c', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 17:36:29,679 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'the total track time of the top 5 playlists'
2025-12-11 17:36:29,680 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: efa558ae-7472-4f0a-ac41-a69ff6372726, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'the total track time of the top 5 playlists'
2025-12-11 17:36:29,683 - app.services.message_management_service - INFO - Generated message_id: ff2ffd4d-03be-4cd1-8841-16f4eb19a9ab for thread efa558ae-7472-4f0a-ac41-a69ff6372726
2025-12-11 17:36:29,683 - app.services.message_management_service - INFO - Saving user message ff2ffd4d-03be-4cd1-8841-16f4eb19a9ab to thread efa558ae-7472-4f0a-ac41-a69ff6372726 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:36:29,689 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message ff2ffd4d-03be-4cd1-8841-16f4eb19a9ab
2025-12-11 17:36:29,690 - app.services.message_management_service - INFO - Successfully saved user message ff2ffd4d-03be-4cd1-8841-16f4eb19a9ab to thread efa558ae-7472-4f0a-ac41-a69ff6372726
2025-12-11 17:36:29,690 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread efa558ae-7472-4f0a-ac41-a69ff6372726, message_id: ff2ffd4d-03be-4cd1-8841-16f4eb19a9ab
2025-12-11 17:36:29,691 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: efa558ae-7472-4f0a-ac41-a69ff6372726, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:36:33,791 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:36:34,900 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 17:36:36,220 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: efa558ae-7472-4f0a-ac41-a69ff6372726, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 78d76d02-f067-4bd1-b332-a582ac7d695c, checkpoint_id: 1f0d6b7f-12cf-6388-8003-828553b0f40a, content_blocks count: 1
2025-12-11 17:36:36,220 - app.services.message_management_service - INFO - Saving assistant message 78d76d02-f067-4bd1-b332-a582ac7d695c to thread efa558ae-7472-4f0a-ac41-a69ff6372726 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 17:36:36,223 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 78d76d02-f067-4bd1-b332-a582ac7d695c
2025-12-11 17:36:36,224 - app.services.message_management_service - INFO - Successfully saved assistant message 78d76d02-f067-4bd1-b332-a582ac7d695c to thread efa558ae-7472-4f0a-ac41-a69ff6372726
2025-12-11 17:36:36,225 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 129 (UUID: 78d76d02-f067-4bd1-b332-a582ac7d695c) for approval in thread efa558ae-7472-4f0a-ac41-a69ff6372726
2025-12-11 17:38:51,917 - server - INFO - Shutting down Agent Backend API...
2025-12-11 17:38:51,917 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 17:38:51,918 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 17:38:51,921 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 17:38:51,922 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 17:38:55,549 - server - INFO - Logging configuration complete
2025-12-11 17:38:55,549 - server - INFO - Starting up Agent Backend API...
2025-12-11 17:38:55,577 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:38:55,599 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 17:38:55,608 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 17:38:56,078 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 17:38:56,078 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 17:38:56,079 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 17:38:56,079 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 17:38:56,079 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 17:38:56,080 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 17:38:56,080 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 17:38:56,080 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 17:38:56,196 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 17:38:56,196 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 17:38:56,197 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 17:38:56,197 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 18:01:06,334 - server - INFO - Shutting down Agent Backend API...
2025-12-11 18:01:06,334 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 18:01:06,336 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 18:01:06,339 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 18:01:06,339 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 18:01:09,932 - server - INFO - Logging configuration complete
2025-12-11 18:01:09,933 - server - INFO - Starting up Agent Backend API...
2025-12-11 18:01:09,963 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:01:09,987 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:01:09,998 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 18:01:10,483 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 18:01:10,483 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 18:01:10,483 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 18:01:10,483 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 18:01:10,484 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 18:01:10,484 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 18:01:10,484 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 18:01:10,485 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 18:01:10,622 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 18:01:10,623 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 18:01:10,623 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 18:01:10,623 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 18:01:59,036 - server - INFO - Shutting down Agent Backend API...
2025-12-11 18:01:59,037 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 18:01:59,038 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 18:01:59,051 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 18:01:59,052 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 18:02:02,651 - server - INFO - Logging configuration complete
2025-12-11 18:02:02,652 - server - INFO - Starting up Agent Backend API...
2025-12-11 18:02:02,681 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:02:02,703 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:02:02,713 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 18:02:03,170 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 18:02:03,170 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 18:02:03,170 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 18:02:03,171 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 18:02:03,171 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 18:02:03,171 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 18:02:03,172 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 18:02:03,172 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 18:02:03,266 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 18:02:03,266 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 18:02:03,267 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 18:02:03,267 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 18:03:18,131 - server - INFO - Shutting down Agent Backend API...
2025-12-11 18:03:18,132 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 18:03:18,133 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 18:03:18,136 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 18:03:18,136 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 18:03:21,982 - server - INFO - Logging configuration complete
2025-12-11 18:03:21,982 - server - INFO - Starting up Agent Backend API...
2025-12-11 18:03:22,012 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:03:22,035 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:03:22,045 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 18:03:22,548 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 18:03:22,548 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 18:03:22,548 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 18:03:22,548 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 18:03:22,549 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 18:03:22,549 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 18:03:22,549 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 18:03:22,550 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 18:03:22,645 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 18:03:22,645 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 18:03:22,645 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 18:03:22,646 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 18:03:24,085 - app.repositories.message_content_repository - INFO - Updated block text_run--329e52f7-644a-4de6-ba36-b1a22b4527bb with fields: ['needs_approval', 'message_status']
2025-12-11 18:03:24,085 - app.services.message_management_service - INFO - Updated block text_run--329e52f7-644a-4de6-ba36-b1a22b4527bb status in message 78d76d02-f067-4bd1-b332-a582ac7d695c: {'needsApproval': False, 'messageStatus': <MessageStatus.REJECTED: 'rejected'>}
2025-12-11 18:03:28,218 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 18:03:31,041 - app.services.chat_thread_service - INFO - Deleting thread c764a260-0c20-477f-99b2-2a6ed3c6b350 (delete_checkpoint=True)
2025-12-11 18:03:31,044 - app.services.chat_thread_service - INFO - Deleted chat thread: c764a260-0c20-477f-99b2-2a6ed3c6b350 (messages and content blocks deleted via cascade)
2025-12-11 18:03:31,044 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 18:03:36,990 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 18:03:39,362 - app.services.chat_thread_service - INFO - Deleting thread efa558ae-7472-4f0a-ac41-a69ff6372726 (delete_checkpoint=True)
2025-12-11 18:03:39,363 - app.services.chat_thread_service - INFO - Deleted chat thread: efa558ae-7472-4f0a-ac41-a69ff6372726 (messages and content blocks deleted via cascade)
2025-12-11 18:03:39,364 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 18:03:44,505 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'the total track time of the top 5 playlists' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:03:44,505 - app.services.chat_thread_service - INFO - Creating new chat thread: c7a5635e-f059-4f5a-b2c5-e333083ba4fb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:03:44,508 - app.services.chat_thread_service - INFO - Created new chat thread: c7a5635e-f059-4f5a-b2c5-e333083ba4fb
2025-12-11 18:03:44,510 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 18:03:44,511 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: c7a5635e-f059-4f5a-b2c5-e333083ba4fb
2025-12-11 18:03:44,589 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: c7a5635e-f059-4f5a-b2c5-e333083ba4fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:03:44,589 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'the total track time of the top 5 playlists', use_planning: True, use_explainer: False
2025-12-11 18:03:44,610 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: c7a5635e-f059-4f5a-b2c5-e333083ba4fb
2025-12-11 18:03:44,611 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 18:03:44,611 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: c7a5635e-f059-4f5a-b2c5-e333083ba4fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:03:44,611 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 18:03:44,612 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'the total track time of the top 5 playlists', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '4d9e9c63-4402-425d-a447-58439d992b66', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 18:03:44,612 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'the total track time of the top 5 playlists'
2025-12-11 18:03:44,612 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: c7a5635e-f059-4f5a-b2c5-e333083ba4fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'the total track time of the top 5 playlists'
2025-12-11 18:03:44,615 - app.services.message_management_service - INFO - Generated message_id: 69d8aeff-0327-47b8-b10f-309b2320e447 for thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb
2025-12-11 18:03:44,615 - app.services.message_management_service - INFO - Saving user message 69d8aeff-0327-47b8-b10f-309b2320e447 to thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:03:44,620 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 69d8aeff-0327-47b8-b10f-309b2320e447
2025-12-11 18:03:44,621 - app.services.message_management_service - INFO - Successfully saved user message 69d8aeff-0327-47b8-b10f-309b2320e447 to thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb
2025-12-11 18:03:44,621 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb, message_id: 69d8aeff-0327-47b8-b10f-309b2320e447
2025-12-11 18:03:44,622 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: c7a5635e-f059-4f5a-b2c5-e333083ba4fb, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:03:45,983 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:03:47,643 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:03:51,223 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: c7a5635e-f059-4f5a-b2c5-e333083ba4fb, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 4d9e9c63-4402-425d-a447-58439d992b66, checkpoint_id: 1f0d6bbb-fb71-66eb-8003-1273c5b9453c, content_blocks count: 1
2025-12-11 18:03:51,223 - app.services.message_management_service - INFO - Saving assistant message 4d9e9c63-4402-425d-a447-58439d992b66 to thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:03:51,226 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 4d9e9c63-4402-425d-a447-58439d992b66
2025-12-11 18:03:51,228 - app.services.message_management_service - INFO - Successfully saved assistant message 4d9e9c63-4402-425d-a447-58439d992b66 to thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb
2025-12-11 18:03:51,228 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 131 (UUID: 4d9e9c63-4402-425d-a447-58439d992b66) for approval in thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb
2025-12-11 18:08:01,466 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 18:08:05,161 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 18:08:08,013 - app.services.chat_thread_service - INFO - Deleting thread c7a5635e-f059-4f5a-b2c5-e333083ba4fb (delete_checkpoint=True)
2025-12-11 18:08:08,016 - app.services.chat_thread_service - INFO - Deleted chat thread: c7a5635e-f059-4f5a-b2c5-e333083ba4fb (messages and content blocks deleted via cascade)
2025-12-11 18:08:08,016 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 18:08:14,081 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'the total track time of the top 5 playlists' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:08:14,081 - app.services.chat_thread_service - INFO - Creating new chat thread: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:08:14,083 - app.services.chat_thread_service - INFO - Created new chat thread: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97
2025-12-11 18:08:14,085 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 18:08:14,085 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97
2025-12-11 18:08:14,153 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:08:14,153 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'the total track time of the top 5 playlists', use_planning: True, use_explainer: False
2025-12-11 18:08:14,158 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97
2025-12-11 18:08:14,159 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 18:08:14,159 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:08:14,159 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 18:08:14,160 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'the total track time of the top 5 playlists', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': 'a1a1eb7a-d8f8-424a-9e63-8bb1716bde89', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 18:08:14,160 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'the total track time of the top 5 playlists'
2025-12-11 18:08:14,160 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'the total track time of the top 5 playlists'
2025-12-11 18:08:14,163 - app.services.message_management_service - INFO - Generated message_id: c3ae696c-dcfa-4017-804f-7ff5cfb39330 for thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97
2025-12-11 18:08:14,163 - app.services.message_management_service - INFO - Saving user message c3ae696c-dcfa-4017-804f-7ff5cfb39330 to thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:08:14,166 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message c3ae696c-dcfa-4017-804f-7ff5cfb39330
2025-12-11 18:08:14,167 - app.services.message_management_service - INFO - Successfully saved user message c3ae696c-dcfa-4017-804f-7ff5cfb39330 to thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97
2025-12-11 18:08:14,167 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97, message_id: c3ae696c-dcfa-4017-804f-7ff5cfb39330
2025-12-11 18:08:14,168 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:08:15,327 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:08:16,738 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:08:22,689 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: a1a1eb7a-d8f8-424a-9e63-8bb1716bde89, checkpoint_id: 1f0d6bc6-1852-69e9-8003-549a89272af1, content_blocks count: 1
2025-12-11 18:08:22,689 - app.services.message_management_service - INFO - Saving assistant message a1a1eb7a-d8f8-424a-9e63-8bb1716bde89 to thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:08:22,691 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a1a1eb7a-d8f8-424a-9e63-8bb1716bde89
2025-12-11 18:08:22,693 - app.services.message_management_service - INFO - Successfully saved assistant message a1a1eb7a-d8f8-424a-9e63-8bb1716bde89 to thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97
2025-12-11 18:08:22,693 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 133 (UUID: a1a1eb7a-d8f8-424a-9e63-8bb1716bde89) for approval in thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97
2025-12-11 18:10:45,965 - server - INFO - Shutting down Agent Backend API...
2025-12-11 18:10:45,966 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 18:10:45,967 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 18:10:45,971 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 18:10:45,971 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 18:10:49,598 - server - INFO - Logging configuration complete
2025-12-11 18:10:49,598 - server - INFO - Starting up Agent Backend API...
2025-12-11 18:10:49,627 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:10:49,648 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:10:49,657 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 18:10:50,151 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 18:10:50,151 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 18:10:50,151 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 18:10:50,152 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 18:10:50,152 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 18:10:50,152 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 18:10:50,153 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 18:10:50,153 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 18:10:50,261 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 18:10:50,261 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 18:10:50,262 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 18:10:50,262 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 18:11:36,363 - server - INFO - Shutting down Agent Backend API...
2025-12-11 18:11:36,364 - app.services.agent_service - INFO - Agent service shutdown completed
2025-12-11 18:11:36,365 - app.core.database - INFO - psycopg connection pool closed
2025-12-11 18:11:36,368 - app.core.database - INFO - SQLAlchemy async engine disposed
2025-12-11 18:11:36,368 - app.core.database - INFO - SQLAlchemy sync engine disposed
2025-12-11 18:11:39,258 - server - INFO - Logging configuration complete
2025-12-11 18:11:39,259 - server - INFO - Starting up Agent Backend API...
2025-12-11 18:11:39,278 - app.core.database - INFO - ✅ Connected to PostgreSQL (psycopg): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:11:39,303 - app.core.database - INFO - ✅ Connected to PostgreSQL (SQLAlchemy async): PostgreSQL 15.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 15.2.0) 15.2.0, 64-bit
2025-12-11 18:11:39,313 - app.core.checkpointer - INFO - ✅ LangGraph checkpointer tables created/verified
2025-12-11 18:11:39,728 - app.agents.data_exploration_agent - INFO - Registered 7 tools:
2025-12-11 18:11:39,728 - app.agents.data_exploration_agent - INFO -   - sql_db_query: Input to this tool is a detailed and correct SQL query, output is a result from the database. If the...
2025-12-11 18:11:39,728 - app.agents.data_exploration_agent - INFO -   - smart_transform_for_viz: ONLY use when user explicitly requests a chart, graph, or visualization.
    Transforms DataFrame da...
2025-12-11 18:11:39,728 - app.agents.data_exploration_agent - INFO -   - python_repl: Execute Python code securely in an isolated subprocess with pandas DataFrame access.
    
    The Da...
2025-12-11 18:11:39,729 - app.agents.data_exploration_agent - INFO -   - dataframe_info: Get information about the current DataFrame stored in Redis.
    
    Use this tool to:
    - Check ...
2025-12-11 18:11:39,729 - app.agents.data_exploration_agent - INFO -   - sql_db_to_df: Execute SQL queries and store results as DataFrames in Redis for analysis.
    
    Use this tool to...
2025-12-11 18:11:39,729 - app.agents.data_exploration_agent - INFO -   - large_plotting_tool: Generate high-quality matplotlib plots using the current DataFrame from Redis.
    
    Use this too...
2025-12-11 18:11:39,729 - app.agents.data_exploration_agent - INFO -   - text2SQL: Generate SQL queries from natural language questions.
    
    Use this tool to convert questions in...
2025-12-11 18:11:39,822 - app.agents.data_exploration_agent - INFO - Graph visualization saved to: /app/logs/agent_graph.png
2025-12-11 18:11:39,823 - app.services.agent_service - INFO - Agent service initialized successfully
2025-12-11 18:11:39,823 - server - INFO - ✅ Agent service initialized with DB: app/resource/chinook.db
2025-12-11 18:11:39,823 - server - INFO - ✅ Using LLM provider: openai
2025-12-11 18:11:43,044 - app.api.v1.endpoints.conversation - INFO - Retrieving conversations
2025-12-11 18:11:46,645 - app.services.chat_thread_service - INFO - Deleting thread ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97 (delete_checkpoint=True)
2025-12-11 18:11:46,648 - app.services.chat_thread_service - INFO - Deleted chat thread: ab1ba7bb-eb1b-4b96-b428-a7e27ebf9b97 (messages and content blocks deleted via cascade)
2025-12-11 18:11:46,648 - app.services.chat_thread_service - WARNING - AgentService not initialized, skipping checkpoint deletion
2025-12-11 18:11:58,223 - app.api.v1.endpoints.conversation - INFO - Creating conversation with title: 'the total track time of the top 5 playlists' for user: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:11:58,223 - app.services.chat_thread_service - INFO - Creating new chat thread: 7844b79f-38a1-4d06-924e-300e7bb1ce10 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:11:58,226 - app.services.chat_thread_service - INFO - Created new chat thread: 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:11:58,229 - app.services.chat_thread_service - INFO - Thread verification - exists: True
2025-12-11 18:11:58,230 - app.api.v1.endpoints.conversation - INFO - Thread created successfully: 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:11:58,311 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /start - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:11:58,311 - app.api.v1.endpoints.streaming_graph - INFO - Start request - human_request: 'the total track time of the top 5 playlists', use_planning: True, use_explainer: False
2025-12-11 18:11:58,335 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:11:58,335 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 18:11:58,336 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:11:58,336 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 18:11:58,336 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'start', 'human_request': 'the total track time of the top 5 playlists', 'use_planning': True, 'use_explainer': False, 'assistant_message_id': '850d623e-a065-4e1f-a4ae-bfa7bc9a42a7', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 18:11:58,337 - app.api.v1.endpoints.streaming_graph - INFO - Attempting to save user message - message_service: True, human_request: 'the total track time of the top 5 playlists'
2025-12-11 18:11:58,337 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_user_message with thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, content: 'the total track time of the top 5 playlists'
2025-12-11 18:11:58,340 - app.services.message_management_service - INFO - Generated message_id: a5883ca4-3e4a-47a4-ae15-974af55a2332 for thread 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:11:58,340 - app.services.message_management_service - INFO - Saving user message a5883ca4-3e4a-47a4-ae15-974af55a2332 to thread 7844b79f-38a1-4d06-924e-300e7bb1ce10 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:11:58,344 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message a5883ca4-3e4a-47a4-ae15-974af55a2332
2025-12-11 18:11:58,345 - app.services.message_management_service - INFO - Successfully saved user message a5883ca4-3e4a-47a4-ae15-974af55a2332 to thread 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:11:58,346 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved user message for thread 7844b79f-38a1-4d06-924e-300e7bb1ce10, message_id: a5883ca4-3e4a-47a4-ae15-974af55a2332
2025-12-11 18:11:58,346 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:11:59,570 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:00,608 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:04,941 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 850d623e-a065-4e1f-a4ae-bfa7bc9a42a7, checkpoint_id: 1f0d6bce-5fe1-6972-8003-4b23243b5d9a, content_blocks count: 1
2025-12-11 18:12:04,941 - app.services.message_management_service - INFO - Saving assistant message 850d623e-a065-4e1f-a4ae-bfa7bc9a42a7 to thread 7844b79f-38a1-4d06-924e-300e7bb1ce10 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:12:04,943 - app.repositories.message_content_repository - INFO - Inserted 1 content blocks for message 850d623e-a065-4e1f-a4ae-bfa7bc9a42a7
2025-12-11 18:12:04,944 - app.services.message_management_service - INFO - Successfully saved assistant message 850d623e-a065-4e1f-a4ae-bfa7bc9a42a7 to thread 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:12:04,945 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 135 (UUID: 850d623e-a065-4e1f-a4ae-bfa7bc9a42a7) for approval in thread 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:12:18,892 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph /resume - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:12:18,903 - app.api.v1.endpoints.streaming_graph - INFO - Stream graph endpoint called - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:12:18,903 - app.api.v1.endpoints.streaming_graph - INFO - Dependencies injected - agent_service: True, message_service: True
2025-12-11 18:12:18,904 - app.api.v1.endpoints.streaming_graph - INFO - Streaming graph execution - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:12:18,904 - app.api.v1.endpoints.streaming_graph - INFO - Message service availability: True
2025-12-11 18:12:18,904 - app.api.v1.endpoints.streaming_graph - INFO - Run data: {'type': 'resume', 'review_action': <ApprovalStatus.APPROVED: 'approved'>, 'human_comment': None, 'assistant_message_id': '17ce89dd-95af-40ac-866f-39cdb7f2c97d', 'user_id': '9c306950-71da-4d00-bcc0-931b1a6c110e'}
2025-12-11 18:12:18,904 - app.api.v1.endpoints.streaming_graph - INFO - Feedback debug - message_service: True, human_comment: 'None'
2025-12-11 18:12:18,905 - app.api.v1.endpoints.streaming_graph - WARNING - Skipping feedback save - message_service: True, human_comment: 'None'
2025-12-11 18:12:18,912 - app.api.v1.endpoints.streaming_graph - INFO - Starting stream event_generator - thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id in config: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:12:19,369 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:19,544 - app.repositories.message_content_repository - INFO - Updated block text_run--66e75651-07d6-495d-8432-5ce674ad734b with fields: ['needs_approval', 'message_status']
2025-12-11 18:12:19,544 - app.services.message_management_service - INFO - Updated block text_run--66e75651-07d6-495d-8432-5ce674ad734b status in message 850d623e-a065-4e1f-a4ae-bfa7bc9a42a7: {'needsApproval': False, 'messageStatus': <MessageStatus.APPROVED: 'approved'>}
2025-12-11 18:12:19,809 - app.agents.nodes.task_parser_node - INFO - Generated args for text2SQL: {'question': 'What is the total track time of the top 5 playlists?', 'context': ''}
2025-12-11 18:12:20,829 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:20,948 - app.agents.nodes.task_parser_node - INFO - Task 2 dependencies: [1]
2025-12-11 18:12:21,373 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:22,459 - app.agents.nodes.task_parser_node - INFO - Generated args for sql_db_to_df: {'sql_query': 'SELECT playlist_name, SUM(track_time) as total_time FROM playlist_tracks GROUP BY playlist_name ORDER BY total_time DESC LIMIT 5;', 'description': 'Gather data concerning the total track times of the top 5 playlists.'}
2025-12-11 18:12:23,175 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:23,257 - app.agents.nodes.task_parser_node - INFO - Task 3 dependencies: [2]
2025-12-11 18:12:23,817 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:24,045 - app.agents.nodes.task_parser_node - INFO - Generated args for python_repl: {'code': "print(df['track_time'].sum())"}
2025-12-11 18:12:24,046 - app.agents.nodes.task_parser_node - INFO - Parsed 3 tasks from plan
2025-12-11 18:12:24,047 - app.agents.nodes.task_scheduler_node - INFO - Dependency levels: {1: 0, 2: 1, 3: 2}
2025-12-11 18:12:24,047 - app.agents.nodes.task_scheduler_node - INFO - Executing 1 independent tasks in parallel
2025-12-11 18:12:24,050 - app.agents.tools.text2sql_tool - INFO - Generating SQL for question: What is the total track time of the top 5 playlists?
2025-12-11 18:12:24,623 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:26,931 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:27,863 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:29,303 - app.agents.tools.text2sql_tool - INFO - Generated SQL: SELECT SUM(t.Milliseconds) AS TotalTrackTime
FROM playlists p
JOIN playlist_track pt ON p.PlaylistId = pt.PlaylistId
JOIN tracks t ON pt.TrackId = t.TrackId
GROUP BY p.PlaylistId
ORDER BY TotalTrackTime DESC
LIMIT 5;
2025-12-11 18:12:29,303 - app.agents.nodes.task_executor_node - INFO - Task 2 (sql_db_to_df) is now executable
2025-12-11 18:12:29,304 - app.agents.data_exploration_agent - INFO - No more tasks, going to joiner
2025-12-11 18:12:29,897 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-12-11 18:12:33,313 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 400 Bad Request"
2025-12-11 18:12:33,320 - app.agents.nodes.planner_node - ERROR - Error in initial planning: Error code: 400 - {'error': {'message': "Invalid parameter: messages with role 'tool' must be a response to a preceeding message with 'tool_calls'.", 'type': 'invalid_request_error', 'param': 'messages.[7].role', 'code': None}}
2025-12-11 18:12:33,328 - app.api.v1.endpoints.streaming_graph - INFO - Calling save_assistant_message for approval with thread_id: 7844b79f-38a1-4d06-924e-300e7bb1ce10, user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e, message_id: 17ce89dd-95af-40ac-866f-39cdb7f2c97d, checkpoint_id: 1f0d6bcf-6ea1-6d1d-8009-f323117ede1d, content_blocks count: 3
2025-12-11 18:12:33,328 - app.services.message_management_service - INFO - Saving assistant message 17ce89dd-95af-40ac-866f-39cdb7f2c97d to thread 7844b79f-38a1-4d06-924e-300e7bb1ce10 with user_id: 9c306950-71da-4d00-bcc0-931b1a6c110e
2025-12-11 18:12:33,332 - app.repositories.message_content_repository - INFO - Inserted 3 content blocks for message 17ce89dd-95af-40ac-866f-39cdb7f2c97d
2025-12-11 18:12:33,333 - app.services.message_management_service - INFO - Successfully saved assistant message 17ce89dd-95af-40ac-866f-39cdb7f2c97d to thread 7844b79f-38a1-4d06-924e-300e7bb1ce10
2025-12-11 18:12:33,333 - app.api.v1.endpoints.streaming_graph - INFO - Successfully saved assistant message 136 (UUID: 17ce89dd-95af-40ac-866f-39cdb7f2c97d) for approval in thread 7844b79f-38a1-4d06-924e-300e7bb1ce10
